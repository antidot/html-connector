/*
			BSD-style license
 @author			nwhite - < nw [at] nwhite.net >
 @infos			http://www.nwhite.net/MooCrop/
 @copyright		Author

 @modifiedby    Dave, July 2008
 File: module-all.js */
(window.webpackJsonp=window.webpackJsonp||[]).push([[175,262],{1757:function(l,f,h){h(245);h(246);h(247);h(249);h(250);h(252);h(253);h(254);h(255);h(256);h(257);h(258);h(259);h(260);h(261);h(262);h(263);h(1758);h(1759);h(1760);h(1761);h(1762);h(1763);h(1764);h(1765);h(1766);h(1767);h(1768);h(1769);h(1770);h(1771);h(1772);h(1773);h(1774);h(1775);h(1776);h(487);h(1777);h(1778)},1758:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});FrameModules.add("WikiImageFrameModule",function(){when($("pageImages"),
function(b){c.initialize();["wikiSummaryImage","wikiBannerImageContainer"].each(function(a){(a=$(a))&&MediaTarget.createFromElement(a).addEvent("itemChanged",function(a,b){a&&c.addImage(a,b)})})})});var c=f.WikiImageManager=window.WikiImageManager={initialize:function(){var b,a=this;this.thumbsContainer=$("pageImages");this.imageMeta=$$(".imageMeta");(b=$("wikiid").get("text"))&&(new Request.AjaxIO("getWikiImages",{onSuccess:function(b){b.map(function(b){b=MediaItem.createFromData(b);a.addImage(b)})}})).send(b)},
addImage:function(b,a){a&&this.removeImage(a);a=(new MediaItemImageDisplay(b,{size:"thumbnail",useBackground:!1,showFilename:!1,menu:!1})).getElement();this.thumbsContainer.grab(a);var g,d=this.imageMeta.getFirst();a.addEvent("mouseenter",function(a){clearTimeout(g);d.set("text",b.getGlobalID());g=d.makeInvisible.delay(5E3,d)});this.imageMeta.addEvents({mouseenter:function(a){clearTimeout(g);d.makeVisible()},mouseleave:function(a){g=d.makeInvisible.delay(5E3,d)}})},removeImage:function(b){return $$('#pageImages .mediaItem[data-imageid\x3d"'+
b.getID()+'"]').dispose()}}},1759:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});FrameModules.add("WikiRelatedFrameModule",function(){c.initialize()});var c=f.WikiRelatedFrameModule=window.WikiRelatedFrameModule={initialize:function(){when($("wikiRelatedInput"),function(b){DeviceFinder.initialize(b)})}}},1760:function(l,f,h){FrameModules.add("WikiHelpSidebarFrameModule",function(){var c,b=$("wikiHelpSidebar"),a=b.getElements("a[href$\x3d'"+window.location.pathname+"']")[0];a&&(c=
a.getParent(".subSection ul"));new Fx.Accordion(b,".subSection",".subSection ul",{duration:250,display:c,initialDisplayFx:!1,onActive:function(a){a.addClass("highlight")},onBackground:function(a){a.removeClass("highlight")}})})},1761:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});FrameModules.add("UserLikeFrameModule",function(){document.getElements(".js-favorite").each(function(b){new c(b)})});var c=f.LikeMeControl=window.LikeMeControl=new Class({el:null,count:null,doctype:null,
docid:null,action:null,requesting:!1,likedClass:"fa-heart",unlikedClass:"fa-heart-o",initialize:function(b){this.el=b;this.control=b.hasClass("control")?b:b.getElement(".control");this.useTooltip="true"==b.getProperty("data-useTooltip");this.iconEl=b.getElement(".js-icon-el");this.countEl=b.getElement(".likeCount")||$$(".js-like-count");this.textEl=b.getElement(".likeText");this.doctype=b.get("data-doctype");this.docid=b.get("data-docid");this.likedText=this.control.getProperty("data-likedText");
this.unlikedText=this.control.getProperty("data-unlikedText");this.likedClass=this.control.getProperty("data-likedIcon")||this.likedClass;this.unlikedClass=this.control.getProperty("data-unlikedIcon")||this.unlikedClass;this.likeInfo=App.userLikeInfo[this.doctype+"_"+this.docid];void 0!==this.likeInfo?this.initializeInterface():(new Request.AjaxIO("ajaxDoesLike",{onSuccess:function(a){this.likeInfo=a;this.initializeInterface()}.bind(this)})).send(this.doctype,this.docid);this.control.addEvents({mouseenter:this.entered.bind(this),
mouseleave:this.left.bind(this),click:function(a){a.stop();this.clicked()}.bind(this)})},initializeInterface:function(){this.useTooltip&&Tooltip.instance(this.control,{side:"top",align:"left",autoshow:!0});this.count=this.likeInfo.count;this.countEl&&this.countEl.set("text",this.count);this.likeInfo.likes?this.setLiked():this.likeInfo.notLoggedIn?this.setNoUpdate():this.setUnliked();this.el.makeVisible()},entered:function(){this.likeInfo.likes||this.iconEl.removeClass(this.unlikedClass).addClass(this.likedClass)},
left:function(){this.likeInfo.likes||this.iconEl.removeClass(this.likedClass).addClass(this.unlikedClass)},clicked:function(){this.favorite()},favorite:function(){this.requesting||Auth.required({message:_js('Log in to "favorite" this.'),onAuthorize:function(){var b;this.useTooltip?Tooltip.instance(this.control,_js("Updating...")).show():this.iconEl.set("class","fa fa-spinner fa-spin js-icon-el");this.requesting=!0;"like"===this.action?b="PUT":"unlike"===this.action&&(b="DELETE");(new Request.API_2_0("user/favorites/guides/"+
this.docid,{method:b,onSuccess:function(a){a="like"===this.action;this.likeInfo.likes=a;this.iconEl.set("class","fa js-icon-el");a?(this.count+=1,this.setLiked()):(--this.count,this.setUnliked());this.requesting=!1}.bind(this),onFailure:function(a,b){Modal.alert(b)}})).send({langid:App.langid})}.bind(this)})},setLiked:function(){this.useTooltip?Tooltip.instance(this.control,this.likedText):this.textEl.set("text",this.likedText);this.countEl&&this.countEl.set("text",this.count);this.action="unlike";
this.iconEl.removeClass(this.unlikedClass).addClass(this.likedClass)},setUnliked:function(){this.useTooltip?Tooltip.instance(this.control,this.unlikedText):this.textEl.set("text",this.unlikedText);this.countEl&&this.countEl.set("text",this.count);this.action="like";this.iconEl.removeClass(this.likedClass).addClass(this.unlikedClass)},setNoUpdate:function(){this.useTooltip&&Tooltip.instance(this.control,this.unlikedText);this.el.addClass("noUser")}})},1762:function(l,f,h){FrameModules.add("UserFlagsFrameModule",
function(){$$(".setUserFlagLink").each(function(c){var b=c.get("data-contentKey"),a=c.get("data-contentId");c.addEvent("click",function(c){c.stop();null!==a&&TweenMax.to($(a),.5,{height:0,overflow:"hidden"});(new Request.AjaxIO("setFlag",{onSuccess:function(a){a.success||alert(a.error)}})).send(b)})})})},1763:function(l,f,h){FrameModules.add("UserFeedbackFrameModule",function(){$$(".user_feedback_vote_button").addEvent("click",function(c){var b=this;if(!b.hasClass("disabled")){var a;c=b.get("data-url");
var g={doctype:b.get("data-doctype"),docid:b.get("data-docid"),score:b.get("data-score")},d=b.get("data-scoreid");var e=(d=d?$(d):null)?parseInt(d.get("html"),10):0;var k=parseInt(g.score,10);(a=b.hasClass("down")?b.getParent().getChildren(".up")[0]:b.getParent().getChildren(".down")[0],b.hasClass("active"))?(e-=k,b.removeClass("active")):a.hasClass("active")?(e=e+k-parseInt(a.get("data-score"),10),b.addClass("active"),a.removeClass("active")):(e+=k,b.addClass("active"));b.addClass("disabled");a.addClass("disabled");
b.addClass("inProgress");null!=d&&d.set("html",e);when($("user_feedback_text_dropdown"),function(a){var d=a.get("data-url"),e={doctype:b.get("data-doctype"),docid:b.get("data-docid")};a.hasClass("hidden")&&(a.slide("hide"),a.removeClass("hidden"),a.set("slide",{duration:250}));a.slide("in");var c=a.getElement("textarea"),g=c.get("maxlength").toInt(),k=a.getElement(".user_feedback_text_remaining_chars");c.addEvent("keyup",function(){var a=this.get("value"),b=g-a.length;0>b&&(a=a.substr(0,g),b=0,c.set("value",
a));k.set("text",b)});$$(".user_feedback_send_button").removeEvents().addEvent("click",function(b){b.stop();b=c.get("value");e.text=b;a.slide("out");(new Request.API_2_0(d,{method:"post",onSuccess:function(a){}})).send(e)})});(new Request.API_2_0(c,{method:"post",onSuccess:function(d){"anonymous"!=d.voteType?(b.removeClass("disabled"),a.removeClass("disabled")):(b.addClass("hidden"),a.addClass("hidden"),b.getNext(".user_feedback_vote_thanks_text").removeClass("hidden"));b.removeClass("inProgress")}})).send(g)}})})},
1764:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});FrameModules.add("TeamProfileFrameModule",function(){if(b.initialize(),$$(".repairServicesShowMore").addEvent("click",function(a){a.stop();$("repairServices").toggle()}),App.showStatus){var a=new StatusNotice;$("inviteStatus").adopt(a.element).inject($("bodyTop"),"top");App.success?a.good(_js("You have been added to this team!")):a.error(_js("There was an error adding you to this team"))}App.promptLogin&&(App.hasUser?(Auth.login({from:"navLogin",
message:_js("Logging in will reload the page."),reload:!Utils.hasUnsavedChanges()}),"Ecom_BillTo_Online_Email_Login"):(Auth.login({from:"navSignup",message:_js("Registering will reload the page."),reload:!0,register:!0}),"Ecom_BillTo_Online_Email_Login_Reg"));$("inviteContainer")&&new c});var c=f.InviteForm=window.InviteForm=new Class({Implements:Options,options:{popFx:{duration:200,transition:"quad:out"}},initialize:function(a){this.setOptions(a);this.inviteContainer=$("inviteContainer");this.modalLink=
$("modalLink");this.container=$("inviteContainer");this.userList=$("userListContainer");this.forceInvites=$("forceInvites");this.emails=$("inviteEmails");this.message=$("inviteMessage");this.submitButton=$("inviteSubmit");this.closeButton=$("inviteClose");this.emailsHelp=$("inviteEmailsHelp");this.invalidEmails=$("inviteInvalidEmails");this.noticeDiv=$("statusNoticeDiv");this.modalLink.addEvent("click",function(a){a.stop();this.emails.addEvent("focus",function(a){this.emailsHelp.show();this.invalidEmails.hide()}.bind(this));
this.setupNotice("title");Modal.open({type:"element",element:this.inviteContainer});this.inviteContainer.show()}.bind(this));this.submitButton.addEvent("click",function(a){a=this.matchEmails();if(!(0>=a.length)){var b=this.inviteContainer.get("data-teamid"),e=this.message.get("value"),c=!!this.forceInvites&&this.forceInvites.get("checked");this.processInvites(b,a,e,c)}}.bind(this));this.closeButton.addEvent("click",function(a){Modal.close()}.bind(this))},matchEmails:function(){var a=this.emails.get("value").match(/([a-z0-9._-]+@[a-z0-9._-]+\.[a-z]{2,4})/gi);
if(!a)return this.invalidEmailsError(),[];for(var b=[],d=0;d<a.length;d++)b.contains(a[d])||b.push(a[d]);return b},invalidEmailsError:function(){this.emailsHelp.hide();this.invalidEmails.show();this.emails.setStyle("border-color","#8a1c1c");this.emails.setStyle("background","#efd0d0")},setupNotice:function(a,b){var d=new StatusNotice;switch(this.noticeDiv.empty(),this.noticeDiv.adopt(d.element),a){case "error":d.error(_js("Remaining emails are either invalid or already in team."));break;case "serious_error":d.error(_js("Operation Failed")+
(b?": "+b:""));break;case "send":d.notice(_js("Sending Invites..."));break;default:d.good(App.title)}},processInvites:function(a,b,d,e){b.length>App.teamInvite.maxInvitesPerFormSubmission?this.setupNotice("serious_error",_js(App.teamInvite.error.maxInvitesExceeded)):(this.lockForm(),this.setupNotice("send"),(new Request.AjaxIO("sendInvites",{onSuccess:function(a){a?(this.setupNotice("error"),this.unlockForm(),this.emails.set("value",a)):(Modal.close(),this.resetForm(),StatusPanel.notify(_js("Invites sent!"),
2,{reload:!1}))}.bind(this),onError:function(a){this.setupNotice("serious_error",a.error);this.unlockForm()}.bind(this)})).send(a,b,d,e))},resetForm:function(){this.unlockForm();this.emailsHelp.show();this.invalidEmails.hide();this.message.set("value","")},lockForm:function(){this.emails.disabled=!0;this.message.disabled=!0;null!==this.forceInvites&&(this.forceInvites.disabled=!0);this.submitButton.disabled=!0;this.submitButton.addClass("buttonLinkDisabled");this.closeButton.disabled=!0;this.closeButton.addClass("buttonLinkDisabled")},
unlockForm:function(){this.emails.disabled=!1;this.message.disabled=!1;null!==this.forceInvites&&(this.forceInvites.disabled=!1);this.submitButton.disabled=!1;this.submitButton.removeClass("buttonLinkDisabled");this.closeButton.disabled=!1;this.closeButton.removeClass("buttonLinkDisabled")}}),b=f.TeamProfileBox=window.TeamProfileBox={initialize:function(){when($("reqLogin"),this.requireLogin);this.leaveTeam();this.joinTeam()},requireLogin:function(a){Auth.login({from:"navLogin",message:_js("Logging in will reload the page."),
reload:!0})},leaveTeam:function(){$$(".js-leave-team-button").addEvent("click",function(a){a.stop();a=this.get("data-memberCount");this.get("data-teamid");(1==a?confirm(_js("Warning! You are the last member of this team. Leaving this team will delete the team. Do you want to continue?")):confirm(_js("Warning! Leaving this team will remove all of your contributions and activities from your team's history. Do you want to continue?")))&&(new Request.API_2_0(App.teamApi.leaveUrl+App.userid,{method:App.teamApi.leaveMethod,
statusPanelMessage:_js("Leaving..."),onSuccess:function(a){window.location.search=""},onFailure:function(a,b){alert(b)}})).send()})},joinTeam:function(){$$(".js-join-team-button").addEvent("click",function(a){a.stop();var b=this;Auth.required({reload:!1,message:_js("Log in to join this team."),onAuthorize:function(a){a=a&&a.userid?a.userid:App.userid;var d=b.get("data-joinCode");(new Request.API_2_0(App.teamApi.joinUrl+a+(d?"?join_code\x3d"+d:""),{method:App.teamApi.joinMethod,statusPanelMessage:_js("Joining..."),
onSuccess:function(a){window.location.reload()},onFailure:function(a,b){alert(b)}})).send()}})})}}},1765:function(l,f,h){FrameModules.add("AuthorEditFrameModule",function(){window.AuthorEditor={options:{max:999,hideOnMax:!0,controls:!0,form:$("author-edit-form"),formManager:null,input:$("author-input"),inputContainer:$("author-input-container"),container:$("author-name-container"),cancelControl:$("cancel-author-change"),control:$("edit-author-button"),customChoicesContainer:$("author-search-choices"),
multiple:!1,overflow:!0,currentAuthorName:$("current-author-name"),currentAuthorImage:$("current-author-image")},initialize:function(c){this.setOptions(c);this.form=this.options.form;this.container=this.options.container;this.control=this.options.control;this.cancelControl=this.options.cancelControl;this.input=this.options.input;this.inputContainer=this.options.inputContainer;this.customChoicesContainer=this.options.customChoicesContainer;this.docid=this.form.guideid.value;this.langid=this.form.langid.value;
this.currentAuthorName=this.options.currentAuthorName;this.currentAuthorImage=this.options.currentAuthorImage;c=App.authorInfo.username;App.authorInfo.unique_username&&(c+=" (@"+App.authorInfo.unique_username+")");this.currentAuthorInfo={name:c,image:App.authorInfo.image};this.newAuthorInfo={};var b=function(a){a&&a.stop();this.input.set("value","");this.inputContainer.show();this.input.focus();this.newAuthorInfo={};this.input.addEvent("blur",function(a){a.stop();this.currentAuthorName.set("text",
this.newAuthorInfo.name?this.newAuthorInfo.name:this.currentAuthorInfo.name);this.currentAuthorImage.set("src",this.newAuthorInfo.image?this.newAuthorInfo.image:this.currentAuthorInfo.image);this.inputContainer.hide()}.bind(this))}.bind(this);return this.control.addEvent("click",b),new SuggestAuthors(this.options.input,{customChoices:this.customChoicesContainer,maxChoices:5,multiple:!1,onSelect:function(a,b,d){this.currentAuthorName.set("text",b.get("data-username"));this.currentAuthorImage.set("src",
b.get("data-image"))}.bind(this),onSelection:function(a,c,d){this.newAuthorInfo={userid:a.get("data-userid"),name:a.get("data-username"),image:a.get("data-image")};this.control.innerHTML=_js("Save");this.control.removeEvents();this.control.addEvent("click",function(a){this.saveAuthor();this.cancelControl.hide();this.control.removeEvents();this.control.innerHTML=_js("Edit");this.control.addEvent("click",b)}.bind(this));this.cancelControl.addEvent("click",function(a){this.cancelControl.hide();this.currentAuthorName.set("text",
this.currentAuthorInfo.name);this.currentAuthorImage.set("src",this.currentAuthorInfo.image);this.control.innerHTML=_js("Edit");this.control.removeEvents();this.control.addEvent("click",b)}.bind(this));this.cancelControl.show("inline-block");this.inputContainer.hide()}.bind(this),relative:!0}),this},saveAuthor:function(){(new Request.AjaxIO("saveAuthor",{onSuccess:function(c){c.error?Modal.alert(c.error):(this.control.innerHTML=_js("Edit"),this.currentAuthorInfo.name=c.username,c.unique_username&&
(this.currentAuthorInfo.name+=" (@"+c.unique_username+")"),this.currentAuthorInfo.image=c.image)}.bind(this)})).send(this.newAuthorInfo.userid,this.docid,this.langid)}};Object.append(AuthorEditor,Utils.EventsFunctions);Object.append(AuthorEditor,new Options)})},1766:function(l,f,h){FrameModules.add("TagsEditFrameModule",function(){window.TagEditor={options:{max:999,hideOnMax:!0,controls:!0,form:$("tagsEditForm"),formManager:null,input:$("tagsEdit"),container:$("tagList"),control:$E(".saveTagsControl")},
initialize:function(c){this.setOptions(c);this.form=this.options.form;this.container=this.options.container;this.docid=this.form.docid.value;this.doctype=this.form.doctype.value;this.input=this.options.input;this.options.formManager?this.options.formManager:new FormManager(this.form);this.tags=[];var b=function(a){a&&a.stop();this.submitTags()}.bind(this);return $("tagsAdd").addEvent("click",b),new SuggestTags(this.options.input,{onSelection:function(){b(null)}}),this.container.getChildren().each(function(a){"none"!=
a.getStyle("display")?this.setup(a,!0):a.dispose()}.bind(this)),this.control=this.options.control,this.control&&(this.control.getElement("a[href$\x3dsave-tags]").addEvent("click",this.save.bind(this)),this.control.getElement("a[href$\x3dcancel-tags]").addEvent("click",this.cancel.bind(this))),this.savedTags=[].append(this.tags),this.fireEvent("change",[this.tags]),this},save:function(c,b){c.stop();(new Request.AjaxIO("saveTags",{onSuccess:function(a){if(b&&b(),a.error)Modal.alert(a.error);else{var c=
a.tags;when($("revisionid"),function(b){null!=a.revisionid&&b.set("value",a.revisionid)});this.tags=[];this.container.empty();c.each(function(a){this.addTag(a,!0)}.bind(this));this.savedTags=[].append(this.tags);this.control.hide();this.fireEvent("change",[this.tags]);this.fireEvent("done")}}.bind(this)})).send(this.docid,this.doctype,this.tags)},cancel:function(c){c.stop();this.tags=[];this.container.empty();this.savedTags.each(function(b){this.addTag(b,!0)}.bind(this));this.control.hide();this.checkMax();
this.fireEvent("change",[this.tags]);this.fireEvent("done")},isLegacyTagStyle:function(){return this.container.hasClass("legacyTagStyle")},addTag:function(c,b){if(!this.tags.contains(c)&&!this.tags.contains("#"+c)){var a=new Element("li",{class:"js-tag","data-tag":c});this.isLegacyTagStyle()?(a=new Element("li"),(new Element("span",{class:"tag-text"})).set("text",c).inject(a)):(a.adopt(new Element("i",{class:"fa fa-circle-o"})),a.adopt(new Element("i",{class:"fa fa-times js-tag-delete",style:"display: none"})),
a.adopt(new Element("span",{class:"tag-text",text:c})));a.inject(this.container);this.container.show();this.container.addClass("showFlex");this.setup(a,b);this.showControls()}},submitTags:function(){(new Request.AjaxIO("addTags",{onSuccess:function(c){c.each(function(b){var a=this.tags.length;++a<=this.options.max?this.addTag(b):(b=_js("The maximum number of tags is four.")+" ",this.showStatusMessage(b,$("tagInput")))},this);this.fireEvent("change",[this.tags])}.bind(this)})).send(this.input.value);
this.input.value=""},removeTag:function(c){this.showControls();this.tags=this.tags.filter(function(b){return b.trim()!=c});this.container.getChildren().each(function(b){b.retrieve("tag")==c&&(b.retrieve("saved")?(b.set("html",c),b.setStyle("text-decoration","line-through")):b.destroy())}.bind(this));this.checkMax();this.fireEvent("change",[this.tags])},setup:function(c,b){var a=c.get("text").trim()||c.getFirst().get("text").trim();c.store("tag",a);c.store("saved",b);c.addEvent("click:relay(.js-tag-delete)",
function(a,b){a.stop();a=b.getParent().get("data-tag").trim();this.removeTag(a);b.getParent().destroy()}.bind(this));when($("removeTag"),function(b){b.getFirst().clone().addEvent("click",function(b){b.stop();this.removeTag(a)}.bind(this)).inject(c)}.bind(this));when($("synonymizeTag"),function(b){b.getFirst().clone().addEvent("click",function(b){b.stop();this.synonymizeTag(a)}.bind(this)).inject(c)}.bind(this));Icons.addEvents(c);this.tags.combine([a]);this.checkMax()},synonymizeTag:function(c){var b=
prompt("CREATING NEW AUTOMATIC TAG SYNONYM\n\nBe careful with this.\n\nAlways replace tag '"+c+"' with:");b&&(new Request.AjaxIO("addSynonym",{onSuccess:function(a){a&&(this.removeTag(c),this.addTag(b))}.bind(this)})).send(this.docid,this.doctype,c,b)},checkMax:function(){return this.tags.length<this.options.max?($("tagInput").show(),$("tagsEditStatusMessage").hide(),!1):(this.options.hideOnMax&&$("tagInput").hide(),!0)},showStatusMessage:function(c,b){$("tagsEditStatusMessage").setProperty("text",
c).inject(b,"after").show()},showControls:function(){this.options.controls&&this.control.show()}};Object.append(TagEditor,Utils.EventsFunctions);Object.append(TagEditor,new Options)})},1767:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});f.SingleFieldEditor=window.SingleFieldEditor=new Class({Extends:BlurbFinder,iconShowDisplayType:"inline",initialize:function(c,b,a){var g=c.getElement("a"),d=new Element("span",{class:"edit iconLink",title:a.field_title||_js("Edit"),styles:{display:"none"},
html:window.guide_constants.fa("PENCIL")}),e=new Element("span",{class:"iconLink js-icon-cancel icon-cancel",styles:{display:"none"},html:window.guide_constants.fa("TIMES")}),k=c.getDimensions().x+20;c.adopt(d);c.adopt(e);var m=new Element("input",{styles:{width:a.width||k}}),p=function(){m.hide();g.show();d.show(this.iconShowDisplayType);e.hide();this.hideChoices();this.fireEvent("editEnd")}.bind(this);this.addEvent("submit",function(b){(new Request.AjaxIO("setSingleField",{onSuccess:function(a){a&&
(c.set("data-single-field",a.field),g.set("text",a.text));p()}})).send(a.field,m.value,b)});m.addEvents({keydown:function(a){if("esc"==a.key)return a.stop(),void p()}.bind(this),keypress:function(a){"enter"==a.key&&(a.stop(),this.fireEvent("submit"))}.bind(this)}).hide().inject(g,"after");d.addEvent("click",function(a){a.stop();g.hide();d.hide();e.show(this.iconShowDisplayType);m.set("value",c.get("data-single-field")).show("inline-block").focus();m.selectRange(0,m.value.length);this.fireEvent("editBegin")}.bind(this));
e.addEvent("click",function(a){a.stop();p()});a.hideUntilHover?(m.isVisible()||d.setStyle("visibility","hidden").show(this.iconShowDisplayType),c.addEvents({mouseenter:function(a){m.isVisible()||d.setStyle("visibility","visible")}.bind(this),mouseleave:function(a){m.isVisible()||d.setStyle("visibility","hidden")}.bind(this)})):d.show(this.iconShowDisplayType);b&&this.parent(m,b,a)}})},1768:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});FrameModules.add("GuideWorkLogSettingsFrameModule",
function(){new c});var c=f.GuideWorkLogSettings=window.GuideWorkLogSettings=new Class({ajaxSpinner:new Element("img",{src:window.shared_constants.BaseURI("SITE_IMAGE_AJAX_LOAD")}),initialize:function(){this.form=document.id("sidebarGuideWorkLogSettings");this.guideid=this.form.getProperty("data-guideid");this.workLogToggle=new Button.Toggle("workLogToggle",{callback:this.toggle.bind(this)})},buildAjaxSpinner:function(b){return(new Element("span",{class:"ajax-spinner "+b})).adopt(this.ajaxSpinner)},
toggle:function(b){var a=this;b="enabled"==b.target.get("data-value");var c=$$("[name\x3dintro[revisionid]]").pick(),d=null===c?App.guide_revisionid:c.get("value");$("workLogSettingsField").adopt(a.buildAjaxSpinner("workLogEnable"));(new Request.AjaxIO("setWorkLogEnabled",{onSuccess:function(b){if($$(".ajax-spinner").dispose(),b.error)return b=Utils.createAlert("error",b.error),$("guideWorkLogSettingsErrors").grab(b,"top"),void a.workLogToggle.untoggle();null!==c&&c.set("value",b.revisionid);App.guide_revisionid=
b.revisionid;App.guideApi&&(App.guideApi.revisionid=App.guide_revisionid);$$(".form-builder").toggle(b.workLogEnabled)}})).send(a.guideid,d,b)}})},1769:function(l,f,h){FrameModules.add("CommentsWatchFrameModule",function(){var c=$("commentsWatchOn"),b=$("commentsWatchOff");when(c,function(a){a.getFirst(".js-toggle-watch").addEvent("click",function(c){c.stop();(new Request.AjaxIO("watch",{onSuccess:function(){a.hide();b.show("inline")}})).send("on",this.get("data-context"),this.get("data-contextid"))})});
when(b,function(a){a.getFirst(".js-toggle-watch").addEvent("click",function(b){b.stop();(new Request.AjaxIO("watch",{onSuccess:function(){a.hide();c.show("inline")}})).send("off",this.get("data-context"),this.get("data-contextid"))})})})},1770:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});FrameModules.add("StepListEditFrameModule",function(){new c});var c=f.StepIndex=window.StepIndex=new Class({initialize:function(){this.sides=[];this.modified=this.editing=!1;this.container=document.id("guideStepIndex");
this.savingMsg=document.id("savingReorder");this.errorMsg=document.id("reorderError");var b=this.gatherSteps();this.addHoverEvents(b);$("guideStepIndex").hasClass("locked")||(this.setOriginalStepIndexes(b),this.toggleLink=document.getElement("#toggleStepReorder a"),this.toggleLink.addEvent("click",this.beginEditMode.bind(this)),this.saveControl=document.id("saveReorder"),this.saveControl.getElement("a[href$\x3dsave]").addEvent("click",this.save.bind(this)),this.saveControl.getElement("a[href$\x3dcancel]").addEvent("click",
this.cancel.bind(this)));Utils.UnsavedChanges.addHandler(function(){if(this.modified)return _js("You have unsaved changes. Your changes will be lost if you continue.")}.bind(this))},addHoverEvents:function(b){b.each(function(a){a.addEvents({mouseenter:this.setActive.pass([a,!0],this),mouseleave:this.setActive.pass([a,!1],this)});this.setActive(a,!1)},this);when($E(".guideSidebarAddStep"),function(a){a.addEvents({mouseenter:a.setStyle.pass(["background-position","left -126px"],a),mouseleave:a.setStyle.pass(["background-position",
"left -84px"],a)})})},addDragEvents:function(){var b=this.gatherSteps();if(!(1>b.length)){this.stepStyle=b[0].getStyles("width","height");var a=0==this.sides.length;b.each(function(b,d){a&&(d=(new Element("div.left")).setStyles({display:"none",position:"absolute",top:0,left:0,width:"50%",height:"100%"}),d.inject(b),this.sides.push(d),d=(new Element("div.right")).setStyles({display:"none",position:"absolute",top:0,right:0,width:"50%",height:"100%"}),d.inject(b),this.sides.push(d));b.getElement("a").addEvents({mousedown:this.onMousedown.bind(this,
b),click:function(a){a.stop()}})},this)}},removeDragEvents:function(){this.gatherSteps().each(function(b){b=b.getElement("a");b.removeEvents("mousedown");b.removeEvents("click")})},setActive:function(b,a){if(!this.editing){var c,d,e=b.getElement("a");b.hasClass("current")?e.setStyles({opacity:.01,backgroundColor:"transparent"}):(a?(c=.01,d="addClass"):(c=.3,d="removeClass"),e.setStyles({opacity:c,backgroundColor:"#3c5d8b"}),b[d]("active"))}},onMousedown:function(b,a){a.stop();var c=a.page,d=function(a){a.stop();
(1<=Math.abs(a.page.x-c.x)||1<=Math.abs(a.page.y-c.y))&&(document.removeEvent("mousemove",d),document.removeEvent("mouseup",e),this.startDrag(a,b))}.bind(this),e=function(a){document.removeEvent("mousemove",d);document.removeEvent("mouseup",e)}.bind(this);document.addEvent("mousemove",d);document.addEvent("mouseup",e)},startDrag:function(b,a){var c=a.getCoordinates(),d=$$("body")[0];c=(new Element("div.ghostStep")).setStyles(Object.append(this.stepStyle,{position:"absolute",top:c.top,left:c.left,
border:"1px dashed black",zIndex:1E3}));d.adopt(c);c.store("step",a);a.setStyle("opacity",0);this.sides.invoke("show");c.makeDraggable({droppables:this.sides,container:$("guideStepIndex"),onEnter:this.onEnter.bind(this),onDrop:this.onDrop.bind(this),snap:0,preventDefault:!0,unDraggableTags:[]}).start(b)},onEnter:function(b,a){var c=a.hasClass("left");b.retrieve("step").inject(a.getParent(),c?"before":"after")},onDrop:function(b,a){a=b.retrieve("step");a.getPrevious(".guideSidebarThumb");b.dispose();
a.setStyle("opacity",1);this.sides.invoke("hide");this.modified=!0},beginEditMode:function(b){b.stop();this.showError(!1);this.addDragEvents();this.saveControl.replaces(this.toggleLink).show();this.container.addClass("reorderingSteps");this.editing=!0;this.modified=!1},endEditMode:function(){this.removeDragEvents();this.container.removeClass("reorderingSteps");this.modified=this.editing=!1},hideError:function(){showError()},showError:function(b){b?(this.errorMsg.set("text",b),this.errorMsg.show(),
this.errorMsg.dissolve.delay(5E3,this.errorMsg)):this.errorMsg.hide()},save:function(b){b.stop();Auth.required({onAuthorize:this.requestSave.bind(this)})},requestSave:function(b){var a=this.gatherSteps();b=a.map(function(a){return a.get("data-stepid").toInt()});this.savingMsg.replaces(this.saveControl).show();var c=this.getStepReorderPath(App.guideid,App.guide_revisionid);(new Request.API_2_0(c,{method:"PUT",onSuccess:function(b){App.guide_revisionid=b.revisionid;this.finishSave(a)}.bind(this),onFailure:function(a,
b){this.showError(b);this.toggleLink.replaces(this.savingMsg);this.endEditMode()}.bind(this)})).send({stepids:b})},getStepReorderPath:function(b,a){return"guides/"+b+"/steporder?revisionid\x3d"+a},finishSave:function(b){b.each(function(a,b){a.getElement(".stepNumber").set("text",b+1)});this.setOriginalStepIndexes(b);var a=$("guideStepIndex"),c=a.getElement(".current");if(c){var d=c.getPrevious(".guideSidebarThumb"),e=c.getNext(".guideSidebarThumb");when($E(".orderby"),function(a){var b=c.retrieve("originalIndex");
a.set("text",b)}.bind(this));when($$(".prevLink"),function(a){a.each(function(a){var b=a.getElement(".prevLinkText");d?(a.set("href",d.getElement("a").get("href")),b.set("text",_js("Previous"))):(a.set("href",a.get("href").replace("edit","intro")),b.set("text",_js("Introduction")))},this)}.bind(this))}when($$(".nextLink"),function(b){b.each(function(b){e?(b.set("href",e.getElement("a").get("href")),b.show()):c?b.hide():b.get("text").substring(0,10)==_js("First step")&&b.set("href",a.getElement("a").get("href"))},
this)}.bind(this));this.toggleLink.replaces(this.savingMsg);this.endEditMode()},cancel:function(b){b.stop();b=this.gatherSteps();b.sort(function(a,b){return a.retrieve("originalIndex")-b.retrieve("originalIndex")});var a=$("thumbsContainer");b.each(function(b){b.inject(a,"bottom")});this.toggleLink.replaces(this.saveControl);this.endEditMode()},gatherSteps:function(){return document.getElements(".guideSidebarThumb")},inOrder:function(b){for(var a=0;a<b.length;a++)if(b[a].retrieve("originalIndex")!=
a+1)return!1;return!0},setOriginalStepIndexes:function(b){b.each(function(a,b){a.store("originalIndex",b+1)})}})},1771:function(l,f,h){FrameModules.add("PatrolThresholdFrameModule",function(){when($("patrolThreshold"),function(c){var b=$E("#patrolThreshold button"),a=c.getElement("input.value"),g=c.type.value,d=c.max_allowed.value.toInt(),e=c.max_displayed.value.toInt(),k=c.infinite.value.toInt();k="\u221e"===a.value?k:a.value.toInt();var m=new RangeSlider($("patrolSlider"),{type:"single",range:[0,
d],position:[k],onChange:function(b){a.value=b===e?"\u221e":b}.bind(this),onComplete:function(a){b.disabled=!1}.bind(this)});a.addEvent("focus",function(){b.disabled=!1});c.addEvent("submit",function(c){c.stop();c=this.docid.value;var e="\u221e"===a.value?"inf":a.value;(new Request.AjaxIO("saveThreshold",{onSuccess:function(c){this.submitButton.blur();a.blur();"inf"==c||c>=d?(m.set(d),a.value="\u221e"):(m.set(c),a.value=c);b.disabled=!0}.bind(this)})).send(g,c,e)});b.disabled=!0})})},1772:function(l,
f,h){Object.defineProperty(f,"__esModule",{value:!0});FrameModules.add("TopicHierarchyFrameModule",function(){c.initialize()});var c=f.TopicHierarchy=window.TopicHierarchy={initialize:function(){when($("topicParentForm"),function(b){var a=$("th_wikiid").get("value").toInt(),c=$("th_parentTitle"),d=b.getElement("p.statusError"),e=new Autocompleter.Request.JSON(c,"/Guide/JSON/areas",{fxOptions:null,postVar:"search"}),k=function(b){e.hideChoices(!0);b.stop();var k=c.get("value");(new Request.AjaxIO("wikiHasVariants",
{onSuccess:function(b){if(b.hasVariant&&(b=App.topicInUseWarning.replace(App.topicInUseNameKey,k),!confirm(b)))return;(new Request.AjaxIO("saveWikiArea",{onSuccess:function(a){a.error?(c.blur(),d.set("html",a.message),d.show().setStyle("opacity",1),function(){(new Fx.Tween(d)).start("opacity",0).chain(d.hide.bind(d))}.delay(3E3)):window.location.reload()}})).send(a,k)}})).send(k)};b.addEvent("submit",k);b.getElement("a").addEvent("click",k)})}}},1773:function(l,f,h){function c(b){function a(a){a=
a.getAttribute("data-editorid");a=document.getElementById(a);return window.prosemirrorComments.getOrCreateEditor(a)}function g(a){var b=(new Request.AjaxIO(f())).send(l,r,!1).then(function(b){t.set("html",b.html);ModeratorVote.setupLinkActions();a&&a(t)});return LoadingIndicator.withPromise(b,{hideSuccessMessage:!0,pendingMessage:"Loading comments..."}),b}function d(a){a.stop();a=_js("View Active");var b="deleted",d=!0;"active"!=this.get("data-mode")&&(a=_js("View Deleted"),b="active",d=!1);(new Request.AjaxIO(f(),
{onSuccess:function(a){t.set("html",a.html);ModeratorVote.setupLinkActions()}})).send(n.get("data-context"),n.get("data-contextid"),d);this.set("html",a);this.set("data-mode",b)}function e(a){if(y){var b=parseInt(y.get("data-numcomments"),10)+a;a=1===b?_js("One Comment"):_js("%1 Comments").replace("%1",b);y.set("data-numcomments",b);y.set("text",a)}}function k(b){var d=b.get("title")||_js("Add Comment");w=b.get("data-parentid");var c=document.querySelector('.commentContent[data-commentid\x3d"'+w+
'"]'),e=!!c;D.empty();c&&D.append(c.clone());v&&v.set("text",d);d=b.get("data-context");c=b.get("data-contextid");l=e?d:n.get("data-context");r=e?c:n.get("data-contextid");E.toggleClass("hidden",!e);n.removeClass("hidden");b=a(b).el;u.clear(b)}function m(a){a=b.getElement("#comment-"+a.get("data-commentid"));var d=a.getParent(".comment-reply"),c=1;((d||a.getParent(".comment-thread")).destroy(),null===d)&&(c+=a.getSiblings(".comment-reply").length);return c}function p(b,d){r=r||n.get("data-contextid");
l=l||n.get("data-context");var c=a(b);Auth.required({message:_js("Log in to add a new comment"),onAuthorize:function(){StatusPanel.loading(_js("Adding note..."),20);(new Request.API_2_0("comments/"+l+"/"+r,{method:"POST",onSuccess:function(a){StatusPanel.deactivate();x.hide();x.set("text",z);c.clear();k(n);v.set("text",_js("Add Comment"));E.addClass("hidden");g(function(a){e(1);a=a.getElementsByClassName("comment");Array.prototype.slice.call(a).forEach(function(a){delete window.editorMapping[a.id]});
App.setMentions})},onFailure:function(a,b){StatusPanel.deactivate();u.showError(c.el,b);!0},onComplete:function(){StatusPanel.deactivate()}})).send({text:c.value,parentid:w,langid:App.langid})}})}function q(b){var d=a(b);Utils.UnsavedChanges.addHandler(function(){if(""!==d.value.trim())return _js("Your comments have not yet been posted. Your changes will be lost if you continue.")});k(b)}function f(){return b.get("data-api")||"getGroupedCommentsHtml"}var h=this,t=b.getElement(".js-comments"),n=b.getElement(".js-add-comment-form");
n.store("commentManager",this);var l,r,w,v=n.getElement(".js-add-comment-title"),D=n.getElement(".js-reply-comment-text"),E=n.getElement(".js-cancel-reply"),x=null,z=null,B=null,y=b.getElement(".js-comment-count"),A=!1;if(n){var u=new FormManager(n);!function(e){x=e.getElement(".maxCharacters");z=parseInt(x.get("text"),10);B=parseInt(x.getProperty("data-minimum"),10);u.addSubmitHandler(function(){return e.querySelector(".ProseMirror-widget input.js-link-editor")!==document.activeElement});u.addSubmitHandler(function(){if(A){var b=
a(e),d=b.text.trim().replace(/\r\n?/,"\n").replace(/ +/," "),c=!1;return 0>=d.length?c=_js("You cannot submit an empty comment!"):d.length>z?c=_js("Your comment is too long. Please keep it under %1 characters. It is currently %2 characters.",z,d.length):d.length<B&&(c=_js("Your comment is too short. Please write something over %1 characters. It is currently %2 characters.",B,d.length)),A=!1,!c||(u.showError(b.el,c),!1)}});u.addSubmitHandler(p);window.addEvents({"click:relay(.js-add-comment)":function(a,
b){a=b.closest(".js-comment-container");var d;(d=a.retrieve("commentManager"))||(d=new c(a),d=(a.store("commentManager",d),d));(a.store("commentManager",d),d).setupCommentEditor(b);!0},"click:relay(.js-scroll-to-editor)":function(a,b){a.event.stopImmediatePropagation();a=b.getAttribute("data-editorid");var d=document.getElementById(a);a=d.getParent("form");(new Fx.SmoothScroll({duration:200},window)).toElement(a,"y").chain(function(){d.focus()})}});b.addEvents({"click:relay(.js-comment-submit)":function(){A=
!0},"click:relay(.js-show-page-comments)":function(a){h.loadComments();a.target.setAttribute("disabled","1")}});b.id&&$$(".addComment[data-containerid\x3d"+b.id+"])").addEvent("click",q);b.getElements(".js-toggle-deleted").addEvent("click",d)}(n)}t.addEvents({"click:relay(.js-permalink)":function(){var a=this.getAttribute("href");history.replaceState(null,null,a);event.preventDefault()},"click:relay(.js-edit-comment)":function(d){var c=a(this),e=this;d.stop();Auth.required({message:_js("Log in to edit a comment"),
onAuthorize:function(){var a=e.getParent(".comment"),d=a.getFirst(".commentContent"),k=a.getFirst(".commentEditDiv");a=e.get("data-commentid");var g=b.getElements(".commentActions");g.addClass("hidden");d.hide();k.show();var m=new Request.API_2_0("comments/"+a,{method:"PATCH",onSuccess:function(a){k.hide();d.set("html",a.text_rendered);d.show();c.saveState();g.removeClass("hidden")},onFailure:function(a,b){StatusPanel.deactivate();u.error(c.el,b);c.el.addEvent("blur",function(a){u.clearIfError(a.target)});
u.showStatusMessage(c.el);c.focus()}});k.getFirst(".js-cancel-edit").addEvent("click",function(a){d.show();k.hide();u.clearIfError(c.el);c.reset();g.removeClass("hidden")});a=k.getFirst(".js-submit-edit");a.hasClass("submit-handler")||a.addClass("submit-handler").addEvent("click",function(a){a.stop();a=c.value.trim();m.send({text:a})})}})},"click:relay(.js-delete-comment)":function(a){var d=this;a.stop();Auth.required({message:_js("Log in to delete a comment"),onAuthorize:function(){var a=d.get("data-commentid");
b.getElement("#comment-"+a)&&confirm(_js("Are you sure you want to delete this comment?"))&&(new Request.API_2_0("comments/"+a,{method:"DELETE",onSuccess:function(){e(-m(d))}})).send()}})},"click:relay(.js-restore-comment)":function(a){var b=this;a.stop();Auth.required({message:_js("Log in to restore a comment"),onAuthorize:function(){(new Request.AjaxIO("restoreComment",{onSuccess:function(){e(m(b))}})).send(b.get("data-commentid"))}})}});this.loadComments=function(){return t.get("data-loaded")?
Promise.resolve():(l=b.get("data-context"),r=b.get("data-contextid"),g().then(function(){t.set("data-loaded",1)}))};this.submit=function(){A=!0;n.retrieve("FormManager:formManager").submit()};this.setupCommentEditor=function(a){q(a)}}Object.defineProperty(f,"__esModule",{value:!0});FrameModules.add("CommentsFrameModule",function(){var b=$E(".js-page-comments");if(b){var a=b.closest(".js-comment-container");b=new c(b);a.store("commentManager",b)}});f.CommentManager=c;window.CommentManager=c},1774:function(l,
f,h){FrameModules.add("ModeratorVoteFrameModule",function(){var c,b;window.ModeratorVote={adminForce:!0,loading:!1};var a=null,g=function(a){c=a;Modal.doneLoading();var e=new Element("div");e.set("html",a.html);Modal.open({type:"element",element:e});e=$("moderatorVoteTargetSubmit");b={doctype:a.doctype,docid:a.docid,action:a.action,adminForce:ModeratorVote.adminForce};$("moderatorVoteTargetDocid").addEvent("focus",function(a){$("moderatorVoteTargetRadioOther").set("checked",!0)});e.addEvent("click",
d)},d=function(d){d.stop();d=$("moderatorVoteTargetDocid").get("value");var e=$$("#moderatorVoteMenu .moderatorVoteTargetRadio");a=null;e.each(function(b){b.checked&&(a=b.get("value"))});"box"==a&&(a=d);null==a&&(a="");""==(a=a.trim())?Modal.open({type:"message",message:"Please select a target before proceeding.",buttons:{Ok:function(){g(c)}}}):(b.target_docid=a,b.adminForce=ModeratorVote.adminForce,ModeratorVote.voteRequest.send(b))};ModeratorVote.targetRequest=new Request.AjaxIO("getTargetModal",
{onSuccess:g});ModeratorVote.voteRequest=new Request.AjaxIO("doModeratorVote",{onSuccess:function(a){Modal.doneLoading();ModeratorVote.doneLoading();ModeratorVote.hideChoosePostLinks();null!=a.error?Modal.open({type:"message",message:a.error,buttons:{Ok:function(){window.location.reload()}}}):"passed"==a.result?(Modal.currentState?Modal.loading("Reloading page..."):ModeratorVote.showLoadingOnElement(ModeratorVote.lastLoadingElement,"Reloading page..."),null!=a.link?window.location=a.link:window.location.reload()):
Modal.currentState&&Modal.close()}});ModeratorVote.setupLinkActions=function(){$("content").addEvents({"click:relay(.js-vote-flag-link, .voteFlagLink)":function(a,b){a.stop();a=b.get("data-docid");var d=b.get("data-doctype");b=b.getParent(".qaPost");ModeratorVote.showLoadingOnElement(b,'_js("Loading menu...")');b={questionid:ModeratorVote.questionid};ModeratorVote.menuRequest.send(d,a,b);ModeratorVote.lastDoctype=d;ModeratorVote.lastDocid=a;ModeratorVote.lastExtraData=b}})};ModeratorVote.menuRequest=
new Request.AjaxIO("getModeratorVotes",{onSuccess:function(a){var b=new Element("div");b.set("html",a.html);a=b.getElement(".adminForce");null!=a&&(a.checked=ModeratorVote.adminForce);var d=$$(".answerToQuestion, .js-post-answer").length;b.getElements(".moderatorVote").each(function(a){if(!a.hasClass("disabledButton")){var b=a.get("data-docid"),c=a.get("data-doctype"),e=a.get("data-action"),k=a.get("data-cancel"),g=a.get("data-target"),m={doctype:c,docid:b,action:e,target_docid:null,questionid:ModeratorVote.questionid,
cancel:k};"posts"==c&&"accept_an_answer_vote"==e&&(m.target_docid=ModeratorVote.questionid);"false"==g||"true"==k||"posts"==c&&"switch_answer_to_comment_vote"==e&&1==d||"accept_an_answer_vote"==e?a.addEvent("click",function(a){a.stop();ModeratorVote.adminForce=m.adminForce=null!=$("adminForce")&&$("adminForce").checked;"posts"!=c||"switch_answer_to_comment_vote"!=e&&"accept_an_answer_vote"!=e||(m.target_docid=ModeratorVote.questionid);"true"==k?Modal.loading(_js("Canceling vote...")):Modal.loading(_js("Casting vote..."));
ModeratorVote.voteRequest.send(m)}):"posts"==c&&"switch_answer_to_comment_vote"==e&&1<d||"comments"==c&&"comment_to_update_vote"==e?a.addEvent("click",function(a){ModeratorVote.adminForce=m.adminForce=null!=$("adminForce")&&$("adminForce").checked;Modal.loading(_js("Loading..."));ModeratorVote.postPickerRequest.send(m)}):a.addEvent("click",function(a){a.stop();ModeratorVote.adminForce=null!=$("adminForce")&&$("adminForce").checked;Modal.loading(_js("Loading..."));ModeratorVote.targetRequest.send(c,
b,e)})}});Modal.doneLoading();ModeratorVote.doneLoading();Modal.open({type:"element",element:b})}});ModeratorVote.hideChoosePostLinks=function(){var a=$$(".qaEditControls"),b=$$(".choosePostLink"),d=$$(".cancelChoosePostLink");a.each(function(a){a.removeClass("hidden")});b.each(function(a){a.addClass("hidden")});d.each(function(a){a.addClass("hidden")})};ModeratorVote.postPickerRequest=new Request.AjaxIO("getTargetButtonInfo",{onSuccess:function(a){Modal.doneLoading();Modal.close();var b,d=$$(".qaEditControls"),
c=$$(".choosePostLink");$$(".cancelChoosePostLink");d.each(function(a){a.addClass("hidden")});$$(".cancelChoosePostLink").each(function(a){a.addEvent("click",function(a){a.stop();ModeratorVote.hideChoosePostLinks()})});c.each(function(d){var c=d.get("data-postid");b=a.buttonText;ModeratorVote.adminForce||(b+=" - ",null!=a.voteCounts[c]?b+=a.voteCounts[c]:b+="0",b+=" / "+a.threshold+" "+_js("Votes"));d.set("text",b);c!=a.docid||"posts"!=a.doctype?(d.removeClass("hidden"),d.removeEvents("click"),d.addEvent("click",
function(b){b.stop();b={target_docid:c,doctype:a.doctype,docid:a.docid,action:a.action,adminForce:ModeratorVote.adminForce,questionid:ModeratorVote.questionid};var e=d.getParent(".qaPost");ModeratorVote.showLoadingOnElement(e,_js("Casting vote..."));ModeratorVote.voteRequest.send(b)})):$("cancelChoosePostLink"+c).removeClass("hidden")})}});ModeratorVote.showLoadingOnElement=function(a,b,d){return null!=a&&(ModeratorVote.loading?ModeratorVote.loadingStatus.update(b,d):(ModeratorVote.loadingStatus=
new LoadingStatus(a),ModeratorVote.loadingStatus.loading(b,d)),ModeratorVote.loading=!0,ModeratorVote.lastLoadingElement=a,!0)};ModeratorVote.doneLoading=function(){return!!ModeratorVote.loading&&(ModeratorVote.loadingStatus.doneLoading(),ModeratorVote.loading=!1,!0)};ModeratorVote.setupLinkActions();var e=$("questionidSpan");ModeratorVote.questionid=null!=e?e.get("text"):null})},1775:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});FrameModules.add("MessageUserFrameModule",function(){c.initialize()});
var c=f.MessageUser=window.MessageUser={initialize:function(){this.messageModal=$("messageUserModal");this.messageForm=$("messageUserForm");this.messageRecipientUserid=$("messageRecipientUserid");this.messageRecipientName=$("messageRecipientName");this.messageRecipient=$("recipientName");this.messageSubject=$("messageSubject");this.messageBody=$("messageBody");this.messageCancel=$("messageCancel");this.messageUserButtons=$$(".messageUserButton");this.messageUserButtons.length&&(this.formManager=new FormManager(this.messageForm,
{jumpToErrors:!1,fixedPosition:!0}),this.formManager.required("messageSubject","messageBody"),this.formManager.addSubmitHandler(function(){return(new Request.AjaxIO("sendMessage",{onSuccess:function(b){StatusPanel.notify(b.message,2,{reload:!1})}})).send(this.messageRecipientUserid.value,this.messageSubject.value,this.messageBody.value),Modal.forceClose(),StatusPanel.loading(_js("Sending message..."),100,{reload:!1}),!1}.bind(this)),this.messageUserButtons.each(function(b){b.addEvent("click",function(a){a.stop();
Auth.required({message:_js("You must be logged in to send another user a message"),onAuthorize:function(){var a=b.get("data-recipient-userid"),d=b.get("data-recipient-name"),c=b.get("data-subject"),k=b.get("data-body");this.messageRecipientUserid.set("value",a);this.messageRecipientName.set("value",d);this.messageRecipient.set("text",d);c||(c="");this.messageSubject.set("value",c);k||(k="");this.messageBody.set("value",k);Modal.open({type:"element",element:this.messageModal,locked:!0})}.bind(this)})}.bind(this))}.bind(this)),
this.messageCancel.addEvent("click",function(b){b.stop();Modal.forceClose()}))}}},1776:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};FrameModules.add("GuidePublishFrameModule",function(){when($("sidebarGuidePublish"),function(a){new b})});var b=f.GuidePublish=window.GuidePublish=
new Class({ajaxSpinner:new Element("img",{src:window.shared_constants.BaseURI("SITE_IMAGE_AJAX_LOAD")}),initialize:function(){var a=this,b=this;this.form=document.id("sidebarGuidePublish");this.guideid=this.form.getProperty("data-guideid");this.guideTeamList=document.id("guideTeamList");this.teamListField=document.id("teamListField");this.guideUserList=document.id("guideUserList");this.userListField=document.id("userListField");this.userSearchInput=document.id("searchUsers");this.teamSearchInput=
document.id("searchTeams");this.userSearchSpinner=document.id("userSearchSpinner");this.teamSearchSpinner=document.id("teamSearchSpinner");this.userListMessage=document.id("userListMessage");App.noAvatarUrl||console.error("App.noAvatarUrl is not set.");this.userFinder=new UserFinder(this.userSearchInput,{indicator:this.userSearchSpinner,showReputation:!this.form.hasClass("noReputation"),onSelection:function(a,e,k){"object"===(void 0===a?"undefined":c(a))&&(a=a.retrieve("user"),(new Request.API_2_0("guides/"+
b.guideid+"/users/"+a.userid,{method:"put",statusPanelMessage:_js("Adding user to guide..."),onSuccess:function(a){b.renderUserList(a.users)}})).send())}});when(this.teamSearchInput,function(d){new TeamFinder(d,{indicator:a.teamSearchSpinner,onSelection:function(a){"object"===(void 0===a?"undefined":c(a))&&(a=a.retrieve("team"),b.addTeam(a.teamid))}})});this.publishToggle=new Button.Toggle("publishToggle",{callback:this.checkPrereqs.bind(this)});this.teamListField&&$$(".removeTeam").addEvent("click",
this.removeTeam.bind(this));this.userListField&&this.guideUserList.addEvent("click:relay(.removeUser)",function(a,c){a.stop();a=c.getProperty("data-userid");(new Request.API_2_0("guides/"+b.guideid+"/users/"+a,{method:"delete",statusPanelMessage:_js("Removing user from guide..."),onSuccess:function(a){b.renderUserList(a.users)}})).send()})},checkPrereqs:function(a){var b="private"===(a.target.get("data-value")?a.target:a.target.getParent("[data-value]")).get("data-value"),d=App.prereqs;b&&d.length?
this.showConfirmPrivateModal(a):this.publish(a)},showConfirmPrivateModal:function(a){var b=window.guideHbsTemplates("GUIDE_EDIT_CONFIRM_PRIVATE_MODAL_HBS"),d=this,c=1===App.prereqs.length?_js("Are you sure you want to make this guide private? The following guide will no longer be translatable:"):_js("Are you sure you want to make this guide private? The following guides will no longer be translatable:");b=b({prereqs:App.prereqs,description:c});Modal.open({type:"element",element:b,onCancel:function(){d.publishToggle.untoggle()}});
$$(".js-confirm-private-box .js-cancel-button").addEvent("click",Modal.cancel);$$(".js-confirm-private-box .js-confirm-private-button").addEvent("click",function(){Modal.close();d.publish(a)})},renderUserList:function(a){this.guideUserList.empty();a.length?this.userListMessage.removeClass("hidden"):this.userListMessage.addClass("hidden");a.each(function(a){var b=new Element("li");(new Element("img",{src:a.image&&a.image.mini?a.image.mini:App.noAvatarUrl,class:"pull-left"})).inject(b);var c=(new Element("div",
{class:"userDetails"})).inject(b),k=(new Element("h4")).inject(c);(new Element("a",{href:a.url,text:a.username})).inject(k);(new Element("p",{text:a.reputation+" "+_js("reputation"),class:"reputation"})).inject(c);a=(new Element("a",{"data-userid":a.userid,class:"removeUser"})).inject(c);(new Element("i",{class:"fa fa-times"})).inject(a);(new Element("div",{class:"clearer"})).inject(b);b.inject(this.guideUserList)})},buildAjaxSpinner:function(a){return(new Element("span",{class:"ajax-spinner "+a})).adopt(this.ajaxSpinner)},
publish:function(a){var b=this;a="public"==(a.target.get("data-value")?a.target:a.target.getParent("[data-value]")).get("data-value");var c=$$("[name\x3dintro[revisionid]]").pick(),e=null===c?App.guide_revisionid:c.get("value");$("publishField").adopt(b.buildAjaxSpinner("publish"));(new Request.API_2_0("guides/"+b.guideid+"/public?revisionid\x3d"+e,{method:a?"put":"delete",onFailure:function(a){var c=JSON.decode(a.response);$$(".ajax-spinner").dispose();var d=_js("An unexpected error occurred.");
c&&c.message&&(d=c.message);404===a.status?d=_js("Guide not found. Try reloading the page."):409===a.status&&(d=_js("Sorry, someone saved a new version of the introduction while you were editing it, so we couldn't save your changes. Reload the pages to load in the latest changes."));$("guidePublishErrors").grab(Utils.createAlert("error",d),"top");b.publishToggle.untoggle()},onSuccess:function(a){$$(".ajax-spinner").dispose();null!==c&&c.set("value",a.revisionid);App.guide_revisionid=a.revisionid;
App.guideApi&&(App.guideApi.revisionid=App.guide_revisionid);b.teamListField&&(a.public?(b.teamListField.hide(),b.userListField.hide()):(b.teamListField.show(),b.userListField.show()))}})).send(b.guideid,a)},removeTeam:function(a){a.stop();a=a.target.getParent("a");var b=a.getParent("li");a=a.getProperty("data-teamid");var c=this;(new Request.AjaxIO("removeGuideTeam",{onSuccess:function(a){$$(".ajax-spinner").hide();a.success?(a.forceRefresh&&window.location.reload(!0),TweenMax.to(b,.3,{height:0,
overflow:"hidden",onComplete:function(){b.dispose();0===c.guideTeamList.getChildren("li").length&&c.toggleDefaultText("noTeams")}})):b.inject(new Element("p",{html:_js("Error deleting team"),class:"error"}))}})).send(this.guideid,a,App.fromTab)},addTeam:function(a){var b=this;(new Request.AjaxIO("addGuideTeam",{onSuccess:function(a){var c=$("guideTeamList");c.set("html",a.html);c.getElements(".removeTeam").addEvent("click",b.removeTeam.bind(b));b.toggleDefaultText("yesTeams");$$(".ajax-spinner").hide()}})).send(this.guideid,
[a],App.fromTab)},toggleDefaultText:function(a){this.teamListField.getElements(".defaultText").addClass("hidden");this.teamListField.getElements(".defaultText."+a).removeClass("hidden")}})},1777:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});f.TeamFinder=window.TeamFinder=new Class({Extends:Autocompleter.Request.API_2_0,el:null,initialize:function(c,b){App.noAvatarUrl||console.error("App.noAvatarUrl is not set.");b=Object.merge({className:"blurb-finder",fxOptions:null,maxChoices:5,
delay:100,truncateText:!1,overflow:!1,injectChoice:this.injectChoice.bind(this)},b);this.el=c;this.maxChoices=b.maxChoices;this.parent(this.el,"teams/search",b);this.url=this.request.request.options.url;this.choices.addEvent("mousedown",function(a){a.stop()})},query:function(){this.toggleIndicator(!0);var c=Object.clone(this.options.getData)||{};this.request.request.options.url=this.url+"/"+this.queryValue+("?limit\x3d"+this.maxChoices);this.fireEvent("onRequest",[this.element,this.request,c,this.queryValue]);
this.request.send({data:c})},injectChoice:function(c){if(this.el.isDisplayed()){var b={team:c,imageUrl:c.imageUrl||App.noAvatarUrl,showImage:!0};b=window.hbsTemplates("TEAM_HBS")(b);b.store("team",c);b.inputValue="";this.addChoiceEvents(b).inject(this.choices)}}})},1778:function(l,f,h){Modal.addEvent("onGlossaryLoad",function(){clickSafe($("addWordButton"),function(){var c=$("bottomPortion"),b=$("exitModalButton"),a=$("newPhrase").get("text");a=a.substring(1,a.length-1);$("newPhrase").set("text",
_js("Working..."));$("spinner").set("src",window.shared_constants.BaseURI("SITE_IMAGE_MODAL_SPINNER"));$("addWordButton").toggle();$("topPortion").set("text","");b.toggle();c.toggle();var g=$("glossaryLink");(new Request.AjaxIO("sendWord",{onSuccess:function(d){b.set("text",_js("Exit"));b.toggle();$("newPhrase").set("text",a);$("spinner").destroy();$("topPortion").set("text",d.result);var e=_js("was not added to ");d.success&&(e=_js("was added to "));c.set("text",e);c.grab(g,"bottom");c.toggle()}})).send(a)});
clickSafe($("exitModalButton"),function(){Modal.close()})})},245:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});f.MooCrop=window.MooCrop=new Class({Implements:[Options,Events],calculateHandles:!0,current:{},options:{maskColor:"black",maskOpacity:".4",handleColor:"#999",handleBorder:"1px solid #333",handleWidth:"6px",handleHeight:"6px",cropBorder:"1px dashed #aaa",min:{width:60,height:45},start:{top:0,left:0,width:592,height:444},showMask:!0,showHandles:!1,ratio:"FOUR_THREE",container:{width:800,
height:600}},initialize:function(c,b){switch("ONE_ONE"==b.ratio?b.start.width=b.start.height:b.adjustRatio&&(b.start.top=b.start.left=0,b.start.height=b.min.height,b.start.width=b.min.width),b.ratio){case "FOUR_THREE":b.ratio=.75;break;case "ONE_ONE":b.ratio=1;break;default:b.ratio=!1}this.setOptions(b);b=this.options;c=this.img=$(c);b.min.width=Math.min(c.width,b.min.width);b.min.height=Math.min(c.height,b.min.height);this.resizeFunc=this.refresh.bind(this);this.removeFunc=this.removeListener.bind(this);
this.buildOverlay();this.setup()},setup:function(){$(this.cropArea).setStyles({width:this.options.start.width,height:this.options.start.height,top:this.options.start.top,left:this.options.start.left});this.current.crop=this.crop=this.getCropArea();this.handleWidthOffset=this.options.handleWidth.toInt()/2;this.handleHeightOffset=this.options.handleHeight.toInt()/2;this.fixBoxModel();this.drawMasks();this.positionHandles()},getCropArea:function(){var c=this.cropArea.getCoordinates();return c.left-=
this.offsets.x,c.right-=this.offsets.x,c.top-=this.offsets.y,c.bottom-=this.offsets.y,c},fixBoxModel:function(){var c=this.boxDiff=(this.crop.width-this.options.start.width)/2,b=this.bounds={top:c,left:c,right:this.img.width+2*c,bottom:this.img.height+2*c,width:this.options.min.width+2*c,height:this.options.min.height+2*c};this.wrapper.setStyles({width:b.right,height:b.bottom});this.img.setStyles({top:c,left:c});this.north.setStyle("width",b.right);this.south.setStyle("width",b.right)},activate:function(c,
b){b.stop();this.current={x:b.page.x,y:b.page.y,handle:c,crop:this.current.crop};"NESW"!=this.current.handle||this.options.showHandles||this.hideHandles();this.fireEvent("onBegin",[this.img.src,this.getCropInfo(),this.bounds,c]);document.addListener("mousemove",this.resizeFunc);document.addListener("mouseup",this.removeFunc)},removeListener:function(){"NESW"!=this.current.handle||this.options.showHandles||this.showHandles();document.removeListener("mousemove",this.resizeFunc);document.removeListener("mouseup",
this.removeFunc);this.crop=this.current.crop;this.fireEvent("onComplete",[this.img.src,this.getCropInfo(),this.bounds,this.current.handle])},refresh:function(c){var b=0,a=this.current.x-c.pageX,g=this.current.y-c.pageY;c=this.bounds;var d=this.crop,e=this.current.handle,k={},m=2<e.length;if(e.contains("S")&&d.bottom-g>c.bottom&&(g=d.bottom-c.bottom),e.contains("N")&&d.top-g<c.top&&(g=d.top),e.contains("E")&&d.right-a>c.right&&(a=d.right-c.right),e.contains("W")&&d.left-a<c.left&&(a=d.left),this.options.ratio&&
!m)if(Math.abs(a)>Math.abs(g)*this.options.ratio){var p=g="SE"==e||"NW"==e?Math.round(a*this.options.ratio):-Math.round(a*this.options.ratio);e.contains("S")&&d.bottom-g>c.bottom&&(g=d.bottom-c.bottom,b="SE"==e||"NW"==e?-1:1);e.contains("N")&&d.top-g<c.top&&(g=d.top,b="SE"==e||"NW"==e?-1:1);b&&(a+=b*Math.round((p-g)/this.options.ratio))}else b=0,p=a="SE"==e||"NW"==e?Math.round(g/this.options.ratio):-Math.round(g/this.options.ratio),e.contains("E")&&d.right-a>c.right&&(a=d.right-c.right,b="SE"==e||
"NW"==e?-1:1),e.contains("W")&&d.left-a<c.left&&(a=d.left,b="SE"==e||"NW"==e?-1:1),b&&(g+=b*Math.round((p-a)*this.options.ratio));e.contains("S")&&(m||(d.height-g<c.height&&(g=d.height-c.height),k.height=d.height-g));e.contains("N")&&(m||(d.height+g<c.height&&(g=c.height-d.height),k.height=d.height+g),k.top=d.top-g);e.contains("E")&&(m||(d.width-a<c.width&&(a=d.width-c.width),k.width=d.width-a));e.contains("W")&&(m||(d.width+a<c.width&&(a=c.width-d.width),k.width=d.width+a),k.left=d.left-a);b=Object.clone(k);
null!=k.width&&(k.width-=2*this.boxDiff);null!=k.height&&(k.height-=2*this.boxDiff);this.cropArea.setStyles(k);this.getCurrentCoords(b);this.drawMasks();this.positionHandles();this.fireEvent("onCrop",[this.img.src,this.getCropInfo(),c,e])},getCurrentCoords:function(c){var b=Object.clone(this.crop);null!=c.left&&(b.left=c.left,null!=c.width?b.width=c.width:b.right=b.left+b.width);null!=c.top&&(b.top=c.top,null!=c.height?b.height=c.height:b.bottom=b.top+b.height);null!=c.width&&null==c.left&&(b.width=
c.width,b.right=b.left+b.width);null!=c.height&&null==c.top&&(b.height=c.height,b.bottom=b.top+b.height);this.current.crop=b},drawMasks:function(){if(this.options.showMask){var c=this.bounds,b=this.current.crop;this.current.handle;this.north.setStyle("height",b.top);this.south.setStyle("height",c.bottom-b.bottom);this.east.setStyles({height:b.height,width:c.right-b.right,top:b.top,left:b.right});this.west.setStyles({height:b.height,width:b.left,top:b.top})}},positionHandles:function(){if(this.calculateHandles){var c=
this.current.crop,b=this.handleWidthOffset+this.bounds.left,a=this.handleHeightOffset+this.bounds.top;this.options.ratio||(this.handles.get("N").setStyles({left:c.width/2-b,top:-a}),this.handles.get("E").setStyles({left:c.width-b,top:c.height/2-a}),this.handles.get("S").setStyles({left:c.width/2-b,top:c.height-a}),this.handles.get("W").setStyles({left:-b,top:c.height/2-a}));this.handles.get("NE").setStyles({left:c.width-b,top:-a});this.handles.get("SE").setStyles({left:c.width-b,top:c.height-a});
this.handles.get("SW").setStyles({left:-b,top:c.height-a});this.handles.get("NW").setStyles({left:-b,top:-a})}},hideHandles:function(){this.calculateHandles=!1;this.handles.each(function(c){c.setStyle("display","none")})},showHandles:function(){this.calculateHandles=!0;this.positionHandles();this.handles.each(function(c){c.setStyle("display","block")})},buildOverlay:function(){var c=this.options;if(this.wrapper=(new Element("div",{styles:{position:"relative",width:this.img.width,height:this.img.height,
float:this.img.getStyle("float"),"margin-left":Math.round((c.container.width-this.img.width)/2)}})).inject(this.img,"before"),this.wrapper.grab(this.img),this.img.setStyle("position","absolute"),this.offsets={x:this.wrapper.getLeft(),y:this.wrapper.getTop()},this.options.showMask){var b={left:0,position:"absolute",overflow:"hidden","background-color":c.maskColor,opacity:c.maskOpacity};this.north=(new Element("div",{styles:b})).inject(this.wrapper,"inside");this.south=(new Element("div",{styles:Object.merge(b,
{bottom:0})})).inject(this.wrapper,"inside");this.east=(new Element("div",{styles:b})).inject(this.wrapper,"inside");this.west=(new Element("div",{styles:b})).inject(this.wrapper,"inside")}this.cropArea=(new Element("div",{styles:{position:"absolute",top:0,left:0,border:c.cropBorder,cursor:"move"},events:{dblclick:function(){this.fireEvent("onDblClk",[this.img.src,this.getCropInfo(),this.bounds])}.bind(this),mousedown:this.activate.bind(this,"NESW")}})).inject(this.wrapper,"inside");this.handles=
new Hash;(this.options.ratio?["NE","SE","SW","NW"]:"N NE E SE S SW W NW".split(" ")).each(function(a){this.handles.set(a,(new Element("div",{styles:{position:"absolute","margin-left":-1,"margin-top":-1,"background-color":c.handleColor,border:c.handleBorder,width:c.handleWidth,height:c.handleHeight,overflow:"hidden",cursor:a.toLowerCase()+"-resize"},events:{mousedown:this.activate.bind(this,a)}})).addClass("cropHandle").inject(this.cropArea,"inside"))},this)},getCropInfo:function(){var c=Object.clone(this.current.crop);
return c.width-=2*this.boxDiff,c.height-=2*this.boxDiff,c},removeOverlay:function(){this.wrapper.destroy();this.img.setStyle("display","block")},setImage:function(c){this.img.src=c;this.wrapper.setStyle("background","url("+this.img.src+") no-repeat "+this.boxDiff+"px "+this.boxDiff+"px")}})},246:function(l,f,h){FrameModules.add("ImageCropFrameModule",function(){Modal.addEvents({onImageCropLoad:function(a,b,c){ImageCrop.initialize(a,b,c)},onImageCropDisplay:function(a){ImageCrop.display(a)},onImageCropUnload:function(){ImageCrop._unload()}});
window.ImageCrop={thumb:{width:592,height:444},options:{min:{width:50,height:50}},dimensions:{},events:null,showForMediaItem:function(a,b,c){b=b&&b.getMediaFilterName();"guide_step_video"==b&&(b="guide_step_image");Modal.open({type:"module",name:"ImageCrop",boxClass:"mediaLibraryModalBox cropContainer",serverOptions:{imageid:a.getID(),accepts:b},clientOptions:{mediaItem:a,mediaItemFilterName:b,events:{complete:function(a){c&&c(a)}}}})},initialize:function(a,g,d){this.events=new Events;this.events.addEvents(g.events);
this.mediaImage=g.mediaItem;this.sourceImageData=new MediaItemData(d.sourceImage);this.suggestedCrop=d.suggestedCrop;this.imageData=new MediaItemData(d.image);this.mediaImage.setData(this.imageData);a=this.filter=new c(d.filterInfo);a.width()&&(this.options.min={width:a.width(),height:a.height()});this.clientOptions=g||{};this.mediaImage.data;this.container=$("imageCropContainer");new b(this.events,$(document));this.addClickEvents();this.attachImage(this.sourceImageData)},display:function(){this.cropper||
this.createCropper(this.sourceImageData)},addClickEvents:function(){$("imageCropButton").removeEvents().addEvent("click",function(){this.save()}.bind(this));clickSafe($("cropCloseBtn"),function(){Modal.cancel()})},attachImage:function(a){var b=this.mediaImage.getUncroppedPreview("medium");b=new Element("img",{src:b,class:"img"});b.set({id:"cropImage"}).setStyles({width:a.scaled_width(),height:a.scaled_height()});this.container.empty().adopt(b);this.updateDimensions({original_width:a.width(),original_height:a.height()});
this.container.setStyles({height:a.scaled_height()})},createCropper:function(a){function b(b){var c=Math.round(l*b.top),d=Math.round(l*b.left),e=Math.round(l*b.width);b=Math.round(l*b.height);"FOUR_THREE"==n&&(b=.75*(e-=e%4),(e<p.options.min.width||b<p.options.min.height)&&(e=p.options.min.width,b=p.options.min.height));"ONE_ONE"==n&&(b=e=Math.min(e,b));e>a.width()&&(d=0,e=a.width());b>a.height()&&(c=0,b=a.height());p.updateDimensions({top:c,left:d,width:e,height:b})}var c,e,k,m,p=this,q=this.imageData,
f=a.scaled_width(),h=a.scaled_height();(q=(q=this.suggestedCrop||q.markup())?q.crop:null)?(c=q.size.width,e=q.size.height,k=q.from.y,m=q.from.x):(c=a.width(),e=a.height(),k=0,m=0);this.updateDimensions({top:k,left:m,width:c,height:e});var l=a.width()/f,n=this.filter.ratio();this.cropper=(new MooCrop("cropImage",{container:this.thumb,start:{width:Math.round(c/a.width()*f),height:Math.round(e/a.height()*h),top:Math.round(k/a.height()*h),left:Math.round(m/a.width()*f)},min:{width:Math.ceil(this.options.min.width/
a.width()*f),height:Math.ceil(this.options.min.height/a.height()*h)},ratio:n,adjustRatio:"FOUR_THREE"==n&&.05<Math.abs(.75-e/c)})).addEvent("onCrop",function(a,c){b(c)});b(this.cropper.getCropInfo())},updateDimensions:function(a){Object.append(this.dimensions,a);this.events.fireEvent("changeDimensions",[this.dimensions])},getMarkupString:function(){var a=this.getMarkup();return";"+("crop,"+a.crop.from.x+"x"+a.crop.from.y+","+a.crop.size.width+"x"+a.crop.size.height+";"+(a.enhance?"enhance;":""))+
this.mediaImage.markersString()},getMarkup:function(){var a=this.dimensions,b={};return b.crop={from:{x:a.left,y:a.top},size:{width:a.width,height:a.height}},b},save:function(){function a(a){a.error?b(a.error):m.resolve(a)}function b(a){m.error(a)}var c=this,e=this.mediaImage,k=this.getMarkupString(),m=new Future;Modal.lock().loading(_js("Saving your changes..."));(new Request.AjaxIO("cropImage",{onSuccess:function(d){e.setDataPromise(m);c._finished(c.mediaItem);(new Request.AjaxIO("cropImageStatus",
{timeout:6E4,onComplete:a,onTimeout:b})).ping(d,!0,c.clientOptions.mediaItemFilterName);Modal.doneLoading().unlock().pop()}.bind(this)})).send(e.getID(),k,this.filter.ratio())},_unload:function(){this.cropper&&(this.cropper.removeEvents(),this.cropper=null);this._finished()},_finished:function(a){this.events&&(this.events.fireEvent("complete",a?[a]:null),delete this.events)}};Object.append(ImageCrop,Utils.EventsFunctions);var c=StrictObject.define(["ratio","width","height"]),b=new Class({initialize:function(a,
b){var c={top:b.getElement(".image_top"),left:b.getElement(".image_left"),width:b.getElement(".image_width"),height:b.getElement(".image_height"),original_width:b.getElement(".original_width"),original_height:b.getElement(".original_height")};a.addEvent("changeDimensions",function(a){Object.each(a,function(a,b){c[b].set("html",a)})})}})})},247:function(l,f,h){h(12)(h(248))},248:function(l,f){l.exports="/*!\n  FileDrop Revamped - HTML5 \x26 legacy file upload\n  in public domain  | http://filedropjs.org\n  by Proger_XP      | http://proger.me\n\n  Supports IE 6+, FF 3.6+, Chrome 7+, Safari 5+, Opera 11+.\n  Fork \x26 report problems at https://github.com/ProgerXP/FileDrop\n*/\n\n;(function (root, init) {\n  if (typeof define \x3d\x3d 'function' \x26\x26 define.amd) {\n    define(['exports'], function (exports) { init(root, exports) })\n  } else if (typeof exports !\x3d\x3d 'undefined') {\n    init(root, exports)\n  } else {\n    init(root, root.fd \x3d root.fd || {})\n  }\n})(this, function (root, global) {\n  /***\n    Global Utility Functions\n   ***/\n\n  // Produces random ID (non necessary unique to anything) with given prefix\n  // or 'fd' if it's not passed.\n  //\n  //? randomID()        //\x3d\x3e 'fd_9854'\n  //? randomID('foo')   //\x3d\x3e 'foo_1582'\n  global.randomID \x3d function (prefix) {\n    return (prefix || 'fd') + '_' + (Math.random() * 10000).toFixed()\n  }\n\n  // Generates random DOM node ID that's unique to this document with given prefix\n  // or 'fd' if it's not passed.\n  //\n  //? randomID()        //\x3d\x3e 'fd_9854'\n  //? randomID('foo')   //\x3d\x3e 'foo_1582'\n  global.uniqueID \x3d function (prefix) {\n    do { var id \x3d global.randomID(prefix) } while (global.byID(id))\n    return id\n  }\n\n  // Retrieves DOM element by its ID attribute or returns id itself if it's\n  // an element.\n  //\n  //? byID('foo')       //\x3d\x3e \x3cp id\x3d\"foo\"\x3e\n  //? byID('abracadabra!')  //\x3d\x3e null\n  //? byID({foo: 1})    //\x3d\x3e null\n  //? byID(null)        //\x3d\x3e null\n  //\n  //? byID(document.createElement('p'))\n  //    //\x3d\x3e \x3cp\x3e\n  global.byID \x3d function (id) {\n    return global.isTag(id) ? id : document.getElementById(id)\n  }\n\n  // Checks if given object is a proper DOM node. If tag is passed also\n  // checks if that DOM node is of the same tag (case-insensitive).\n  // Returns true or false.\n  //\n  //? isTag('foo')        //\x3d\x3e false\n  //? isTag({foo: 1})     //\x3d\x3e false\n  //? isTag(null)         //\x3d\x3e false\n  //? isTag(window)       //\x3d\x3e false\n  //? isTag(document.body)          //\x3d\x3e true\n  //? isTag(document.body, 'BoDy')  //\x3d\x3e true\n  //? isTag(document.body, 'head')  //\x3d\x3e false\n  //\n  //? var el \x3d byID('foo')    //\x3d\x3e \x3cp id\x3d\"foo\"\x3e\n  //  isTag(el, 'p')    //\x3d\x3e true\n  //  isTag(el, 'P')    //\x3d\x3e true\n  //  isTag(el, 'div')  //\x3d\x3e false\n  //  isTag(el, 'DiV')  //\x3d\x3e false\n  //\n  //? isTag(document.createElement('p'))\n  //    //\x3d\x3e true\n  //\n  //? isTag(document.createElement('p'), 'div')\n  //    //\x3d\x3e false\n  global.isTag \x3d function (element, tag) {\n    return typeof element \x3d\x3d 'object' \x26\x26 element \x26\x26 element.nodeType \x3d\x3d 1 \x26\x26\n           ( !tag || element.tagName.toUpperCase() \x3d\x3d tag.toUpperCase() )\n  }\n\n  // Creates new XMLHttpRequest object. Falls back for ActiveX for IE 6.\n  // Throws an exception if couldn't succeed (this shouldn't happen these days).\n  //\n  //? newXHR()    //\x3d\x3e XMLHttpRequest\n  global.newXHR \x3d function () {\n    try {\n      return new XMLHttpRequest\n    } catch (e) {\n      // IE 6.\n      var activex \x3d ['MSXML2.XMLHTTP.6.0', 'MSXML2.XMLHTTP.5.0',\n                     'MSXML2.XMLHTTP.4.0', 'MSXML2.XMLHTTP.3.0',\n                     'MSXML2.XMLHTTP', 'Microsoft.XMLHTTP']\n\n      for (var i \x3d 0; i \x3c activex.length; i++) {\n        try {\n          return new ActiveXObject(activex[i])\n        } catch (e) {}\n      }\n    }\n\n    throw 'Cannot create XMLHttpRequest.'\n  }\n\n  // Checks if given value is a native Array object. Note that jQuery and\n  // other pseudo-arrays are reported as false.\n  //\n  //? isArray([])       //\x3d\x3e true\n  //? isArray([])       //\x3d\x3e true\n  //? isArray(new Array)    //\x3d\x3e true\n  //? isArray({})       //\x3d\x3e false\n  //? isArray('foo')    //\x3d\x3e false\n  //? isArray(null)     //\x3d\x3e false\n  //? isArray($('a'))   //\x3d\x3e false\n  //? isArray(arguments)    //\x3d\x3e false\n  //? isArray($('a').toArray())   //\x3d\x3e true\n  global.isArray \x3d function (value) {\n    return Object.prototype.toString.call(value) \x3d\x3d\x3d '[object Array]'\n  }\n\n  // Converts passed value into an array. If value is already an array its\n  // copy is returned (so changing value later doesn't affect the returned\n  // clone).\n  //\n  // skipFirst, if given, omits specified number of elements from the start.\n  // Useful for turning arguments into arrays.\n  //\n  //? toArray([])           //\x3d\x3e [] (copy)\n  //? toArray(['foo'])      //\x3d\x3e ['foo'] (copy)\n  //? toArray(['foo'], 1)   //\x3d\x3e []\n  //? toArray(['foo'], 999)   //\x3d\x3e []\n  //? toArray('foo')        //\x3d\x3e ['foo']\n  //? toArray('foo', 1)     //\x3d\x3e []\n  //? toArray('foo', 999)   //\x3d\x3e []\n  //? toArray({foo: 1})     //\x3d\x3e [{foo: 1}]\n  //? toArray({foo: 1}, 1)  //\x3d\x3e []\n  //? toArray(null)         //\x3d\x3e []\n  //? toArray(new Array('foo', 'bar'))      \x3d\x3e ['foo', 'bar'] (copy)\n  //? toArray(new Array('foo', 'bar'), 1)   \x3d\x3e ['bar']\n  //? toArray(new Array('foo', 'bar'), 2)   \x3d\x3e []\n  //\n  //? function showMessage(func, line1, line2, ...) {\n  //    window[func](toArray(arguments, 1).join('\\n'))\n  //  }\n  //\n  //  showMessage('confirm', 'It\\'s first line.', 'Second line.')\n  //    //\x3d\x3e confirm('It\\'s first line.\\nSecond line.')\n  //\n  //  showMessage('alert', 'First', 'Second')\n  //    //\x3d\x3e alert('First\\nSecond')\n  global.toArray \x3d function (value, skipFirst) {\n    if (value \x3d\x3d\x3d null || typeof value \x3d\x3d 'undefined') {\n      return []\n    } else if (!global.isArray(value) \x26\x26 (typeof value !\x3d 'object' || !('callee' in value))) {\n      // Made sure it's not 'arguments'.\n      value \x3d [value]\n    }\n\n    return Array.prototype.slice.call(value, skipFirst || 0)\n  }\n\n  // Adds an event listener to a DOM element. Works for old IE as well\n  // as modern W3C-compliant browsers. type is short event name (without\n  // 'on' prefix). Does nothing if any parameter is invalid.\n  // Returns the DOM element itself or whatever was given as this argument.\n  //\n  //? addEvent(byID('p'), 'mousemove', function () { alert('Whoosh!') })\n  //? addEvent(window, 'load', function () { alert('Done loading.') })\n  //\n  //? addEvent(null, 'blur', function () { })   // nothing.\n  //? addEvent(window, null, function () { })   // nothing.\n  //? addEvent(window, 'blur', null)            // nothing.\n  //\n  //? addEvent(window, 'nonstandard', function () { })\n  //      // works.\n  global.addEvent \x3d function (element, type, callback) {\n    if (element \x26\x26 type \x26\x26 callback) {\n      if (element.attachEvent) {\n        element['e' + type + callback] \x3d callback\n        element[type + callback] \x3d function() {\n          element['e' + type + callback](window.event)\n        }\n        element.attachEvent('on' + type, element[type + callback])\n      } else {\n        element.addEventListener(type, callback, false)\n      }\n    }\n\n    return element\n  }\n\n  // Stops propagation and default browser action of an event.\n  // Works for old IE and modern W3C-compliant browsers.\n  //\n  //? byID('p').onmousemove \x3d function (e) { stopEvent(e) }\n  global.stopEvent \x3d function (event) {\n    event.cancelBubble \x3d true\n    event.returnValue \x3d false\n    event.stopPropagation \x26\x26 event.stopPropagation()\n    event.preventDefault \x26\x26 event.preventDefault()\n    return event\n  }\n\n  // Adds or removes HTML class of a DOM element. Keeps old classes.\n  // element can be either ID string or a DOM node.\n  // Returns the element (even if ID was passed) or null if passed value\n  // is neither a string nor a DOM node or if there's no element with\n  // this ID.\n  //\n  //? setClass(byID('p'), 'foo')      //\x3d\x3e \x3cp class\x3d\"... foo\"\x3e\n  //? setClass(byID('p'), 'foo', true)  // equivalent to above\n  //? setClass(byID('p'), 'foo', false)   //\x3d\x3e \x3cp class\x3d\"...\"\x3e (no 'foo')\n  //? setClass('anID', 'foo')         //\x3d\x3e \x3ca id\x3d\"anID\" class\x3d\"... foo\"\x3e\n  //? setClass('anID', 'foo', false)  //\x3d\x3e \x3ca\x3e without 'foo' class\n  //?\n  global.setClass \x3d function (element, className, append) {\n    if ((element \x3d global.byID(element)) \x26\x26 className !\x3d null) {\n      if (typeof append !\x3d 'undefined' \x26\x26 !append) {\n        element.className \x3d element.className.replace(global.classRegExp(className), ' ')\n      } else if (!global.hasClass(element, className)) {\n        element.className +\x3d ' ' + className\n      }\n    }\n\n    return element\n  }\n\n  // Determines if given element has class attribute containing the className\n  // word. Accepts DOM element or ID string. Returns true or false.\n  // Examples below refer to \x3cp class\x3d\"cls1 cls2\" id\x3d\"anID\"\x3e\n  //\n  //? hasClass(byID('anID'), 'cls1')  //\x3d\x3e true\n  //? hasClass('anID', 'cls1')        // equivalent to above\n  //? hasClass('anID', 'cls')         //\x3d\x3e false\n  //? hasClass('anID', 'foo')         //\x3d\x3e false\n  //? hasClass('abra!', 'cls1')       //\x3d\x3e false (no such element)\n  //? hasClass('anID', '')            //\x3d\x3e false (empty class)\n  //? hasClass('anID', null)          //\x3d\x3e false\n  //? hasClass('anID', {foo: 1})      //\x3d\x3e false (not a string)\n  //? hasClass(null, 'foo')           //\x3d\x3e false\n  //? hasClass({foo: 1}, 'foo')       //\x3d\x3e false (not a DOM node)\n  //? hasClass(window, foo)           //\x3d\x3e false\n  global.hasClass \x3d function (element, className) {\n    return global.classRegExp(className).test( (global.byID(element) || {}).className )\n  }\n\n  // Returns a regular expression suitable for testing of HTML class-like\n  // strings to find out if it contains a given word or not (it's not as\n  // simple as a substring match: 'some class' contains words 'some' and\n  // 'class' but not 'som' and 'cl' or 'ame' and 'ass').\n  //\n  // Shouldn't be used for testing multiple words (space-separated) - will\n  // only match if they are in the same position in testing string which\n  // doesn't have to be true: classRegExp('some class') would match\n  // 'this is some class' but won't match 'some of the class'.\n  //\n  // Returns a never matching regexp for bad parameter like object or an\n  // empty string.\n  //\n  //? classRegExp('foo')        //\x3d\x3e RegExp /(^|\\s+)foo(\\s+|$)/ig\n  //? classRegExp('x').test('x y z')  //\x3d\x3e true\n  //? classRegExp('foo bar')    // works but not advised\n  //? classRegExp({foo: 1})     //\x3d\x3e RegExp /$o_O/\n  //? classRegExp(null)         // the same as above\n  //? classRegExp(window)       // the same as above\n  //? classRegExp(null).test('foo')  //\x3d\x3e false (always)\n  global.classRegExp \x3d function (className) {\n    if (className \x3d\x3d '' || typeof className \x3d\x3d 'object') {\n      return /$o_O/  // never matches.\n    } else {\n      return new RegExp('(^|\\\\s+)' + className + '(\\\\s+|$)', 'gi')\n    }\n  }\n\n  // Copies properties from object base to object child. If overwrite\n  // is passed and true then base's properties will replace those\n  // in child even if child has its own properties of that name.\n  // Note that it doesn't clone child, it's edited in-place.\n  // Also note that defined properties that are 'undefined' on child are\n  // replaced by base's even if overwrite is false (see examples).\n  //\n  // Returns the modified child (first argument).\n  //\n  //? extend({common: 1, child: false}, {common: 'foo', base: true})\n  //    //\x3d\x3e {common: 1, child: false, base: true}\n  //\n  //? extend({common: 1, child: false}, {common: 'foo', base: true}, true)\n  //    //\x3d\x3e {common: 'foo', child: false, base: true}\n  //\n  //? extend({x: undefined}, {x: 1})    //\x3d\x3e {x: 1}\n  //? extend({x: null}, {x: 1})         //\x3d\x3e {x: null}\n  //\n  //? var child \x3d {y: 1}\n  //  extend(child, {x: 1}) \x3d\x3d\x3d child   //\x3d\x3e true (same object)\n  //  console.dir(child)    //\x3d\x3e {y: 1, x: 1}\n  global.extend \x3d function (child, base, overwrite) {\n    child \x3d child || {}\n    base \x3d base || {}\n\n    for (var prop in base) {\n      if (overwrite || typeof child[prop] \x3d\x3d 'undefined') {\n        child[prop] \x3d base[prop]\n      }\n    }\n\n    return child\n  }\n\n  /***\n    Event Manipulation Functions\n   ***/\n\n  // Calls every handler of the passed callback list with given arguments\n  // and in context of obj or 'this' if it's omitted.\n  //\n  // list can be undefined, a single function or an array (non-function members\n  // are skipped). Throws exception if list is something else.\n  // args is converted to array with toArray() so it can be a single value,\n  // an arguments object or something else - see that function for info.\n  //\n  // Returns result of the last called function. If any function returns\n  // a non-null and non-undefined value all following handlers are skipped.\n  //\n  //? callAll(function (a) { return a + 'foo' }, 'arg1')\n  //    //\x3d\x3e 'arg1foo'\n  //? callAll([ function () { } ], ['arg1'])\n  //    // equivalent to above\n  //\n  //? var list \x3d [function (a) { return a[0] \x3d\x3d 'a' ? a + 'foo' : null },\n  //              function (a) { alert(a) }]\n  //  callAll(list, 'arg1')   //\x3d\x3e 'arg1foo' (first handler)\n  //  callAll(list, 'foo')    //\x3d\x3e alert('foo') (second handler)\n  //\n  //? callAll(function () { alert(this.x) }, [], {x: 'foo'})\n  //    //\x3d\x3e alert('foo')\n  //\n  //? callAll(function () { alert(this.x) }).call({x: 'foo'})\n  //    // equivalent to above\n  //\n  //? window.onload \x3d function () {\n  //    callAll([...], arguments, window)\n  //      // equivalent to callAll([...], toArray(arguments), window)\n  //  }\n  global.callAll \x3d function (list, args, obj) {\n    var res\n    args \x3d global.toArray(args)\n    typeof list \x3d\x3d 'function' \x26\x26 (list \x3d [list])\n\n    if (global.isArray(list)) {\n      for (var i \x3d 0; i \x3c list.length; i++) {\n        if (typeof list[i] \x3d\x3d 'function') {\n          res \x3d list[i].apply(obj || this, args)\n          if (res !\x3d null) { break }\n        }\n      }\n    } else if (list) {\n      throw 'FileDrop event list must be either an Array, Function, undefined or' +\n            ' null but ' + (typeof list) + ' was given.'\n    }\n\n    return res\n  }\n\n  // Calls event handlers attached on given FileDrop object to passed\n  // event name with arguments. Hands off most work to callAll().\n  // obj is an object with the 'events' property (object with keys \x3d event\n  // names and values \x3d arrays of functions).\n  //\n  // Before calling handlers of obj looks if global configuration has\n  // a preview handler specified - if it does then calls that handler\n  // and if it returns non-null and non-undefined value doesn't call\n  // obj's handlers but returns that value immediately. After the global\n  // preview function it checks for object-wise preview - its 'any' event\n  // handlers which are treated likewise.\n  // Preview functions are called with event name pushed in front of\n  // the other event args.\n  //\n  //? var obj \x3d {events: { foo: [function (a) { alert(a); return true }] }}\n  //  callAllOfObject(obj, 'foo', 'arg1')   //\x3d\x3e true after alert('arg1')\n  //\n  //? window.fd.onObjectCall \x3d function (e) { alert(e + ': tee hee'); return false }\n  //  var obj \x3d ...   // as above\n  //  callAllOfObject(obj, 'foo', 'arg1')   //\x3d\x3e false after alert('foo: tee hee')\n  //\n  //? var obj \x3d {events: { any: [function (e) { return false }] }}\n  //  callAllOfObject(obj, 'anyevent')\n  //    // because of the object-wise preview handler that returns false\n  //    // any event we call will return false bypassing its actual handlers.\n  global.callAllOfObject \x3d function (obj, event, args) {\n    if (global.logging \x26\x26 global.hasConsole) {\n      var handlers \x3d obj.events[event] ? obj.events[event].length || 0 : 0\n      console.info('FileDrop ' + event + ' event (' + handlers + ') args:')\n      console.dir([args])\n    }\n\n    var preview \x3d [global.onObjectCall].concat(obj.events.any)\n    var res \x3d global.callAll(preview, [event].concat(global.toArray(args)), obj)\n    return res !\x3d null ? res : global.callAll(obj.events[event], args, obj)\n  }\n\n  // Appends event listeners to given object with 'events' property according\n  // to passed parameters. See DropHandle.event() for details.\n  // 'this' must be set to the object which events are updated.\n  global.appendEventsToObject \x3d function appendEventsToObject(events, funcs) {\n    if (global.addEventsToObject(this, false, arguments)) {\n      return this\n    }\n\n    switch (arguments.length) {\n    case 0:\n      return global.extend({}, this.events)\n\n    case 1:\n      if (events \x3d\x3d\x3d null) {\n        this.events \x3d {}\n        return this\n      } else if (global.isArray(events)) {\n        var res \x3d {}\n\n        for (var i \x3d 0; i \x3c events.length; i++) {\n          res[events[i]] \x3d global.toArray(this.events[events[i]])\n        }\n\n        return res\n      } else if (typeof events \x3d\x3d 'function') {\n        return global.funcNS(events)\n      } else if (typeof events \x3d\x3d 'string') {\n        return global.toArray(this.events[events])\n      }\n\n    case 2:\n      events \x3d global.toArray(events)\n\n      if (funcs \x3d\x3d\x3d null) {\n        for (var i \x3d 0; i \x3c events.length; i++) {\n          var ns \x3d global.splitNS(events[i])\n\n          if (!ns[0]) {\n            for (var event in this.events) {\n              appendEventsToObject.call(this, [event + ':' + ns[1]], null)\n            }\n          } else if (!ns[1]) {\n            this.events[ns[0]] \x3d []\n          } else if (this.events[ns[0]]) {\n            for (var fi \x3d this.events[ns[0]].length - 1; fi \x3e\x3d 0; fi--) {\n              if (global.funcNS( this.events[ns[0]][fi] ) \x3d\x3d ns[1]) {\n                this.events[ns[0]].splice(fi, 1)\n              }\n            }\n          }\n        }\n\n        return this\n      }\n    }\n\n    throw 'Bad parameters for FileDrop event().'\n  }\n\n  // Prepends event listeners to given object with 'events' property according\n  // to passed parameters. See DropHandle.event() for details.\n  // 'this' must be set to the object which events are updated.\n  global.previewToObject \x3d function (events, funcs) {\n    if (global.addEventsToObject(this, true, arguments)) {\n      return this\n    } else {\n      throw 'Bad parameters for FileDrop preview().'\n    }\n  }\n\n  // Adds event listeners to given object with 'events' property according\n  // to passed parameters. See DropHandle.event() for details.\n  // Returns nothing if couldn't handle given parameter combination.\n  global.addEventsToObject \x3d function addEventsToObject(obj, prepend, args) {\n    var events \x3d args[0]\n    var funcs \x3d args[1]\n\n    switch (args.length) {\n    case 1:\n      if (events \x26\x26 typeof events \x3d\x3d 'object' \x26\x26 !global.isArray(events)) {\n        for (var event in events) {\n          addEventsToObject(obj, prepend, [event, events[event]])\n        }\n\n        return true\n      }\n\n    case 2:\n      if (typeof funcs \x3d\x3d 'function' || global.isArray(funcs)) {\n        events \x3d global.toArray(events)\n        funcs \x3d global.toArray(funcs)\n        var pusher \x3d prepend ? 'unshift' : 'push'\n\n        for (var i \x3d 0; i \x3c events.length; i++) {\n          var ns \x3d global.splitNS(events[i])\n          for (var fi \x3d 0; fi \x3c funcs.length; fi++) {\n            global.funcNS(funcs[fi], ns[1])\n          }\n\n          obj.events[ns[0]] \x3d obj.events[ns[0]] || []\n          obj.events[ns[0]][pusher].apply(obj.events[ns[0]], funcs)\n        }\n\n        return true\n      }\n    }\n  }\n\n  // Adds namespace identifier to a Function object. Used when labeling event\n  // listeners in DropHandle.event(). If given just one parameter reads\n  // attached namespace, if present.\n  //\n  //? funcNS(function () { }, 'foo')\n  //? funcNS(function () { })   //\x3d\x3e 'foo'\n  global.funcNS \x3d function (func, ns) {\n    if (typeof func !\x3d 'function') {\n      return func\n    } else if (arguments.length \x3d\x3d 1) {\n      return (func[global.nsProp] || '').toString()\n    } else {\n      func[global.nsProp] \x3d (ns || '').toString()\n      return func\n    }\n  }\n\n  // Extracts namespace identifier from the string. Uses jQuery notation:\n  // 'event:namespace'. Both parts can be empty. If colon is omitted returns\n  // '' instead of namespace.\n  // Returns array with two items - event name (or other prefix) and namespace.\n  //\n  //? splitNS('')       //\x3d\x3e ['', '']\n  //? splitNS(null)     // identical to above\n  //? splitNS(':')      // identical to above\n  //? splitNS('x:')     //\x3d\x3e ['x', '']\n  //? splitNS(':y')     //\x3d\x3e ['', 'y']\n  //? splitNS('x:y')    //\x3d\x3e ['x', 'y']\n  //? splitNS('x:y:z')  //\x3d\x3e ['x', 'y:z']\n  global.splitNS \x3d function (str) {\n    return (str || '').match(/^([^:]*):?(.*)$/).slice(1)\n  }\n\n  /***\n    Global Configuration\n   ***/\n\n  global.extend(global, {\n    // If set all event calls will be logged to console if one is present.\n    logging: true,\n\n    // Indicates if console.log and console.dir are available for usage.\n    hasConsole: 'console' in window \x26\x26 console.log \x26\x26 console.dir,\n\n    // If set must be a function that's called on every event being fired.\n    // See how it works in callAllOfObject().\n    onObjectCall: null,\n\n    // All DropHandle objects that were instantinated on this page.\n    // Note that these are not FileDrop instances as not all DropHandles\n    // might be part of FileDrops. Use DropHandle.filedrop property.\n    all: [],\n\n    // Tests for IE versions, must be true for 6-7/9 and below and\n    // false for any other version/browser.\n    // IE 6 on XP SP 3 gives JScript version 5.7 while IE 8 - 5.8.\n    // IE 9 on Win7 gives 9.\n    isIE6: /\\bMSIE 6/.test(navigator.userAgent),\n    isIE9: /\\bMSIE 9/.test(navigator.userAgent),\n\n    // Test for Google Chrome. This isn't used to determine available\n    // File API but only to work around certain event glitches.\n    isChrome: (navigator.vendor || '').indexOf('Google') !\x3d -1,\n\n    // Name of Function object property where event namespace is stored.\n    // See funcNS(), splitNS(), DropHandle.event().\n    nsProp: '_fdns'\n  })\n\n  /***\n    Basic Drop Handle Class\n   ***\n\n    Has some file upload functionality (mostly legacy \x3ciframe\x3e) but is mainly\n    used to handle all drag \x26 drop operations in a cross-browser way.\n    You can use it as a basis for your own component.\n    Main FileDrop class extends it and listens for produced drop events.\n   ***/\n\n  // Parameters:\n  // * zone - ID or DOM element which accepts drag \x26 drop. This is often a\n  //          \x3cfieldset\x3e. If such element doesn't exist an exception is thrown\n  //          when trying to create the class. DropHandle will add some children\n  //          to this element to facilitate external drop events. Once created this\n  //          element is accessible as (new DropHandle(...)).el property.\n  //\n  // * opt -  object, key/value pairs of options. See the code for the list of\n  //          keys and their purpose. Can be omitted or empty to use defaults.\n  //          Current option values are accessible as the opt property.\n  //\n  //? new fd.DropHandle('anID')\n  //? new fd.DropHandle(document.body, {zoneClass: 'with-filedrop'})\n  global.DropHandle \x3d function (zone, opt) {\n    // Persistent 'this' instance reference.\n    var self \x3d this\n\n    self.el \x3d zone \x3d global.byID(zone)\n    if (!zone) { throw 'Cannot locate DOM node given to new FileDrop class.' }\n\n    /***\n      DropHandle Options\n     ***\n\n      Changing these on runtime after the class was created doesn't affect\n      anything so make sure to pass desired values to the constructor.\n     ***/\n\n    self.opt \x3d {\n      // The zone element gets this HTML class appended immediately after\n      // the DropHandle object is created.\n      zoneClass: 'fd-zone',\n\n      // DropHandle creates a hidden form and \x3cinput type\x3d\"file\"\x3e. The input\n      // is completely transparent so the contents underneath is visible\n      // but at the same time a dropped object lands on the input triggering\n      // its DOM events. This option specifies the class name assigned\n      // to this input.\n      inputClass: 'fd-file',\n\n      // Options for fallback upload via \x3ciframe\x3e for browsers lacking\n      // native drag \x26 drop support - IE and others.\n      iframe: {\n        // URL to send uploaded file to. It's a regular form upload with\n        // enctype\x3d\"multipart/form-data\" so if you're using PHP it's handled\n        // with $_FILES as usual. The URL can have query string. It will have\n        // the 'fd-callback' parameter appended containing the name of\n        // function your server script must call when generating JavaScript\n        // output - if it does the upload succeeds, otherwise it \"fails\".\n        // Calling external function is the only reliable way to know that\n        // we've uploaded the file right. Plus you can pass any data to\n        // that function as its parameters.\n        // For the practical server-side example see included upload.php.\n        //\n        // If unset \x3ciframe\x3e upload is disabled so only drag \x26 drop-aware\n        // browsers (Firefox and Crhome-based) will handle this drop zone.\n        url: '',\n\n        // Name of GET input variable containing the name of the global window\n        // callback function to be called by the server in the generated\n        // page after uploading a file via \x3ciframe\x3e.\n        callbackParam: 'fd-callback',\n\n        // Name of POST file input variable (\x3cinput type\x3d\"file\" name\x3d\"$nameParam\"\x3e).\n        // Maps to $_FILE[] in PHP.\n        fileParam: 'fd-file'\n      },\n\n      // Contains DOM nodes of fallback upload via \x3ciframe\x3e. If null necessary\n      // elements for \x3ciframe\x3e upload will be created automatically.\n      //\n      // If this is false (boolean) then DropHandle creates no input at all.\n      // This is useful if you need pure drag \x26 drop upload that works in\n      // Firefox and Chrome-based browsers, no \x3ciframe\x3e uploads for IE 9-,\n      // Opera, Safari and others. This creates \"perfect\" drop zone that\n      // doesn't prevent user interaction with underlying components so the\n      // zone can be extended onto large document area or the entire window.\n      input: null,\n\n      // After construction opt.input's structure is as follows: {\n        // If unset DropHandle will first recursively look for \x3cinput type\x3d\"file\"\x3e\n        // among the children of the zone element and having opt.inputClass among\n        // its HTML classes. If found no new element will be created. This makes it\n        // safe to create multiple DropHandle objects for the same zone handle (not\n        // tested though).\n        //\n        // If unset but no suitable node would be found (see above) then DropHandle\n        // creates the input automatically along with the form which is usually\n        // exactly what you need.\n        //file: null,\n\n        // This value is set to match the parent form of \x3cinput type\x3d\"file\"\x3e.\n        // Changing it isn't recommended.\n        //form: null\n      //},\n\n      // If using \x3cinput type\x3d\"file\"\x3e (legacy \x3ciframe\x3e upload, see input option)\n      // some browsers including IE 6-10 and Opera will keep last selected file\n      // in the input after upload which will prevent the user from uploading\n      // the same file twice in a row (this doesn't apply to drag \x26 drop uploads).\n      // When enabled, this option will let FileDrop recreate the file input\n      // thus resetting file selection. This is safe in most cases but if your\n      // project does some extra customization on opt.input.file this might erase\n      // them and attached events unless you are doing that in inputSetup event.\n      // When disabled, input will be cleared in Firefox/Chrome thus preventing\n      // user from reuploading the same file one after another in other browsers.\n      recreateInput: true,\n\n      // Chrome, unlike Firefox, dispatches drag events for the entire document\n      // rather than the input element. For Chrome this option is always true.\n      // If you want the same behaviout in Firefox then you can manually set\n      // it to true to let all of your drop zones receive drag events as soon\n      // as they enter the browser's window but not those zones' boundaries.\n      // Note that drop events (when user releases the mouse button) are always\n      // dispatched to drop zone under the mouse pointer, if there's any.\n      // This only makes drag (hover) events fire for all zones regardless of\n      // the pointer position.\n      fullDocDragDetect: false,\n\n      // Initial state of the multiple selection in browser's Open File dialog\n      // appearing when clickin on the drop zone (\x3cinput type\x3d\"file\"\x3e).\n      // After this object was created toggle this setting with this.multiple().\n      multiple: false,\n\n      // Cursor displayed when a user drags an object over this drop zone.\n      // Working values depend on the browser. 'copy' and 'none' work for\n      // Firefox and Chrome; the latter also supports 'move', 'link'.\n      // Setting to 'none' will cause \"No Drop\" cursor and will cause drop\n      // operation to be ignored on this drop zone (on-drop event not fired).\n      // This option can be set on runtime.\n      dropEffect: 'copy'\n    }\n\n    // Keeping track of all DropHandle instances.\n    global.all.push(self)\n    // If this DropHandle was created by a FileDrop instance this property\n    // will point to that instance.\n    self.filedrop \x3d null\n\n    var iframe \x3d self.opt.iframe\n    global.extend(self.opt, opt, true)\n    // In case user options contained {iframe} without full set of properties.\n    global.extend(self.opt.iframe, iframe)\n\n    // Chrome dispatches drop events document-wise rather than zone-wise.\n    // If unset we won't receive any reaction on individual elements.\n    global.isChrome \x26\x26 (self.opt.fullDocDragDetect \x3d true)\n\n    /***\n      DropHandle Events\n     ***\n\n      Attach new listeners with (new DropHandle).event('dragEnter', function ...).\n      As a low-level alternative you can change/move items around this array\n      directly but it's not future-proof.\n\n      Note that all callbacks are executed with 'this' pointing to this\n      object so it's easy to know which DropHandle has caused that particular\n      event. For example:\n\n        var dh \x3d new DropHandle('myzone')\n        dh.event('dragEnter', function () {\n          alert('Entering the ' + this.el.id + ' drop zone!')\n        })\n     ***/\n\n    self.events \x3d {\n      // Object-wise event preview handlers. They get executed on any event\n      // of this object (like dragEnter) and if any of them returns a non-null\n      // and non-undefined value actual event handlers are not called and\n      // that value is returned. These callbacks receive the same arguments\n      // as the target event plus that event's name in front.\n      // See callAllOfObject() for more details.\n      any: [],\n\n      // Occurs when a user drags something across this zone element (Firefox)\n      // or across the entire browser window (Chrome or if opt.fullDocDragDetect\n      // is set).\n      //\n      // function (eventObject)\n      dragEnter: [],\n\n      // Occurs when user drags the object away from the zone element (Firefox)\n      // or outside of the window (Chrome or opt.fullDocDragDetect).\n      //\n      // function (eventObject)\n      dragLeave: [],\n\n      // Occurs periodically after dragEnter while user is still dragging an\n      // object inside the drop zone. If not using DropHandle be aware that\n      // Chrome requires a listener attached to ondragover or it will discard\n      // the drop operation. DropHandle takes care of this for you.\n      //\n      // function (eventObject)\n      dragOver: [],\n\n      // The following 2 events are somewhat superficient and not really useful\n      // or working but they're still listened to in case you need to hook them.\n      //\n      // function (eventObject)\n      dragEnd: [],\n      dragExit: [],\n\n      // Occurs when a file has been dropped on the zone element or when a file\n      // was selected in/dropped onto fallback \x3cform\x3e to trigger \x3ciframe\x3e upload.\n      // The former occurs in Firefox and Chrome-based browsers that support\n      // drag \x26 drop natively. The latter occurs in Opera and others that only\n      // work with regular form file uploads.\n      //\n      // function (eventObject)\n      //    - is passed native browser-dependent event object.\n      upload: [],\n\n      // Occurs when another DropHandle object on the page initiates upload\n      // event. Can be used to reset some visual state of all drop zones but\n      // the one that's actually got the file landed.\n      //\n      // function (DropHandle)\n      //    - is passed another DropHandle object that has initiated the\n      //      upload event.\n      uploadElsewhere: [],\n\n      // Occurs after \x3cinput type\x3d\"file\"\x3e used to accept file drops was created\n      // or found (see the description of the 'input' option). Here it's used to\n      // assign it some HTML classes. You can do similar setup.\n      // Is also fired after recreating file input on upload if opt.recreateInput\n      // is set - in this case is passed old \x3cinput type\x3d\"file\"\x3e (that was cloned).\n      //\n      // function ({ file: DOM_Input, form: DOM_Form }, oldFileInput)\n      //    - is passed an object with the same keys as 'input' option -\n      //      the DOM element of the \x3cinput type\x3d\"file\"\x3e and its parent\n      //      \x3cform\x3e DOM element.\n      inputSetup: [],\n\n      // Occurs when a fallback \x3ciframe\x3e element was created. Can be used for\n      // setup actions similar to inputSetup.\n      //\n      // function (DOM_Iframe)\n      //    - is passed the DOM element of the new \x3ciframe\x3e.\n      iframeSetup: [],\n\n      // Occurs when a file was successfully uploaded to the server, i.e.\n      // when the form was submitted and the server has returned the output\n      // that calls 'fd-callback' function to indicate successful (or unsuccessful)\n      // upload to the client page. See the 'iframe' option and included upload.php\n      // for samples and explanations.\n      //\n      // function (response)\n      //    - is passed the same data as given by the server-generated JavaScript\n      //      to the global 'fd-callback'. Note that it's the first argument to\n      //      that function, all others are ignored.\n      //      This object will mimic some of XMLHttpRequest properties so you\n      //      can use single handler for both XHR and \x3ciframe\x3e uploads - see\n      //      sendViaIFrame() for details.\n      iframeDone: []\n    }\n\n    // Old FireDrop compatibility. Now deprecated.\n    self.on \x3d self.events\n    self.zone \x3d self.el\n\n    /***\n      DropHandle Methods\n     ***/\n\n    // Prepares target DOM element for drag \x26 drop and \x3ciframe\x3e uploads by\n    // adding more child nodes and listening to appropriate events.\n    // Usually you don't need to call this function since it's automatically\n    // called for the zone element (given to the constructor).\n    //\n    //? hook(byID('myzone'))\n    self.hook \x3d function (zoneNode) {\n      // If \x3cinput type\x3d\"file\"\x3e support was turned off then we're not aiming\n      // for the support of uploads without File API, i.e. via \x3ciframe\x3e for\n      // all but Firefox and Chrome. If such we're not creating the form and\n      // other supportive elements.\n      if (self.opt.input !\x3d false) {\n        self.opt.input \x3d self.opt.input || self.prepareInput(zoneNode)\n        self.opt.input \x26\x26 global.callAllOfObject(self, 'inputSetup', self.opt.input)\n      }\n\n      self.hookDragOn(zoneNode)\n      self.hookDropOn(zoneNode)\n      self.hookPaste(zoneNode)\n    }\n\n    // Attaches listeners for drag events - when an object is moved in or out\n    // the scope of the zone element (or document for Chrome). This provides\n    // common layer for various browser-specific ways to utilize drag* events.\n    // Once a suitable event occurs DropHandle's own event callbacks are invoked.\n    self.hookDragOn \x3d function (zoneNode) {\n      // With dragenter we detect when user moves object over our zone or\n      // document window to display some feedback.\n      //\n      // With dragleave we do the opposite and restore previous component state\n      // when an object is being moved away or drag \x26 drop is cancelled.\n\n      if (self.opt.fullDocDragDetect) {\n        self.delegate(document.body, 'dragEnter')\n\n        global.addEvent(document, 'dragleave', function (e) {\n          // Chrome (at least in earlier versions) fires dragleave randomly,\n          // this is used to normalize it to just one real occurrence.\n          if ((e.clientX \x3d\x3d 0 \x26\x26 e.clientY \x3d\x3d 0) || global.isTag(e.relatedTarget, 'html')) {\n            global.stopEvent(e)\n            global.callAllOfObject(self, 'dragLeave', e)\n          }\n        })\n      } else {\n        self.delegate(zoneNode, 'dragEnter')\n        self.delegate(zoneNode, 'dragLeave')\n      }\n\n      self.delegate(zoneNode, 'dragOver')\n      self.delegate(zoneNode, 'dragEnd')    // doesn't work anywhere; unused by FileDrop.\n      self.delegate(zoneNode, 'dragExit')   // works in Firefox; unused by FileDrop.\n    }\n\n    // Attaches listeners to drop events. Just like hookDragOn provides\n    // common browser-independent ground by normalizing occurred events\n    // and calling DropHandle's own event handlers.\n    self.hookDropOn \x3d function (zoneNode) {\n      // IE 6-9 fire 'drop' event if you drop a file onto a file input. However,\n      // if the form is submitted after this event IE will send empty POST body\n      // instead of the actual file data. So handling of this event is disabled here\n      // although technically it could've worked since IE 6 if not for that bug (?).\n      //\n      // Firefox and Chrome-based browsers are the only ones supporting this\n      // event which we use to read dropped file data in the FileDrop class.\n      global.isIE9 || self.delegate(zoneNode, 'drop', 'upload')\n    }\n\n    // Attaches a `onpaste` listener to the drop zone that then fires the\n    // upload event.\n    self.hookPaste \x3d function (zoneNode) {\n      self.delegate(zoneNode, 'paste', 'upload')\n    }\n\n    // Listens for DOM events and initiates corresponding DropHandle's events.\n    // Third argument can specify DropHandle's event name if it differs from\n    // the DOM event. Propagation of caught events is stopped.\n    //\n    //? delegate(byID('myzone'), 'dragleave')\n    //? delegate(byID('myzone'), 'drop', 'upload')\n    self.delegate \x3d function (zoneNode, domEvent, selfEvent) {\n      global.addEvent(zoneNode, domEvent.toLowerCase(), function (e) {\n        global.stopEvent(e)\n        global.callAllOfObject(self, selfEvent || domEvent, e)\n      })\n    }\n\n    // Finds or creates \x3cinput type\x3d\"file\"\x3e used to facilitate non-drag \x26 drop\n    // uploads for browsers othat than Firefox and Chrome-based.\n    // Returns that input's DOM element and its parent \x3cform\x3e or, if none,\n    // throws an exception since there's no meaning in having \x3cinput type\x3d\"file\"\x3e\n    // and no \x3cform\x3e as both are only reuqired for fallback \x3ciframe\x3e upload.\n    // This result is assigned to 'input' option.\n    self.prepareInput \x3d function (parent) {\n      var file \x3d self.findInputRecursive(parent) || self.createInputAt(parent)\n\n      if (file) {\n        var form \x3d file.parentNode\n        while (form \x26\x26 !global.isTag(form, 'form')) {\n          form \x3d form.parentNode\n        }\n\n        if (!form) { throw 'FileDrop file input has no parent form element.' }\n\n        // See if the located form has proper target and if that target\n        // (supposedly \x3ciframe\x3e) really exists - we don't want to reload\n        // the entire document on file upload since it defeats the purpose\n        // of AJAX and is probably an error condition.\n        var target \x3d form ? form.getAttribute('target') : ''\n\n        if (target \x26\x26 global.isTag(global.byID(target), 'iframe')) {\n          // Once here it means the setup is good to go. Return with success.\n          return {file: file, form: form}\n        }\n      }\n\n      // Similarly to opt.input \x3d\x3d false this means there's input/form found\n      // so turn off \x3ciframe\x3e upload or create our own elements.\n      return false\n    }\n\n    // Searches for \x3cinput type\x3d\"file\"\x3e containing HTML class opt.inputClass\n    // among the children of parent. Is used to autodetect pre-created input\n    // of a drop zone. parent must be a DOM element.\n    // Returns DOM element or null.\n    //\n    //? // \x3cform id\x3d\"myzone\"\x3e\x3cinput type\x3d\"file\" class\x3d\"fd-input\"\x3e\x3c/form\x3e\n    //  findInputRecursive(byID('myzone'))\n    //    //\x3d\x3e \x3cinput type\x3d\"file\" class\x3d\"fd-input\"\x3e\n    //\n    //? findInputRecursive(byID('foo'))   //\x3d\x3e null\n    self.findInputRecursive \x3d function findInputRecursive(parent) {\n      for (var i \x3d 0; i \x3c parent.childNodes.length; i++) {\n        var node \x3d parent.childNodes[i]\n\n        if (global.isTag(node, 'input') \x26\x26 node.getAttribute('type') \x3d\x3d 'file' \x26\x26\n            global.hasClass(node, self.opt.inputClass)) {\n          return node\n        } else if (node \x3d findInputRecursive(node)) {\n          return node\n        }\n      }\n    }\n\n    // Creates elements necessary for \x3ciframe\x3e upload to work - the input,\n    // form and iframe itself. A random unique ID is generated and assigned to\n    // the iframe, plus new form's target attribute. Once \x3cinput type\x3d\"file\"\x3e\n    // gets clicked (and file chosen in the appeared dialog) or once it gets\n    // a file dropped onto (supported by some browsers) its onchange event\n    // occurs which we're intercepting in hookDropOn(). With that we trigger\n    // \x3cform\x3e submission which sends data to our hidden \x3ciframe\x3e. Just like\n    // old times.\n    //\n    // Returns the DOM element of (new) \x3cinput type\x3d\"file\"\x3e.\n    self.createInputAt \x3d function (parent) {\n      do { var id \x3d global.randomID() } while (global.byID(id))\n\n      var cont \x3d document.createElement('div')\n      // \x3ciframe\x3e code and several other things around are courtesy of\n      // QQ File Uploader (https://github.com/valums/file-uploader).\n      cont.innerHTML \x3d '\x3ciframe src\x3d\"javascript:false\" name\x3d\"' + id + '\"\x3e\x3c/iframe\x3e' +\n                       '\x3cform method\x3d\"post\" enctype\x3d\"multipart/form-data\"\x3e' +\n                         '\x3cinput type\x3d\"hidden\" name\x3d\"' + self.opt.iframe.callbackParam + '\" /\x3e' +\n                         '\x3cinput type\x3d\"file\" name\x3d\"' + self.opt.iframe.fileParam + '\" /\x3e' +\n                       '\x3c/form\x3e'\n\n      // \x3ciframe\x3e.\n      cont.firstChild.setAttribute('id', id)\n      cont.firstChild.style.display \x3d 'none'\n      // \x3cform\x3e.\n      cont.lastChild.setAttribute('target', id)\n\n      var nextChild \x3d parent.firstChild\n      // Opera doesn't recognize \x3clegend\x3e and doesn't put it on top of the fieldset\n      // unless it's the first child. For this we skip over \x3clegend\x3e which can\n      // happen if parent is a \x3cfieldset\x3e.\n      while (nextChild \x26\x26 (!global.isTag(nextChild) || global.isTag(nextChild, 'legend'))) {\n        nextChild \x3d nextChild.nextSibling\n      }\n\n      // Now put our controls as first child so they overlap the contents and\n      // \x3cinput type\x3d\"file\"\x3e can be clicked or dropped onto to fire the events.\n      if (nextChild) {\n        // Firefox 10 requires that immediate parent has position: relative for\n        // overflow: hidden to work on the input this in turn requires that the\n        // parent is the first child, otherwise top: 0 of the file input won't work.\n        parent.insertBefore(cont, nextChild)\n      } else {\n        // parent has no children or it's just \x3clegend\x3e - append controls to the end.\n        parent.appendChild(cont)\n      }\n\n      // The file input.\n      return cont.lastChild.lastChild\n    }\n\n    // Can be used to abort \x3ciframe\x3e upload. Isn't guaranteed to work since\n    // it's unreliable and highly browser-dependent (especially IE) but at\n    // least it might work. Does nothing if this DropHandle doesn't use\n    // \x3ciframe\x3e upload (see the input option).\n    self.abortIFrame \x3d function () {\n      if (self.opt.input.form) {\n        var iframe \x3d global.byID(self.opt.input.form.getAttribute('target'))\n        iframe \x26\x26 iframe.setAttribute('src', 'javascript:false')\n      }\n    }\n\n    // Sends the data via \x3ciframe\x3e as a fallback for proper File API AJAX upload.\n    // If url is omitted iframe.url option is used. See its description for more\n    // info. Does nothing if this DropHandle doesn't use \x3ciframe\x3e upload (see\n    // the input option). FileDrop class calls this automatically if an upload\n    // was triggered by an unsupported browser (neither Firefox nor Chrome-based).\n    //\n    // Unlike FileAPI events that let you decide what to do with the file - read,\n    // upload or descrad it - \x3ciframe\x3e upload is an imitation that simply submits\n    // the form as logn as \x3cinput type\x3d\"file\"\x3e was changed according to onchange\n    // event. There's no way to make sure it was populated or retrieve any info\n    // about the file - this can only be done by the server which may return\n    // something useful in response. For this reason DropHandle automatically\n    // facilitates the upload and offers only one 'iframeDone' event when all\n    // went fine.\n    //\n    // Returns true if upload was sent (but no guarantees about its success,\n    // use 'iframeDone' event for this purpose).\n    //\n    //? sendViaIFrame('http://my.host/upload.php?var\x3dfoo\x26var2\x3d123')\n    //? sendViaIFrame()   // uses opt.iframe.url\n    self.sendViaIFrame \x3d function (url) {\n      url \x3d url || self.opt.iframe.url\n      var form \x3d (self.opt.input || {}).form\n\n      if (url \x26\x26 form) {\n        do { var callback \x3d global.randomID() } while (callback in window)\n\n        // This function is meant for calling by the code generated by the\n        // server-side script to which we've sent the file via the \x3cform\x3e.\n        // callback is that function's globally unique name (window-wise).\n        window[callback] \x3d function (resp) {\n          // If server didn't pass a JS object let's mimic XMLHttpRequest\n          // and put that response data there.\n          if (typeof resp !\x3d 'object') {\n            resp \x3d {\n              response: resp,\n              responseXML: '',\n              responseText: (resp || '').toString(),\n              readyState: 4,\n              status: 200,\n              statusText: 'OK',\n              // A bunch of XMLHttpRequest/jqXHR stub methods.\n              getAllResponseHeaders: function () { return '' },\n              getResponseHeader: function () { return '' },\n              setRequestHeader: function () { return this },\n              statusCode: function () { return this },\n              abort: function () { return this }\n            }\n          }\n\n          // These are extra properties given to event handlers so they\n          // can differentiate between AJAX upload and \x3ciframe\x3e fallback.\n          // Note that if properties with these names are already present\n          // in response they won't be overwritten.\n          global.extend(resp, {\n            // Just an indicator that it's an upload via \x3ciframe\x3e.\n            iframe: true,\n            // This URL contains full URL to which the data was sent (usually\n            // opt.iframe.url) that might include 'fd-callback' parameter.\n            url: url\n          })\n\n          global.callAllOfObject(self, 'iframeDone', resp)\n        }\n\n        // Setting the hidden input with the callback name to our newly generated name.\n        var cbInput \x3d form.firstChild\n        while (cbInput \x26\x26 (!global.isTag(cbInput, 'input') ||\n               cbInput.name !\x3d self.opt.iframe.callbackParam)) {\n          cbInput \x3d cbInput.nextSibling\n        }\n\n        if (cbInput) {\n          cbInput.value \x3d callback\n        } else {\n          // This shouldn't happen with standard usage but if the hidden field\n          // is missing let's append callback name to the URL itself.\n          url \x3d url.replace(/[?\x26]+$/, '') +\n                (url.indexOf('?') \x3d\x3d -1 ? '?' : '\x26') +\n                self.opt.iframe.callbackParam + '\x3d' + callback\n        }\n\n        form.setAttribute('action', url)\n        global.callAllOfObject(self, 'iframeSetup', form)\n        form.submit()\n        setTimeout(self.resetForm, 300)\n\n        return true\n      }\n    }\n\n    // Clears value of the file input so that the same file (with the same\n    // local path) can be uploaded again without reloading the page.\n    // Thanks to @rafaelmaiolla for the tips.\n    self.resetForm \x3d function () {\n      var input \x3d self.opt.input \x26\x26 self.opt.input.file\n      if (input) {\n        // Works in Firefox/Chrome only. Funny fact is that cloneNode() there\n        // will clone file selection too. IE doesn't support value \x3d '' but\n        // node cloning erases it.\n        input.value \x3d ''\n\n        if (self.opt.recreateInput) {\n          var clone \x3d self.opt.input.file \x3d input.cloneNode(true)\n          input.parentNode.replaceChild(clone, input)\n          global.callAllOfObject(self, 'inputSetup', [self.opt.input, input])\n        }\n      }\n    }\n\n    // Toggles selection of multiple files in the browser's open file dialog\n    // that appears when you click on \x3cinput type\x3d\"file\"\x3e. Does nothing if\n    // this DropHandle doesn't use \x3ciframe\x3e upload (see the input option).\n    //\n    // If an argument is given it's used to set the new state. If no arguments\n    // are passed then current state is read.\n    //\n    // When doing initial setup on object construction you can pass {multiple: true}\n    // as an option instead of calling this method right after.\n    //\n    //? multiple(true)    //\x3d\x3e true; multiple file selection is possible\n    //? multiple(false)   //\x3d\x3e false; only one file can be selected\n    //? multiple()        //\x3d\x3e true if multiple selection is enabled or false otherwise\n    //? multiple(undefined)   // equivalent to above\n    self.multiple \x3d function (enable) {\n      if (self.opt.input \x26\x26 typeof enable !\x3d 'undefined') {\n        enable ? self.opt.input.file.setAttribute('multiple', 'multiple')\n               : self.opt.input.file.removeAttribute('multiple')\n      }\n\n      return self.opt.input \x26\x26 !!self.opt.input.file.getAttribute('multiple')\n    }\n\n    // Function to manipulate events that correspond to DropHandle's events - not\n    // DOM node events. If you need to listen to them instead then use this:\n    //   addEvent(yourDropHandle.el, 'mousemove', function ...)\n    // Or any other standard way, e.g. with jQuery:\n    //   $(yourDropHandle.el).mousemove(function () { ... })\n    //\n    // Without parameters returns copy of {event: [func, func, ...], ...}\n    // event map - all handlers attached to this zone.\n    //\n    // When given a single non-array parameter returns array of handlers\n    // of that particular event:\n    //   event('iframeDone')     //\x3d\x3e [function () { ... }, func, ...]\n    //\n    // When givne a single array parameter acts similarly to parameterless\n    // form - returns event map of those particular events:\n    //   event(['inputSetup', 'iframeDone'])\n    //     //\x3d\x3e { inputSetup: [function () { ... }], iframeDone: [func, ...] }\n    //\n    // When givne one object parameter - an event map - all its handlers\n    // are added (values can be either functions or arrays, namespaces are\n    // not supported by this call form):\n    //   event({ inputSetup: [func, func, ...], iframeDone: func })\n    //     //\x3d\x3e this (DropHandle)\n    //\n    // When given two parameters and the second is null removes all handlers\n    // of event(s) listen in the first parameter (array or string):\n    //   event('inputSetup', null)    //\x3d\x3e this (DropHandle) - and below\n    //   event(['inputSetup', 'iframeDone'], null)\n    //\n    // When given two parameters and the second is either a function or array\n    // adds listeners to listed event(s):\n    //   event('inputSetup', function () { alert('New listener') })\n    //     //\x3d\x3e this (DropHandle) - here and below\n    //   event(['inputSetup', 'iframeDone'], function () { ... })\n    //   event('inputSetup', [func_1, func_2, ...])\n    //   event(['inputSetup', 'iframeDone'], [func_1, func_2, ...])\n    //\n    // Since two parameter-long calls return 'this' you can easily chain\n    // multiple calls to the object methods like in jQuery.\n    //\n    // New listeners are pushed at the end of event chain (see callAll()).\n    // Use preview() to add handlers in front of others.\n    //\n    // Event names can contain namespaces in form 'event:namespace' - this\n    // string identifier (not necessary unique) is assigned to every function\n    // handler and can be used later to remove that handler or a bunch of others\n    // with the same ID. Empty namespace ('event:') is the same as just 'event'.\n    // Registering new handler with the same NS in the same event doesn't remove\n    // the former (NS can duplicate). On unlisten, empty event name with non-empty\n    // namespace looks over all events.\n    //\n    //   event('event:myns', [func_1, func_2])\n    //     // adds 2 handlers, both under 'myns' namespace.\n    //   event('event', func_3)\n    //     // adds third function under empty namespace.\n    //   event('event:myns', null)    // removes 2 functions added first.\n    //   event(':myns', null)   // removes all 'myns' functions from all events.\n    //   event('event')   //\x3d\x3e {event: func_3}\n    //\n    // Any other parameter combination will result in exception.\n    //\n    // You can preview any event (execute your own handlers before any occurring\n    // event's handlers are executed) with 'any' event name (see callAllOfObject()):\n    //\n    //   event('any', function () { return false })\n    //     // suppresses all events.\n    //   event('any:myns', function () { return false })\n    //     // the same but lets you later remove this namespaced handler.\n    //   event('any:myns', null)    // removes the handler set above.\n    //\n    // There are also more special call forms. With one null parameter all\n    // handlers on this zone are removed - can be used to transfer all handlers\n    // from one DropHandle to another or save/restore their state:\n    //   var old \x3d event()    //\x3d\x3e {event: [func], ...}\n    //   event(null)\n    //   event(old)\n    //\n    // With one function parameter this function's namespace is returned\n    // or empty strign if there's none:\n    //   event(function () { })     //\x3d\x3e ''\n    //\n    //? event('inputSetup', function (input) {\n    //    alert('Setting up file input of ' + input.form.target)\n    //  })\n    //\n    //? event('iframeDone', [handler_1, handler_2, ...])\n    //? event(['inputSetup', 'iframeDone'], function () { alert(this.el.id) })\n    //? event('any:namespace', ...)\n    self.event \x3d function (events, funcs) {\n      return global.appendEventsToObject.apply(self, arguments)\n    }\n\n    // A simplified companion of event() that adds listeners not after\n    // existing but in front of them. Useful for intercepting and overriding\n    // calls of certain events. Supports namespaces.\n    //\n    // Has several call forms which are identical to event():\n    // 1. One parameter - object (event map)\n    // 2. Two parameters - array/array, array/func, string/array, string/func\n    //\n    // Any other parameter combination will result in exception.\n    //\n    //? preview('iframeDone', function () { alert('Abort!'); return false })\n    //? preview(['inputSetup:myns'], [func, func])\n    //? preview('any:myns', function () { alert('Stop that!'); return false })\n    self.preview \x3d function (events, funcs) {\n      return global.previewToObject.apply(self, arguments)\n    }\n\n    /***\n      Standard DropHandle Event Callbacks\n     ***\n\n      These are used to support default behaviour like assignment of HTML\n      classes to zone and input nodes.\n     ***/\n\n    self.onInputSetup \x3d function (input, oldInput) {\n      if (oldInput) {\n        // IE clones elements \"by reference\" so when one's attributes or\n        // events are changed the other also reflects the change.\n        // Taken from jQuery which borrowed that from MooTools.\n        input.file.clearAttributes \x26\x26 input.file.clearAttributes()\n        input.file.mergeAttributes \x26\x26 input.file.mergeAttributes(oldInput)\n      } else {\n        self.multiple(self.opt.multiple)\n      }\n\n      global.setClass(input.file, self.opt.inputClass)\n\n      // We listen for \x3cinput type\x3d\"file\"\x3e's onchange event - when it occurs\n      // we trigger submission of the hidden form which navigates hidden\n      // \x3ciframe\x3e to upload the file to the server script and read its response.\n      // This can be used in drag \x26 drop-aware browsers (Firefox and Chrome-based)\n      // to create a \"Browse for file\" button as an alternative to drag \x26 drop.\n      // For more details see the 'iframe' option.\n      self.delegate(input.file, 'change', 'upload')\n\n      var parent \x3d input.file.parentNode\n      if (parent \x26\x26 parent.style.display.match(/^(static)?$/)) {\n        // We need to anchor \x3cinput\x3e's position relative to its parent node.\n        parent.style.position \x3d 'relative'\n      }\n\n      if (global.isTag(zone, 'fieldset')) {\n        // Firefox 13 or so has started to ignore overflow: hidden on fieldsets.\n        // We need to wrap it in a \x3cdiv\x3e that by itself will hide any overflow.\n        var div \x3d document.createElement('div')\n        div.style.position \x3d 'relative'\n        div.style.overflow \x3d 'hidden'\n        zone.parentNode.insertBefore(div, zone)\n        div.appendChild(zone)\n      }\n    }\n\n    self.onDragOver \x3d function (e) {\n      global.stopEvent(e)\n      e.dataTransfer \x26\x26 (e.dataTransfer.dropEffect \x3d self.opt.dropEffect)\n    }\n\n    self.onUpload \x3d function () {\n      for (var i \x3d 0; i \x3c global.all.length; i++) {\n        if (global.all[i] !\x3d\x3d self \x26\x26 global.all[i].events) {\n          global.callAllOfObject(global.all[i], 'uploadElsewhere', self)\n        }\n      }\n    }\n\n    self.event({\n      inputSetup: self.onInputSetup,\n      dragOver: self.onDragOver,\n      upload: self.onUpload\n    })\n\n    // Initialization.\n    global.setClass(zone, self.opt.zoneClass)\n    self.hook(zone)\n  }\n\n  /***\n    Main FileDrop Class\n   ***\n\n    Based on DropHandle to abstract from browser-specific drag \x26 drop\n    and fallback \x3ciframe\x3e upload quirks, this class adds actual upload\n    functionality. It listens for drop events and \x3ciframe\x3e submission\n    triggering dedicated events with normalized parameters. Underlying\n    DropHandle class can be accessed via this.handle property. It shares\n    options and events with FileDrop object so changing one affects another.\n\n    DropHandle properties and methods are available on this object as well.\n\n    This object is defined in window.fd and aliased as window.FileDrop.\n   ***/\n\n  // Parameters - identical to DropHandle, see its note for details.\n  //? new FileDrop('anID')\n  //? new FileDrop(document.body, {zoneClass: 'with-filedrop'})\n  global.FileDrop \x3d function (zone, opt) {\n    // Persistent 'this' instance reference.\n    var self \x3d this\n\n    zone \x3d global.byID(zone)\n\n    // Underlying DropHandle instance providing browser-independent\n    // handlers for drag \x26 drop and \x3ciframe\x3e upload facility.\n    // Constructor will throw an exception if zone is invalid/undefined.\n    self.handle \x3d new global.DropHandle(zone, opt)\n    self.handle.filedrop \x3d self\n\n    /***\n      FileDrop Options\n     ***\n\n      Changing these on runtime after the class was created doesn't affect\n      anything so make sure to pass desired values to the constructor.\n\n      Extends DropHandle options so check that class for more options and info.\n     ***/\n\n    global.extend(self.handle.opt, {\n      // HTML class name for the zone DOM node that is set when an object\n      // is being dragged over that zone (Firefox) or over entire document\n      // (Chrome-powered browsers). It's removed once the object was dragged\n      // away or drag \x26 drop was cancelled.\n      dragOverClass: 'over'\n    })\n\n    global.extend(self.handle.opt.iframe, {\n      // opt.iframe.force - if set FileDrop will always upload files by using\n      // fallback \x3ciframe\x3e method. This only makes sense in debugging and\n      // for some browsers (Opera before migrating to Chrome engine).\n      force: false\n    })\n\n    /***\n      FileDrop Events\n     ***\n\n      Attach new listeners with (new FileDrop).event('send', function ...).\n      Extends DropHandle options so check that class for more events and info.\n\n      This only applies to FileDrop zone overall - it doesn't define events\n      for individual File objects being generated by this zone. This means\n      that to determine upload state or progress you need to attach listeners\n      to each produced File object - either inside FileDrop's 'send' event\n      before sending a file to the server or inside its 'fileSetup' event\n      which is fired right after the creation of File object.\n\n      Note that all callbacks are executed with 'this' pointing to this\n      object so it's easy to know which FileDrop has caused that particular\n      event. For example:\n\n        var dh \x3d new FileDrop('myzone')\n        dh.event('send', function (files) {\n          alert('Sending files via ' + this.el.id)\n\n          for (var i \x3d 0; i \x3c files.length; i++) {\n            files[i].sendTo('http://my.host/upload.php')\n          }\n        })\n     ***/\n\n    global.extend(self.handle.events, {\n      // Occurs when a file is ready to be sent via drag \x26 drop. Doesn't\n      // occur for \x3ciframe\x3e uploads since the only thing you can do about them\n      // is submit the file to the server (no file info is available).\n      // If for some reason you still need to know when a file was *potentially*\n      // placed into \x3cinput type\x3d\"file\"\x3e for such fallback uploads listen or\n      // preview the 'upload' event (inherited from DropHandle).\n      //\n      // function (fd.FileList)\n      //    - is passed list of files that were dropped onto this zone - see\n      //      the description of this object for more details.\n      send: [],\n\n      // Occurs when a new fd.File object was created. You can use this to\n      // attach your own events if you don't want to do this on every 'send'\n      // occurrence.\n      //\n      // function (fd.File)\n      //    - is passed instance of the newly created File object.\n      fileSetup: []\n    })\n\n    // Handles upload that happens when a user drops a file onto the zone\n    // (Firefox, Chrome-based) or its \x3cinput type\x3d\"file\" (Opera, others).\n    self.onUpload \x3d function (e) {\n      var files \x3d !self.opt.iframe.force \x26\x26 self.eventFiles(e, true)\n\n      // This was likely triggered by onchange event of \x3cinput type\x3d\"file\"\x3e\n      // which means the browser doesn't support drag \x26 drop or the user\n      // has picked file by clicking on the drop zone, bringing up Open File\n      // dialog and selecting a file there.\n      // If that's the case we don't have any file info available so just\n      // submit the form to the server and see what it responds with (only\n      // if \x3ciframe\x3e upload was enabled by filling out opt.iframe.url).\n      if (!files) {\n        if (!self.handle.sendViaIFrame() \x26\x26 global.hasConsole) {\n          // Must set opt.iframe.url if \x3ciframe\x3e fallback needs to work.\n          console.warn('FileDrop fallback upload triggered but iframe options' +\n                       ' were not configured - doing nothing.')\n        }\n      } else if (files.length \x3e 0) {\n        // Dropped one or more files and we have FileAPI available (Firefox,\n        // Chrome-based) so fire off the usual on-drop event.\n        global.callAllOfObject(self, 'send', [files])\n      }\n    }\n\n    // Retrieves fd.File objects from an on-drop event. Returns a fd.FileList\n    // array-like object (not W3C FileList).\n    // If orFalse is unset always returns a FileList even if event was invalid,\n    // otherwise returns false in such occurrences instead of empty FileList.\n    self.eventFiles \x3d function (e, orFalse) {\n      if (e.type \x3d\x3d\x3d 'paste') {\n         return self.handlePaste(e);\n      }\n\n      var list;\n      var result \x3d new global.FileList(e)\n      var dataTransfer \x3d e.dataTransfer;\n\n      // IE 8 supplies dataTransfer but it's of its own format (getData(), etc.)\n      // and not standardized. Has no file objects.\n      if (dataTransfer \x26\x26 (dataTransfer.length || dataTransfer.files)) {\n        list \x3d dataTransfer\n      } else {\n        // IE 10 provides dataTransfer on drag \x26 drop but when selecting with\n        // Open File dialog of \x3cinput type\x3d\"file\"\x3e it only has e.srcElement.files.\n        // Thanks to @rafaelmaiolla for this correction.\n        list \x3d (e.target \x26\x26 e.target.files) || (e.srcElement \x26\x26 e.srcElement.files)\n      }\n\n      if (list) {\n        var entries \x3d list.items || []\n        list.files \x26\x26 (list \x3d list.files)   // Firefox 3.6.\n        var names \x3d {}\n\n        for (var i \x3d 0; i \x3c list.length; i++) {\n          var file \x3d new global.File(list[i])\n\n          // Safari Windows adds first file several times so skip them.\n          // ...while iOS Safari adds files under the same name - image.jpg (#30).\n          if (!names[file.name] || file.name \x3d\x3d 'image.jpg') {\n            names[file.name] \x3d true\n            file.setNativeEntry(entries[i])\n            global.callAllOfObject(self, 'fileSetup', file)\n\n            // Directories have zero size but in Chrome they are useful\n            // since you can access underlying DIrectoryEntry and read files.\n            if (file.size \x3e 0 || file.nativeEntry) {\n              result.push(file)\n            }\n          }\n        }\n      } else if (orFalse) {\n        result \x3d false\n      }\n\n      return result\n    }\n\n    self.handlePaste \x3d function(e) {\n      var file,\n          files \x3d new global.FileList(e),\n          matchType \x3d /image.*/,\n          types \x3d e.clipboardData.types;\n\n      Array.each(types, function(type, i) {\n        var items \x3d e.clipboardData.items || [];\n        if (type.match(matchType) || items[i].type.match(matchType)) {\n          var blob \x3d items[i].getAsFile();\n          var mime \x3d blob.type.replace('image/', '');\n          blob.name \x3d 'Pasted-From-Clipboard.' + mime;\n          file \x3d new global.File(blob);\n          file.setNativeEntry(items[i]);\n          global.callAllOfObject(self, 'fileSetup', file);\n          if (file.size \x3e 0 || file.nativeEntry) {\n             files.push(file);\n          }\n        }\n      });\n      return files;\n    }\n\n    // Linking both classes together. Objects become references so changing,\n    // for example, handle.events affects this.events. Functions of DropHandle\n    // become available on this FileDrop instance which is fine since they\n    // operate on 'self' bound to DropHandle object rather than 'this' of FileDrop.\n    global.extend(self, self.handle)\n\n    /***\n      Standard FileDrop Event Callbacks\n     ***\n\n      These are used to support default behaviour like actual upload process\n      after dropping a file or updating zone HTML classes on drag over/out.\n     ***/\n\n    function dragClassChanger(isHovered) {\n      return function () {\n        global.setClass(zone, self.opt.dragOverClass, isHovered)\n      }\n    }\n\n    self.event({\n      upload:           self.onUpload,\n      send:             self.resetForm,\n      // Add/remove on-drag HTML classes to/from the zone element.\n      dragEnter:        dragClassChanger(true),\n      dragLeave:        dragClassChanger(false),\n      uploadElsewhere:  dragClassChanger(false)\n    })\n\n    self.preview({\n      // Placing handler to reset on-drop state of the zone for better\n      // visual feedback - the user immediately recognizes that the file is no\n      // more dragged even if actual upload handler takes some time to execute.\n      upload:           dragClassChanger(false)\n    })\n  }\n\n  /***\n    FileList Class\n   ***\n\n    It's sort of W3C class (that has no special methods defined in the spec)\n    with a bunch of File-oriented methods that this object is meant to contain.\n    It's an array-like object with length, splice and other methods.\n   ***/\n\n  global.FileList \x3d function (event) {\n    // Persistent 'this' instance reference.\n    var self \x3d this\n\n    // If set can be 'copy', 'move' or other action. Doesn't reliably work\n    // cross-browser and cross-platform. See MDN for more info:\n    // https://developer.mozilla.org/en-US/docs/Web/API/DataTransfer\n    self.dropEffect \x3d (event \x26\x26 event.dropEffect) || ''\n    self.length \x3d 0\n\n    // No need to hold the reference to this variable.\n    event \x3d null\n\n    self.push \x3d function (file) {\n      self[self.length++] \x3d file\n      return self\n    }\n\n    // Returns undefind if this list is empty.\n    self.pop \x3d function () {\n      if (self.length \x3e 0) {\n        var file \x3d self.last()\n        delete self[--self.length]\n        return file\n      }\n    }\n\n    self.first \x3d function () {\n      return self[0]\n    }\n\n    self.last \x3d function () {\n      return self[self.length - 1]\n    }\n\n    self.remove \x3d function (i) {\n      for (; i \x3c self.length - 1; i++) {\n        self[i] \x3d self[i + 1]\n      }\n\n      se.f.pop()\n      return self\n    }\n\n    self.clear \x3d function () {\n      for (var i \x3d 0; i \x3c self.length; i++) {\n        delete self[i]\n      }\n\n      self.length \x3d 0\n      return self\n    }\n\n    // Reverses order of files in this list (changes self).\n    self.reverse \x3d function () {\n      for (var i \x3d 0; i \x3c Math.floor(self.length / 2); i++) {\n        self[i] \x3d self[self.length - i - 1]\n      }\n      return self\n    }\n\n    // Creates copy of this list and adds items from FileList or array\n    // to the end of the returned copy.\n    self.concat \x3d function (list) {\n      var copy \x3d new global.FileList\n      for (var i \x3d 0; i \x3c self.length; i++) {\n        copy[i] \x3d self[i]\n      }\n\n      for (var i \x3d 0; list \x26\x26 i \x3c list.length; i++) {\n        copy[self.length + i + 1] \x3d list[i]\n      }\n\n      copy.length \x3d self.length + (list || []).length\n      return self\n    }\n\n    // Sorts this list by calling comparator in context cx (or 'this' FileList).\n    // func \x3d function (File a, File b, aIndex, bIndex) - if returns \x3c 0 second\n    // file (b) must go before first (a). Very similar to Array.sort().\n    //\n    //? sort(function (a, b) { return a.name \x3e b.name ? +1 : -1 })\n    self.sort \x3d function (func, cx) {\n      for (var i \x3d 0; i \x3c self.length; i++) {\n        for (var j \x3d 0; j \x3c self.length; j++) {\n          if (func.call(cx || this, self[i], self[j], i, j) \x3c 0) {\n            var temp \x3d self[i]\n            self[i] \x3d self[j]\n            self[j] \x3d temp\n          }\n        }\n      }\n\n      return self\n    }\n\n    // Sorts this list by calling func on each File alone and using that value\n    // (hash) to compare itsems between themselves. Like Underscore's sortBy().\n    // func \x3d function (File, index) - returns something comparable, e.g. string,\n    // number or Date.\n    //\n    //? sortBy(function (file) { return file.modDate })\n    //? sortBy(function () { return Math.random() })\n    self.sortBy \x3d function (func, cx) {\n      var list \x3d []\n\n      for (var i \x3d 0; i \x3c self.length; i++) {\n        list.push([ i, func.call(cx || this, self[i], i) ])\n      }\n\n      list.sort(function (a, b) {\n        return a[1] \x3e b[1] ? +1 : (a[1] \x3c b[1] ? -1 : 0)\n      })\n\n      for (var i \x3d 0; i \x3c list.length; i++) {\n        self[i] \x3d list[i][0]\n      }\n\n      return self\n    }\n\n    // Calls func in context cx for every File in the list and if it returns\n    // a non-null value returns the File object on which func was invoked.\n    // If this list is empty or if func didn't return anything for any file\n    // returns undfined.\n    //\n    //? find(function (f) { return f.name[0] \x3d\x3d 'a' })\n    //    // returns first File which local name starts with 'a', if any.\n    self.find \x3d function (func, cx) {\n      for (var i \x3d 0; i \x3c self.length; i++) {\n        var res \x3d func.call(cx || this, self[i], i)\n        if (res !\x3d null) { return self[i] }\n      }\n    }\n\n    // The same as find() but ignores returned value of the callback invoking\n    // it for every File in the list.\n    //\n    //? each(function (f) { alert(f.name) })\n    self.each \x3d function (func, cx) {\n      self.find(function () { func.apply(this, arguments) }, cx)\n      return self\n    }\n\n    // Calls method on every contained object with given arguments. Returns self.\n    //\n    //? invoke('fileMethod', 'arg1', 2, 3.33)\n    self.invoke \x3d function (method, arg_1) {\n      var args \x3d global.toArray(arguments, 1)\n      return this.each(function (file) { file[method].apply(file, args) })\n    }\n\n    // Aborts all uploads of files contained in this list. Does nothing if\n    // upload isn't active. Doesn't abort \x3ciframe\x3e uploads - for this call\n    // abortIFrame() on the corresponding DropHandle object.\n    //\n    //? abort()\n    self.abort \x3d function () {\n      return this.invoke('abort')\n    }\n\n    // Runs through over all items in this list calling func in context cx (or\n    // this) and storing returned values. Returns File object for which func\n    // generated the largest value (or first such File for multiple same values).\n    // Returns undefined if this list is empty.\n    //\n    //? findCompare(function (f) { return f.size })\n    //    // returns largest file.\n    self.findCompare \x3d function (func, cx) {\n      var file, value \x3d null, res\n\n      self.each(function (f) {\n        if (value \x3d\x3d null || value \x3c (res \x3d func.call(cx, file))) {\n          file \x3d f\n        }\n      }, cx)\n\n      return file\n    }\n\n    // Returns new list that only contains items for which func called in context\n    // cx (or this) has returned a truthy value.\n    self.filter \x3d function (func, cx) {\n      var list \x3d new global.FileList\n\n      self.each(function (f) {\n        func.apply(this, arguments) \x26\x26 list.push(f)\n      }, cx)\n\n      return list\n    }\n\n    // Finds File with biggest size or undefined for empty list.\n    self.largest \x3d function () {\n      return self.findCompare(function (f) { return f.size })\n    }\n\n    // Finds File with smallest size or undefined for empty list.\n    self.smallest \x3d function () {\n      return self.findCompare(function (f) { return -f.size })\n    }\n\n    // Finds File that was changed the longest time before or undefined for empty list.\n    self.oldest \x3d function () {\n      return self.findCompare(function (f) { return -f.modDate.getTime() })\n    }\n\n    // Finds File that was most recently changed or undefined for empty list.\n    self.newest \x3d function () {\n      return self.findCompare(function (f) { return f.modDate })\n    }\n\n    // Returns new list of all files which MIME type matches. MIME shouldn't contain\n    // RegExp symbols except for '/'. To match MIME group like 'image/*' don't\n    // include trailing '/*' - just 'image'.\n    //\n    //? ofType('image').first()   //\x3d\x3e File or undefined if none\n    self.ofType \x3d function (mime) {\n      mime +\x3d mime.indexOf('/') \x3d\x3d -1 ? '/' : '$'\n      mime \x3d new RegExp('^' + mime, 'i')\n      return self.filter(function (f) { return mime.test(f.type) })\n    }\n\n    // Returns new list with File items with image/* MIME type.\n    self.images \x3d function () {\n      return self.ofType('image')\n    }\n\n    // If name is string returns File with name exactly matching that string\n    // If name is RegExp returns new list containing File items which 'name'\n    // match given RegExp.\n    //\n    //? named('myfile.txt')     //\x3d\x3e File or undefined\n    //? named(/^start_\\..+$/i)  //\x3d\x3e FileList (copy)\n    self.named \x3d function (name) {\n      if (typeof name \x3d\x3d 'string') {\n        return self.find(function (f) { return f.name \x3d\x3d name })\n      } else {\n        return self.filter(function (f) { return name.test(f.name) })\n      }\n    }\n  }\n\n  // Making FileList array-like.\n  global.FileList.prototype.length \x3d 0\n  global.FileList.prototype.splice \x3d Array.prototype.splice\n\n  /***\n    Browser-Independent File Class\n   ***\n\n    It's passed on FileDrop 'send' event as members fd.FileList and provides\n    cross-browser access to file information and ability to upload it to the server.\n    Wraps around native browser's File object.\n   ***/\n\n  // Parameters:\n  // * file - native browser File object that was retrieved from the on-drop\n  //          event object. Can be accessed via this.nativeFile property.\n  global.File \x3d function (file) {\n    // Persistent 'this' instance reference.\n    var self \x3d this\n\n    // Native browser's File object as it was given in the on-drop event.\n    // Is null for directory entries if on lists produced by listEntries().\n    self.nativeFile \x3d file\n\n    // In Chrome 21+ will be set to native Entry (FileEntry, DirectoryEntry, etc.)\n    // instance. See W3C spec: http://www.w3.org/TR/file-system-api/#the-entry-interface\n    self.nativeEntry \x3d null\n\n    // Local file name.\n    self.name \x3d file.fileName || file.name || ''\n\n    // Local file size (bytes).\n    self.size \x3d file.fileSize || file.size || 0\n\n    // Local file MIME type.\n    self.type \x3d self.mime \x3d file.fileType || file.type || ''\n\n    // Last modification of the local time. Standard Date object.\n    self.modDate \x3d file.lastModifiedDate || new Date\n\n    // XMLHttpRequest object that was used to upload the file to the server.\n    // Only filled after sendTo() was called.\n    self.xhr \x3d null\n\n    /***\n      File Options\n     ***\n\n      Values here specify default values for sendTo() options - like HTTP\n      method used to submit the data. They can be overriden by passing an\n      object to sendTo() - e.g. sendTo('upload.php', {method: 'PUT'}).\n     ***/\n\n    self.opt \x3d {\n      // If enabled this object will add several X-... headers to provide\n      // information about the original file to the server (e.g. name and size).\n      extraHeaders: true,\n\n      // The value of X-Requested-With header sent with XMLHttpRequest used\n      // to upload the dropped file(s). If false then this header is not set\n      // (but you can use xhrSetup/xhrSend events to set it). If true - it's\n      // set to one of 'FileDrop-XHR-...'. A string sets it to that string -\n      // e.g. 'XMLHttpRequest' would simulate regular $.ajax() request.\n      xRequestedWith: true,\n\n      // HTTP method used to submit the upload data. Useful for contacting\n      // WebDAV services which might accept PUT or DELETE. Given in sendTo()\n      // to XMLHttpRequest.open().\n      method: 'POST'\n    }\n\n    /***\n      File Events\n     ***\n\n      These are different from FileDrop events and are individual to each File.\n      See FileDrop events for more info on how to attach listeners here.\n     ***/\n\n    self.events \x3d {\n      // Object-wise event preview handlers. See DropHandle's 'any' description.\n      any: [],\n\n      // Occurs after an XMLHttpRequest object was prepared to submit the file\n      // to the server. All FileDrop-specific headers and other customization\n      // (Content-Type, etc.) was already done. You can set extra headers or add\n      // event listeners here before it's dispatched to the server.\n      //\n      // function (XMLHttpRequest, opt)\n      //    - is passed the request object and the options object that was\n      //      passed to sendTo() with missing fields populated as this.opt.\n      xhrSetup: [],\n\n      // Occurs when a file and XMLHttpRequest were prepared for upload and need\n      // to be sent. It's handled by fd.File.xhrSend() but you might want to\n      // add your logic here.\n      //\n      // function (XMLHttpRequest, data, opt)\n      //    - is passed the request object, options and raw file data that is\n      //      browser-specific (it might not be raw binary stream in some\n      //      older browsers as it is in Firefox and Chrome-based). opt is the\n      //      object passed to sendTo() with missing fields populated as this.opt.\n      xhrSend: [],\n\n      // Occurs during file upload with information on current upload progress.\n      // This happens on browser-sepcific intervals and usually on somewhat large\n      // files only.\n      //\n      // function (sentBytes, totalBytes, XMLHttpRequest, eventObject)\n      //    - is passed two integers (already uploaded bytes and total amount\n      //      of data - local file size, of which first or both might be unset\n      //      if browser can't provide this info), the request object that is\n      //      uploading this file and native browser event object that was\n      //      given to the XHR's event handler of fd.File.\n      progress: [],\n\n      // Occurs when a file has successfully finished uploading.\n      //\n      // function (XMLHttpRequest, eventObject)\n      //    - is passed the request object that was used to upload the file and\n      //      native browser event object that was given to the XHR's event handler\n      //      of fd.File.\n      done: [],\n\n      // Occurs when a file has failed during upload much like regular XHR error.\n      // Note that \"failing\" means all response code except for 200 - even 2xx like\n      // 202 Accepted (WebDAV and such) or 3xx (redirects).\n      // This isn't called when upload was aborted - if you specifically need to\n      // track this call fd.addEvent(fileObject, 'abort', function ...).\n      //\n      // function (eventObject, [XMLHttpRequest])\n      //    - using passed objects you can determine the type of error as you\n      //      would outside of FileDrop - e.g. by XMLHttpRequest.statusText.\n      //      If XHR object is not passed this marks an error that has occurred\n      //      while reading file from local file system with readAsArrayBuffer().\n      error: []\n    }\n\n    // Old FireDrop compatibility. Now deprecated.\n    self.events.sendXHR \x3d self.events.xhrSend\n\n    /***\n      File Methods\n     ***/\n\n    // Aborts current upload, if any.\n    //\n    //? file.abort()\n    self.abort \x3d function () {\n      self.xhr \x26\x26 self.xhr.abort \x26\x26 self.xhr.abort()\n      return self\n    }\n\n    // Submits the dropped file to the server script at given URL and with\n    // optional options (fields default to this fd.File.opt).\n    // Incapsulates browser-specific logic behind reading a local file.\n    // If an upload request has been already made on this fd.File instance will\n    // abort it (unless it's finished) and start anew.\n    //\n    //? sendTo('http://my.host/upload.php?var\x3dfoo\x26var2\x3d123')\n    //? sendTo('upload.php', {method: 'PUT'})\n    self.sendTo \x3d function (url, opt) {\n      opt \x3d global.extend(opt, self.opt)\n      opt.url \x3d url\n\n      if (!self.size) {\n        // Zero size also indicates that it might be a directory.\n        global.hasConsole \x26\x26 console.warn('Trying to send an empty FileDrop.File.')\n        // FileReader crashes Chrome for large files. Only use FileReader for\n        // files less than 50MB\n      } else if (self.size \x3c 50000000 \x26\x26 window.FileReader) {\n        // Using Firefox FileAPI.\n        var reader \x3d new FileReader\n\n        reader.onload \x3d function (e) { self.sendDataReadyTo(opt, e) }\n        reader.onerror \x3d function (e) { global.callAllOfObject(self, 'error', [e]) }\n\n        reader.readAsArrayBuffer(self.nativeFile)\n      } else {\n        // Using early Chrome/Safari File API.\n        self.sendDataReadyTo(opt)\n      }\n\n      return self\n    }\n\n    // Internal method that's called when file data was read and is ready for\n    // upload. For FileAPI (Firefox) gets called on readAsArrayBuffer() onload\n    // event; for Safari/early Chrome it's called immediately and gets passed\n    // the native file object itself.\n    self.sendDataReadyTo \x3d function (opt, e) {\n      self.abort()\n\n      self.xhr \x3d global.newXHR()\n      self.hookXHR(self.xhr)\n\n      self.xhr.open(opt.method, opt.url, true)\n      // Missing in IE.\n      self.xhr.overrideMimeType \x26\x26 self.xhr.overrideMimeType('application/octet-stream')\n      self.xhr.setRequestHeader('Content-Type', 'application/octet-stream')\n\n      if (opt.extraHeaders) {\n        self.xhr.setRequestHeader('X-File-Name', encodeURIComponent(self.name))\n        self.xhr.setRequestHeader('X-File-Size', self.size)\n        self.xhr.setRequestHeader('X-File-Type', self.type)\n        self.xhr.setRequestHeader('X-File-Date', self.modDate.toGMTString())\n\n        var reqWith \x3d opt.xRequestedWith\n        if (reqWith \x3d\x3d\x3d true) {\n          var api \x3d window.FileReader ? 'FileAPI' : 'Webkit'\n          reqWith \x3d 'FileDrop-XHR-' + api\n        }\n\n        reqWith \x26\x26 self.xhr.setRequestHeader('X-Requested-With', reqWith)\n      }\n\n      global.callAllOfObject(self, 'xhrSetup', [self.xhr, opt])\n\n      // Some browsers allow reading raw data, some don't. See if ours allows\n      // and if not then it should support just passing the native file object\n      // to XMLHttpRequest.send().\n      var data \x3d (e \x26\x26 e.target \x26\x26 e.target.result) ? e.target.result : self.nativeFile\n      global.callAllOfObject(self, 'xhrSend', [self.xhr, data, opt])\n      return self.xhr\n    }\n\n    // Attaches internal event listeners to the XMLHttpRequest object that is\n    // used to upload the dropped file. Not all browsers trigger upload events\n    // on the XHR object itself (hence evtHost).\n    self.hookXHR \x3d function (xhr) {\n      var evtHost \x3d xhr.upload || xhr\n\n      xhr.onreadystatechange \x3d function (e) {\n        if (xhr.readyState \x3d\x3d 4) {\n          try {\n            var event \x3d xhr.status \x3d\x3d 200 ? 'done' : 'error'\n          } catch (e) {\n            var event \x3d 'error'\n          }\n\n          var args \x3d event \x3d\x3d 'error' ? [e, xhr] : [xhr, e]\n          global.callAllOfObject(self, event, args)\n        }\n      }\n\n      evtHost.onprogress \x3d function (e) {\n        var current \x3d e.lengthComputable ? e.loaded : null\n        global.callAllOfObject(self, 'progress', [current, e.total || null, xhr, e])\n      }\n    }\n\n    // Browser-independent way of reading binary data. Doesn't work on all browsers.\n    // Asynchronous. If onError is omitted then onDone is called with the usual\n    // arguments (errorObject). If onError is false errors are not reported\n    // (onDone not called).\n    //\n    // Third parameter specifies the way to read the file and if omitted or 'bin'\n    // reads binary data, if 'url', 'uri' or 'src' reads Data URI (very nice for\n    // generating thumbnails), if 'array' reads it as ArrayBuffer, if 'text' reads\n    // data as UTF-8 string, if starts with 'read' is assumed to be a method name on\n    // native File object which will be called. Any other string value istreated as\n    // character encoding (e.g. 'cp1251') and data is read as text in that encoding.\n    // If 3rd parameter is an array its first element is treated as File's method\n    // name and all other parameters are parameters for that method.\n    //\n    // Note that readAsBinaryString() is deprecated, missing in IE 10 and simulated\n    // by FileDrop using readAsArrayBuffer().\n    //\n    // errorObject will fdError string property describing the type of the problem:\n    // 1. 'read'      - browser has failed to read file data.\n    // 2. 'support'   - browser doesn't support File API.\n    //\n    // onDone   \x3d function (string|array)\n    // onError  \x3d function (errorObject)\n    //\n    //?\n    //  readData(function (uri) { byID('myImg').src \x3d uri },\n    //           function (e) { alert('Terrible error!') },\n    //           'uri')\n    //      // reads dropped image into a thumbnail (Data URI).\n    //\n    //? readData(function (bytes) { alert(bytes) }, false)\n    //      // shows message with raw read byte string.\n    //\n    //? readData(function (bytes) { alert(bytes) }, false, 'bin')\n    //      // identical to above.\n    //\n    //? readData(function (bytes) { alert(bytes) }, false, 'readAsBinaryString')\n    //      // identical to above.\n    //\n    //? readData(function (bytes) { alert(bytes) }, false, ['readAsBinaryString'])\n    //      // identical to above but won't automatically fall back to\n    //      // readAsArrayBuffer() failing in IE and early Chrome.\n    //\n    //? readData(function (bytes) { alert(Array.prototype.slice.call(bytes)) }, false, 'array')\n    //      // shows message with comma-separated list of byte values.\n    //\n    //? readData(function (str) { alert(str) }, false, 'cp1251')\n    //      // shows message with file read as a string in CP-1251 charset.\n    //\n    //? readData(function (str) { alert(str), false, ['readAsText', 'cp1251'])\n    //      // identical to above.\n    //\n    //? readData(function (str) { alert(str), false, 'text')\n    //      // similar to above but treats string as UTF-8 encoded (default charset).\n    //\n    //? readData(function (str) { alert(str), false, 'utf-8')\n    //      // identical to above.\n    //\n    //? readData(function (str) { alert(str), false, 'readAsText')\n    //      // identical to above.\n    self.readData \x3d function (onDone, onError, func) {\n      return self.read({onDone: onDone, onError: onError, func: func})\n    }\n\n    // Alias to readData() that reads Data URI suitable for \x3cimg src\x3e attribute.\n    // Unlike readData() if onError isn't passed explicitly it's set to false\n    // (errors suppressed, onDone not called instead).\n    //\n    //?\n    //  readDataURI(function (uri) {\n    //    var img \x3d new Image\n    //    img.src \x3d uri\n    //    document.body.appendChild(img)\n    //  })\n    self.readDataURL \x3d function (onDone, onError) {\n      return self.readData(onDone, onError || false, 'uri')\n    }\n\n    // Alias to readDataURL().\n    self.readDataURI \x3d self.readDataURL;\n\n    // Advanced reading function that can be used to read Blobs and make\n    // slices of this file rather than load the entire data into memory.\n    // Accepts various options, see the code for information.\n    //\n    //? read({onDone: function (str) { alert(str) }, func: 'text', start: 0, end: 5})\n    //    // reads first 4 bytes of the file, treats them as UTF-8 and shows them.\n    self.read \x3d function (opt) {\n      function error(reason, e) {\n        typeof e \x3d\x3d 'object' || (e.message \x3d e)\n        e.fdError \x3d reason\n\n        if (opt.onError !\x3d\x3d false) {\n          (opt.onError || opt.onDone).apply(this, arguments)\n        }\n      }\n\n      global.extend(opt, {\n        // function (data) - gets passed data according to selected func (below).\n        onDone: new Function,\n\n        // function (e), false (errors are not reported), null (calls onDone).\n        onError: null,\n\n        // Target File or Blob object to read data from.\n        blob: self.nativeFile,\n\n        // Reading method alias (e.g. 'uri'), name (e.g. 'readAsText') or\n        // array like ['readAsText', 'arg-1', ...].\n        func: '',\n\n        // New Blob slice options. Negative becomes 0.\n        start: 0,\n\n        // null \x3d this.size. Note that according to W3C byte with this offset\n        // is not included in result (so last byte read is end - 1).\n        // If negative offset is counted from the end (-1 skips last 2 bytes).\n        end: null,\n\n        // contentType assigned to new Blob (empty leaves default).\n        mime: ''\n      })\n\n      if (!window.FileReader) {\n        return error('support', {message:'FileReader not defined'})\n      }\n\n      if (opt.start \x3e 0 || opt.end !\x3d null \x26\x26 opt.end) {\n        if (opt.blob.slice) {\n          opt.end \x3d\x3d null \x26\x26 (opt.end \x3d opt.blob.size || opt.blob.fileSize)\n          opt.blob \x3d opt.blob.slice(opt.start, opt.end, opt.mime)\n        } else if (global.hasConsole) {\n          console.warn('File Blob/slice() are unsupported - operating on entire File.')\n        }\n      }\n\n      var reader \x3d new FileReader\n      reader.onerror \x3d function (e) { error('read', e) }\n\n      reader.onload \x3d function (e) {\n        if (e.target \x26\x26 e.target.result) {\n          if (opt.func \x3d\x3d 'readAsBinaryString') {\n            // Function actually used was readAsArrayBuffer() - see the note below.\n            e.target.result \x3d String.fromCharCode.apply(null, new Uint8Array(e.target.result))\n          }\n\n          opt.onDone(e.target.result)\n        } else {\n          reader.onerror(e)\n        }\n      }\n\n      var func \x3d opt.func\n\n      if (global.isArray(func)) {\n        var name \x3d func[0]\n        func[0] \x3d opt.blob\n        return reader[name].apply(reader, func)\n      } else {\n        if (!func || func \x3d\x3d 'bin') {\n          func \x3d 'readAsBinaryString'\n        } else if (func \x3d\x3d 'url' || func \x3d\x3d 'uri' || func \x3d\x3d 'src') {\n          func \x3d 'readAsDataURL'\n        } else if (func \x3d\x3d 'array') {\n          func \x3d 'readAsArrayBuffer'\n        } else if (func \x3d\x3d 'text') {\n          func \x3d 'readAsText'   // reads as UTF-8 by default.\n        } else if (func.substr(0, 4) !\x3d 'read') {\n          return reader.readAsText(opt.blob, func)\n        }\n\n        // readAsBinaryString() has been deprecated since mid-2012 in favour\n        // of readAsArrayBuffer(). Additionally, IE 10 only supports the latter.\n        // Result that's been read will be converted to string in onload.\n        func \x3d\x3d 'readAsBinaryString' \x26\x26 (func \x3d 'readAsArrayBuffer')\n\n        return reader[func](opt.blob)\n      }\n    }\n\n    // Uses W3C draft File System API to traverse this DirectoryEntry.\n    // Currently supported in Chrome 21+. Spec: http://www.w3.org/TR/file-system-api/\n    // Thanks to @kevinkrouse for pointing me to this wonderful interface.\n    // This function is not recursive.\n    //\n    // onDone is a function callback that receives FileDrop.FileList object.\n    // Each entry there can be either a file or a directory. Files have nativeFile\n    // set (but not in case of error - if so use nativeEntry's isDirectory and\n    // isFile props to determine which one is which). On these, correct files you\n    // can use any of FileDrop methods - sendTo(), readFile(), etc. On directories\n    // (but not failed files) you can use listEntries() to traverse them further.\n    //\n    // onError is an optional function called by the browser when it runs into errors.\n    // It gets passed error object. Note that it might be called multiple times\n    // and that onDone can be still called (this might happen if FileEntry can't\n    // read particular File object when using file()).\n    //\n    //? listEntries(function (files) { files.images().invoke('sendTo', 'upload.php') })\n    //      // sends all images in the dropped directory to upload.php; errors are\n    //      // ignored but if one has occurred while retrieving File API object this\n    //      // call with fail with a JavaScript error - this is fixed by removing\n    //      // all entries with null nativeFile before doing sendTo().\n    //\n    //? listEntries(function (files) { files.each(...) },\n    //              function (e) { alert('File System API error ' + e.code) })\n    self.listEntries \x3d function (onDone, onError) {\n      if (self.nativeEntry \x26\x26 self.nativeEntry.isDirectory) {\n        onError \x3d onError || new Function\n        var reader \x3d self.nativeEntry.createReader()\n        var files \x3d new global.FileList\n        var enqueued \x3d 0\n\n        function dequeue(count) {\n          enqueued -\x3d count\n          if (enqueued \x3d\x3d 0 \x26\x26 onDone) {\n            onDone(files)\n            onDone \x3d null\n          }\n        }\n\n        reader.readEntries(function readList(list) {\n          for (var i \x3d 0; i \x3c list.length; i++) {\n            var nativeEntry \x3d list[i]\n\n            if (nativeEntry.file) {\n              // This entry is a file (FileEntry).\n              enqueued++\n              nativeEntry.file(\n                function (nativeFile) {\n                  var file \x3d new global.File(nativeFile)\n                  file.setNativeEntry(nativeEntry)\n                  files.push(file)\n                  dequeue(1)\n                },\n                function () {\n                  // Error getting a File object. Let's still insert it\n                  // into the resulting list but without nativeFile (which\n                  // makes sendTo(), readData(), etc. unavailable).\n                  files.push( global.File.fromEntry(nativeEntry) )\n                  dequeue(1)\n                  onError.apply(this, arguments)\n                }\n              )\n            } else {\n              // This is a DirectoryEntry. It has no File object (that comes\n              // from File API spec: http://dev.w3.org/2006/webapi/FileAPI/).\n              // Don't try calling sendTo(), readFile() and the likes on the\n              // FileDrop.File items returned in the FileList passed to onDone.\n              files.push( global.File.fromEntry(nativeEntry) )\n            }\n          }\n\n          i ? reader.readEntries(readList, onError) : dequeue(0)\n        }, onError)\n\n        return true\n      }\n    }\n\n    // Internal method to assign data from a native Entry object.\n    self.setNativeEntry \x3d function (item) {\n      self.nativeEntry \x3d item \x26\x26 item.webkitGetAsEntry \x26\x26 item.webkitGetAsEntry()\n    }\n\n    // Adds event listeners to this object. See DropHandle.event() for\n    // extended comment and examples.\n    self.event \x3d function (events, funcs) {\n      return global.appendEventsToObject.apply(self, arguments)\n    }\n\n    // Adds event listeners to this object in front of existing handlers.\n    // Can be used to intercept/override certain events. See DropHandle.event()\n    // for extended comment and examples.\n    self.preview \x3d function (events, funcs) {\n      return global.previewToObject.apply(self, arguments)\n    }\n\n    /***\n      Standard File Event Callbacks\n     ***/\n\n    // Takes care of reading binary stream from file and sending it\n    // to the remote server using prepared XMLHttpRequest.\n    // data is either an ArrayBuffer (Gecko/Chrome) or a native file object\n    // (Safari). Either way, send() handles both. This used to deal with\n    // sendAsBinary() but it's specific to Firefox 3.6 and is removed now.\n    self.onXhrSend \x3d function (xhr, data) {\n      xhr.send(data)\n    }\n\n    self.event({\n      xhrSend:        self.onXhrSend\n    })\n  }\n\n  // Static method of File that creates an object without attaching to any\n  // File API's File object. It's only useful if you have an Entry object\n  // that lets you get at least some of the info (e.g. file name) and list\n  // contents for DirectoryEntry. See listEntries(). Using sendTo(), readData()\n  // and others on such an instance will result in errors.\n  //\n  //? fromEntry( e.dataTransfer.items[0].webkitGetAsEntry() )\n  //      //\x3d\x3e FileDrop.File\n  global.File.fromEntry \x3d function (nativeEntry) {\n    var file \x3d new global.File(nativeEntry)\n    file.setNativeEntry(nativeEntry)\n    file.nativeFile \x3d null\n    return file\n  }\n\n  /***\n    FileDrop jQuery Interface\n   ***\n\n    After both FileDrop and jQuery (v1 or v2) scripts have loaded call fd.jQuery().\n    Don't forget to include/write your FileDrop's CSS as well.\n\n    Once done it becomes possible to access FileDrop as $('#zone').filedrop()\n    and avoid accessing its methods and bind event altogether. FileDrop will\n    trigger events as if they originated from the DOM node itself and prefix\n    each event with either 'fd' (DropHandle/FileDrop classes) or 'file'\n    (File class). Arguments remain the same except that:\n    * jQuery always passes event object as the first argument so just skip it.\n    * File events ('file' prefix) get passed File object as second argument\n      (after jQuery event).\n\n    Note that 'this' points to jQuery collection and no more to the FileDrop\n    or File instance that has initiated the event.\n\n      $('\x3cdiv\x3e\x3cp\x3eDrop something here...\x3c/p\x3e\x3c/div\x3e')\n        .appendTo(document.body)\n        .filedrop()\n        .on('fdsend', function (e, files) {\n          // Occurs when FileDrop's 'send' event is initiated.\n          $.each(files, function (i, file) {\n            file.sendTo('upload.php')\n          })\n        })\n        .on('filedone', function (e, file) {\n          // Occurs when a File object has done uploading.\n          alert('Done uploading ' + file.name + ' on ' + this.tagName)\n        })\n\n    When constructing FileDrop instance by jQuery in addition to regular 'el'\n    property '$el' is set to point to $(el) - zone DOM node as jQuery collection.\n\n    Also, it's still possible to attach listeners to FileDrop object with\n    fd.event('event', func) but these events are called after corresponding\n    DOM events (added with jQuery). If a DOM event handler returns a non-null\n    and non-undefined value - FileDrop's handlers won't be called.\n\n    Event preview handlers ('any' event) can only be attached directly to FileDrop:\n\n      $('#zone')\n        .fildrop()\n        .filedrop().event('any', function () { ... })\n\n    You can access underlying FileDrop object by calling filedrop() without\n    parameters (first such call creates FileDrop, later calls return the\n    instance on the first element in the collection):\n\n      $('#zone')            // select \x3cp id\x3d\"zone\"\x3e\n        .filedrop()         // turn it into a FileDrop zone\n        .css({color: red})  // any normal jQuery code\n        .filedrop()         // retrieve FileDrop object\n        .multiple(true)     // call its method\n\n    Alternatively you can pass a string to filedrop() to select a property\n    or call a method - in this case their value/result is returned\n\n      $('#zone')\n        .filedrop()\n        .filedrop('multiple', true)\n          // returns the new state of 'multiple' option, not jQuery object.\n\n    It's also possible to pass custom options to FileDrop constructor:\n\n      $('#zone')\n        .filedrop({\n          multiple: true,\n          iframe: {url: '/upload.php'}\n        })\n   ***/\n\n  global.jQuery \x3d function ($) {\n    $ \x3d $ || jQuery || window.jQuery\n    if (!$) { throw 'No window.jQuery object to integrate FileDrop into.' }\n\n    $.fn.filedrop \x3d function (options) {\n      function delegate(prefix, firstArgs) {\n        return function (event) {\n          var args \x3d (firstArgs || []).concat(global.toArray(arguments, 1))\n          return $node.triggerHandler((prefix + event).toLowerCase(), args)\n        }\n      }\n\n      var $node \x3d this\n      var host \x3d this.data('filedrop')\n\n      if (typeof options \x3d\x3d 'string') {\n        if (!host) {\n          $.error(\"$.filedrop('comment') needs an initialized FilrDrop on this element.\")\n        } else if (typeof host[options] \x3d\x3d 'undefined') {\n          $.error(\"There's no method or property FileDrop.\" + options + \".\")\n        } else {\n          var value \x3d host[options]\n          if (typeof value \x3d\x3d 'function') {\n            return value.apply(host, global.toArray(arguments, 1))\n          } else {\n            return value\n          }\n        }\n      } else if (!options || typeof options \x3d\x3d 'object') {\n        if (!host) {\n          var zone \x3d new FileDrop(this[0], options)\n          zone.$el \x3d $(this)\n          this.first().data('filedrop', zone)\n\n          zone.event('any', delegate('fd'))\n\n          zone.on.fileSetup.push(function (file) {\n            file.event('any', delegate('file', [file]))\n          })\n        } else if (!options) {\n          return host\n        } else {\n          global.extend(host.opt, options, true)\n        }\n      } else {\n        $.error('Invalid $.filedrop() parameter - expected nothing (creates new zone),' +\n                ' a string (property to access) or an object (custom zone options).')\n      }\n\n      return $node\n    }\n  }\n\n  // Alias window.fd.FileDrop class to just window.FileDrop since it's most used.\n  root.FileDrop \x3d global.FileDrop\n});\n"},
249:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});var c,b=f.MediaLibrary=window.MediaLibrary={loadOptions:{accepts:"all"},imageExtensions:{jpeg:"i",jpg:"i",gif:"i",png:"i",bmp:"i",tiff:"i",tif:"i"},documentExtensions:{pdf:"d"},videoExtensions:{mov:"v",avi:"v",mp4:"v",mpeg:"v",wmv:"v",ogg:"v",flv:"v"},_loaded:!1,events:null,container:null,itemFilter:"all",initialize:function(){this.allExtensions=Object.merge(Object.clone(this.imageExtensions),this.documentExtensions,this.videoExtensions);
Modal.addEvents({onMediaLibraryLoad:function(a,b,c){this.mediaItems=[];this.thumbnails=[];this._loaded=!0;this.events=new Events;this.events.addEvents(b.events);this.container=a.getElement("#mediaLibrary");this._deleteAll=$("deleteAllMedia");this.loadOptions=Object.append(this.loadOptions,b);this.mediaFilterName=(this.mediaTarget=b.target)?this.mediaTarget.getMediaFilterName():null;clickSafe($("libraryCloseBtn"),function(){Modal.cancel()});this._initNavigation();this.uploadUrl=$("mediaUploadFallback").action;
this.mediaUploadArea=$("mediaUpload");this.createUploader();this.browseWindow=$("mediaBrowse");this.alertsContainer=this.container.getElement(".statuses");this._setupDeleteAll();this.setupSorting();this._loadItems(c)}.bind(this),onMediaLibraryUnload:function(){this._loaded=!1;delete this.events}.bind(this)})},_loadItems:function(a){var c=this,d=c.loadOptions.attachedItems,e=a.items;c.itemFilter=a.itemFilter;c._initFilters();c.events.fireEvent("itemCountChanged");e.reverse().each(function(a){a=MediaItem.createFromData(a);
var b=d[a.getGlobalID()];c.addItem(a,b)});$("addMedia").addEvents({"click:relay(.js-url-embed-submit)":function(a,d){a=Object.keys(b.imageExtensions);a=new RegExp(a.join("|"));d=$E(".js-url-embed-link").value;var e=d.match(a);a={url:d};(new Request.API_2_0(e?"user/media/images/url":"user/media/embed",{method:"post",onSuccess:function(a){var b=new Future,d=MediaItem.createFromData(a,{},b),k=e?a.guid:a.objectid;(new Request.AjaxIO("isMediaItemReady",{onComplete:function(a){a.error?b.error(a.error):
b.resolve(a)}})).ping(k,a.type,c.mediaFilterName);c.addItem(d,!1)},onFailure:function(a,c){b.appendAlertMessage(c,"error")}})).send(a);c._toggleView()}});$("mediaLibrary").addEvents({"click:relay(.js-toggle-selected)":function(a,b){a=b.hasClass("selected");$$(".js-toggle-target").removeClass("toggle-open");$$(".js-toggle-selected").removeClass("selected");var c=b.getParent().getElement(".js-toggle-target");a?(c.removeClass("toggle-open"),b.removeClass("selected")):(c.addClass("toggle-open"),b.addClass("selected"))},
"click:relay(.js-toggle-target)":function(a,b){$$(".js-toggle-target").removeClass("toggle-open");$$(".js-toggle-selected").removeClass("selected");a=$E(".sortOption.active").get("text");$E(".js-current-sort-name").set("text",a)}})},showForTarget:function(a,b,c){var d=a.getMediaFilterName()||this.loadOptions.accepts;a=Modal.open.pass([{type:"module",name:"MediaLibrary",boxClass:"mediaLibraryModalBox",clientOptions:{target:a,attachedItems:c,events:{itemSelected:b}},serverOptions:{accepts:d},onCancel:b}],
Modal);Auth.isLoggedIn()?a():Auth.required({onAuthorize:a,onCancel:b})},dismissAlerts:function(){this.alertsContainer.getChildren().each(function(a){a=a.getChildren(".close-status").pick();null!=a&&a.fireEvent("click")})},_appendAlert:function(a){var b=this.alertsContainer.getChildren(),c=!0;b.length&&b.each(function(b){var d=b.getElement("span.status-count"),e=!1;d||((d=new Element("span.status-count",{text:" x 1"})).set("data-count",1),e=!0);var k=parseInt(d.get("data-count"),10);a.get("data-text")===
b.get("data-text")&&(e=k+1,d.set("text","x "+e),d.set("data-count",e),e&&b.grab(d),c=!1)});c&&this.alertsContainer.grab(a,"top");$("libraryContent").scrollTo(0,0)},appendAlertMessage:function(a,b){a=Utils.createAlert(b||"error",a);this._appendAlert(a)},createUploader:function(){function b(a){return m[a]||(m[a]=new d(p[a]),m[a].element.inject(c.browseWindow,"top"),c.events.fireEvent("itemCountChanged")),m[a]}var c=this,m={},p={},f=new a({uploadUrl:this.uploadUrl,container:this.mediaUploadArea});(new g(f,
{mediaFilterName:this.mediaFilterName})).addEvent("added",function(a,d,e){p[a]=e;c._toggleView(!0);c._selectFilter("all");b(a).setFilename(d)}).addEvent("error",function(a,d,e,k){if(null!==a&&(b(a).dispose(),delete m[a]),k&&k.fireEvent("deleted"),e)a=Utils.createAlert("error",e),c._appendAlert(a),c._toggleView(!0)}).addEvent("progress",function(a,c,d){b(a).setFilename(c).setProgress(d)}).addEvent("upload",function(a,c){this.addItem(c,!1,b(a).element);delete m[a]}.bind(this))},addItem:function(a,b,
c){var d=this;a.setContext(d);var e=a.getLargestImageSize("standard"),k=a.createDisplay(e,!0);e=k.getElement();return b&&e.hide(),"element"==typeOf(c)?e.replaces(c):e.inject(d.browseWindow,c||"top"),k.addEvent("select",function(a){d._loaded&&d.events.fireEvent("itemSelected",a)}),a.addEvent("deleted",function(){d._loaded&&(d.removeItem(this),d.thumbnails.erase(k))}),d.mediaItems.push(a),d.thumbnails.push(k),d.events.fireEvent("itemCountChanged"),$("libraryContent").focus(),a},removeItem:function(a){this.events.fireEvent("itemCountChanged");
this.mediaItems.erase(a);(new Request.AjaxIO("removeFromLibrary",{})).send(a.getID(),a.getType())},setupSorting:function(){var a={filename:function(a,b){a=a.mediaItem.data.filename();b=b.mediaItem.data.filename();return a.localeCompare(b)},date:function(a,b){a=a.mediaItem.data.date();b=b.mediaItem.data.date();return a<b?1:a>b?-1:0}},b=this,c=$$(".sortOption");c.addEvent("click",function(d){var e=d.target.get("data-comparator");b.setSortComparator(a[e]);c.removeClass("active");d.target.addClass("active")})},
setSortComparator:function(a){this.thumbnails.sort(a);var b=this;this.thumbnails.each(function(a){b.browseWindow.grab(a.getElement(),"bottom")})},getMenuItems:function(a){return{copy:!1}},getItemCount:function(){return $$("#mediaBrowse \x3e .mediaItem").filter(function(a,b){return"none"!=a.getStyle("display")}).length},_toggleView:(c=!0,function(a){c=arguments.length?a:!c;$("mediaLibrary").toggle(c);$("addMedia").toggle(!c);var b=$("addMedia").parentElement;c?b.setStyle("max-width",""):b.setStyle("max-width",
"663px")}),_initNavigation:function(){$$(".mediaManagerNav").addEvent("click",function(a){this._toggleView()}.bind(this));$$("#emptyBrowseNotice button").addEvent("click",function(a){this._toggleView()}.bind(this))},_initFilters:function(){var a=this;$$(".itemFilter").addEvent("click",function(b){a._selectFilter(this.get("data-filter"))});a._selectFilter(a.itemFilter);var b=$("emptyBrowseNotice"),c=$("mediaItemCount");a.events.addEvent("itemCountChanged",function(){var d=a.getItemCount(),e=0===d;
c.set("text",d);b.toggle(e)})},_selectFilter:function(a){var b=$$(".itemFilter"),c=this;c.dismissAlerts();b.each(function(b){var d=b.get("data-filter")===a;b.toggleClass("active",d);d&&(c._deleteAll.set("html",b.get("data-deleteAllText")),c.itemFilter=b.get("data-filter"))});b=$E(".itemFilter.active").get("text");$E(".js-current-display-name").set("text",b);b=$E(".sortOption.active").get("text");$E(".js-current-sort-name").set("text",b);c.browseWindow.set("class",a);c.events.fireEvent("itemCountChanged")},
_setupDeleteAll:function(){var a=this._deleteAll,b=this,c=!1;this.events.addEvent("itemCountChanged",function(){a.toggle(0<b.getItemCount())});a.hide();a.addEvent("click",function(a){if(a.stop(),!c){c=!0;a=$$(".itemFilter.active").pick().get("text").toLowerCase();var d=_js("Are you sure you want to delete ALL your ");a=Utils.createAlertPrompt("notice",d+("all"===a?"media":a)+"?",function(a){c=!1;a&&b.mediaItems.clean().each(function(a){var c=b.itemFilter;"all"!==c&&c!==a.getFilter()||a.deleted()})});
b._appendAlert(a)}})}};Object.append(b,Utils.EventsFunctions);b.initialize();var a=f.FileDropUploader=window.FileDropUploader=new Class({Implements:[Options,Events],options:{uploadUrl:"",container:null},initialize:function(a){var c=this,d=Object.keys(b.imageExtensions),e=Object.keys(b.documentExtensions),g=Object.keys(b.videoExtensions);d=(d.concat(e,g),d.join(", ").toUpperCase());e=e.join(", ").toUpperCase();g=g.join(", ").toUpperCase();var f=_js("File size limit: %1 MB. Video length limit: %2 seconds.").replace("%1",
App.maxMediaSize).replace("%2",App.maxMediaLength);this.setOptions(a);_js("browse");var h=Date.now(),l=function(){return c.options.uploadUrl+"?uploadBatchId\x3d"+h+"\x26csrf\x3d"+CSRF.get()};a=window.hbsTemplates("MEDIA_LIBRARY_UPLOADER_HBS")({imageExtensionText:d,documentExtensionText:e,videoExtensionText:g,limitMessage:f});a.inject(this.options.container);var n=function(a){var b=0,c=[];return{send:function(a){3>b?(b++,window.setTimeout(a)):c.push(a)},next:function(){b--;if(0<c.length){var a=c.pop();
b++;window.setTimeout(a)}}}}();window.fd.logging=!1;d=function(a,b){var d={multiple:!0};b?d.iframe={url:l(),callbackParam:"fd-callback",fileParam:"file"}:d.input=!1;a=new FileDrop(a,d);var e=function(a,b){a.event("progress",function(d,e){c.fireEvent("progress",[b,a.name,d&&e&&d/e||0]);!0});a.event("done",function(d){n.next();d=JSON.parse(d.response);var e=_js("Unknown error while uploading file: %1").replace("%1",a.name);if(d&&d.success)c.fireEvent("upload",[b,a.name,d]);else{if(d&&d.error){var k=
d.error;d.filename&&k.message?e=d.filename+": "+k.message:d.filename?e=_js("Unknown error while uploading file: %1").replace("%1",d.filename):k.message&&(e=a.name+": "+k.message)}c.fireEvent("error",[b,a.name,e])}});a.event("error",function(d,e){d=_js("Unknown error while uploading file: %1").replace("%1",a.name);c.fireEvent("error",[b,a.name,d]);n.next()});n.send(function(){a.sendTo(l()+"\x26file\x3d"+encodeURIComponent(a.name)+"\x26uploadIndex\x3d"+encodeURIComponent(b))});c.fireEvent("added",[b,
a.name,a.abort.bind(a)])};return a.event("send",function(a){h=Date.now();a.each(e)}),a.event("iframeSetup",function(a){a.action=l();c.fireEvent("added",["a","uploading",null]);c.fireEvent("progress",["a","uploading",0])}),a.event("iframeDone",function(a){if(a.error){var b=a.error;b&&a.filename&&b.message&&(b=a.filename+": "+b.message);c.fireEvent("error",["a",a.filename,b])}else c.fireEvent("upload",["a","uploading",a])}),a};d(a,!0);d($("libraryContent"))}}),g=f.MediaItemUploader=window.MediaItemUploader=
new Class({_items:{},Implements:[Options,Events],initialize:function(a,b){this.setOptions(b);a.addEvent("upload",function(b,c,d){var e=new Future,k=MediaItem.createFromData(d,{},e);e.getValue(function(b,c){c&&a.fireEvent("error",[d.imageid,d.filename,c,k])});(new Request.AjaxIO("isMediaItemReady",{onComplete:function(a){a.error?e.error(a.error):e.resolve(a)}})).ping(d.guid,d.type,this.options.mediaFilterName);this.fireEvent("upload",[b,k,c])}.bind(this));Utils.passEvent("added",a,this);Utils.passEvent("error",
a,this);Utils.passEvent("progress",a,this);Utils.passEvent("clobber",a,this)}}),d=f.UploadingItem=window.UploadingItem=new Class({initialize:function(a){var b=this,c=this.element=new Element("div.mediaItem.uploading"),d=this.spacer=new Element("div.spacer"),e=this.fileEl=new Element("span.file-container"),g=this.filenameEl=new Element("span.filename"),f=this.filetypeEl=new Element("span.filetype"),h=this.percentEl=new Element("span.percent"),l=this.percentBar=new Element("div.percentBar");if(d.grab(h),
d.grab(l),a)h=(new Element("div.cancel.close")).set("html","\x26times;").addEvent("click",function(){b.dispose();a()}),d.grab(h);c.grab(d);e.grab(g);e.grab(f);c.grab(e);this.setProgress(0)},setFilename:function(a){a&&!this._filenameSet&&(this._filenameSet=!0,this.filenameEl.set({text:a,title:a}),a=a.match(/\.[^.]+$/))&&(a=b.allExtensions[a[0].substring(1).toLowerCase()],this.element.addClass({i:"mediaImage",v:"mediaVideo",d:"mediaDocument"}[a]));return this},setProgress:function(a){var b=Math.round(100*
a)+"%";return this.percentEl.set("text",b),this.percentBar.setStyle("width",b),1<=a&&this.clearProgress(),this},dispose:function(){this.element.dispose()},clearProgress:function(){var a=this;return a.element.addClass("mediaItemProcessing"),TweenMax.to(a.spacer,.5,{opacity:0}),setTimeout(function(){a.percentBar.dispose();a.percentEl.dispose();a.spacer.dispose()},1E3),a}})},250:function(l,f,h){h(12)(h(251))},251:function(l,f){l.exports="(function (window) {\n\n  var StateMachine \x3d {\n\n    //---------------------------------------------------------------------------\n\n    VERSION: \"2.2.0\",\n\n    //---------------------------------------------------------------------------\n\n    Result: {\n      SUCCEEDED:    1, // the event transitioned successfully from one state to another\n      NOTRANSITION: 2, // the event was successfull but no state transition was necessary\n      CANCELLED:    3, // the event was cancelled by the caller in a beforeEvent callback\n      ASYNC:        4 // the event is asynchronous and the caller is in control of when the transition occurs\n    },\n\n    Error: {\n      INVALID_TRANSITION: 100, // caller tried to fire an event that was innapropriate in the current state\n      PENDING_TRANSITION: 200, // caller tried to fire an event while an async transition was still pending\n      INVALID_CALLBACK:   300 // caller provided callback function threw an exception\n    },\n\n    WILDCARD: '*',\n    ASYNC: 'async',\n\n    //---------------------------------------------------------------------------\n\n    create: function(cfg, target) {\n\n      var initial   \x3d (typeof cfg.initial \x3d\x3d 'string') ? { state: cfg.initial } : cfg.initial; // allow for a simple string, or an object with { state: 'foo', event: 'setup', defer: true|false }\n      var fsm       \x3d target || cfg.target  || {};\n      var events    \x3d cfg.events || [];\n      var callbacks \x3d cfg.callbacks || {};\n      var map       \x3d {};\n\n      var add \x3d function(e) {\n        var from \x3d (e.from instanceof Array) ? e.from : (e.from ? [e.from] : [StateMachine.WILDCARD]); // allow 'wildcard' transition if 'from' is not specified\n        map[e.name] \x3d map[e.name] || {};\n        for (var n \x3d 0 ; n \x3c from.length ; n++)\n          map[e.name][from[n]] \x3d e.to || from[n]; // allow no-op transition if 'to' is not specified\n      };\n\n      if (initial) {\n        initial.event \x3d initial.event || 'startup';\n        add({ name: initial.event, from: 'none', to: initial.state });\n      }\n\n      for(var n \x3d 0 ; n \x3c events.length ; n++)\n        add(events[n]);\n\n      for(var name in map) {\n        if (map.hasOwnProperty(name))\n          fsm[name] \x3d StateMachine.buildEvent(name, map[name]);\n      }\n\n      for(var name in callbacks) {\n        if (callbacks.hasOwnProperty(name))\n          fsm[name] \x3d callbacks[name]\n      }\n\n      fsm.current \x3d 'none';\n      fsm.is      \x3d function(state) { return this.current \x3d\x3d state; };\n      fsm.can     \x3d function(event) { return !this.transition \x26\x26 (map[event].hasOwnProperty(this.current) || map[event].hasOwnProperty(StateMachine.WILDCARD)); }\n      fsm.cannot  \x3d function(event) { return !this.can(event); };\n      fsm.error   \x3d cfg.error || function(name, from, to, args, error, msg, e) { throw e || msg; }; // default behavior when something unexpected happens is to throw an exception, but caller can override this behavior if desired (see github issue #3 and #17)\n\n      if (initial \x26\x26 !initial.defer)\n        fsm[initial.event]();\n\n      return fsm;\n\n    },\n\n    //\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\n\n    doCallback: function(fsm, func, name, from, to, args) {\n      if (func) {\n        try {\n          return func.apply(fsm, [name, from, to].concat(args));\n        }\n        catch(e) {\n          return fsm.error(name, from, to, args, StateMachine.Error.INVALID_CALLBACK, \"an exception occurred in a caller-provided callback function\", e);\n        }\n      }\n    },\n\n    beforeEvent: function(fsm, name, from, to, args) { return StateMachine.doCallback(fsm, fsm['onbefore' + name],                     name, from, to, args); },\n    afterEvent:  function(fsm, name, from, to, args) { return StateMachine.doCallback(fsm, fsm['onafter'  + name] || fsm['on' + name], name, from, to, args); },\n    leaveState:  function(fsm, name, from, to, args) { return StateMachine.doCallback(fsm, fsm['onleave'  + from],                     name, from, to, args); },\n    enterState:  function(fsm, name, from, to, args) { return StateMachine.doCallback(fsm, fsm['onenter'  + to]   || fsm['on' + to],   name, from, to, args); },\n    changeState: function(fsm, name, from, to, args) { return StateMachine.doCallback(fsm, fsm['onchangestate'],                       name, from, to, args); },\n\n\n    buildEvent: function(name, map) {\n      return function() {\n\n        var from  \x3d this.current;\n        var to    \x3d map[from] || map[StateMachine.WILDCARD] || from;\n        var args  \x3d Array.prototype.slice.call(arguments); // turn arguments into pure array\n\n        if (this.transition)\n          return this.error(name, from, to, args, StateMachine.Error.PENDING_TRANSITION, \"event \" + name + \" inappropriate because previous transition did not complete\");\n\n        if (this.cannot(name))\n          return this.error(name, from, to, args, StateMachine.Error.INVALID_TRANSITION, \"event \" + name + \" inappropriate in current state \" + this.current);\n\n        if (false \x3d\x3d\x3d StateMachine.beforeEvent(this, name, from, to, args))\n          return StateMachine.CANCELLED;\n\n        if (from \x3d\x3d\x3d to) {\n          StateMachine.afterEvent(this, name, from, to, args);\n          return StateMachine.NOTRANSITION;\n        }\n\n        // prepare a transition method for use EITHER lower down, or by caller if they want an async transition (indicated by an ASYNC return value from leaveState)\n        var fsm \x3d this;\n        this.transition \x3d function() {\n          fsm.transition \x3d null; // this method should only ever be called once\n          fsm.current \x3d to;\n          StateMachine.enterState( fsm, name, from, to, args);\n          StateMachine.changeState(fsm, name, from, to, args);\n          StateMachine.afterEvent( fsm, name, from, to, args);\n        };\n        this.transition.cancel \x3d function() { // provide a way for caller to cancel async transition if desired (issue #22)\n          fsm.transition \x3d null;\n          StateMachine.afterEvent(fsm, name, from, to, args);\n        }\n\n        var leave \x3d StateMachine.leaveState(this, name, from, to, args);\n        if (false \x3d\x3d\x3d leave) {\n          this.transition \x3d null;\n          return StateMachine.CANCELLED;\n        }\n        else if (\"async\" \x3d\x3d\x3d leave) {\n          return StateMachine.ASYNC;\n        }\n        else {\n          if (this.transition)\n            this.transition(); // in case user manually called transition() but forgot to return ASYNC\n          return StateMachine.SUCCEEDED;\n        }\n\n      };\n    }\n\n  }; // StateMachine\n\n  //\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\x3d\n\n  if (\"function\" \x3d\x3d\x3d typeof define) {\n    define(function(require) { return StateMachine; });\n  }\n  else {\n    window.StateMachine \x3d StateMachine;\n  }\n\n}(this));\n\n"},
253:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});var c=f.MediaItem=window.MediaItem=new Class({Implements:[Options,Events],options:{enableCrop:!0,enableMarkers:!0,min:{width:800,height:600},cropMin:{width:96,height:96},ratio:"FOUR_THREE"},medium:{width:592,height:444},initialize:function(a,b,c){this.setOptions(b);this.storage=new Hash;c?(this.setData(a,!0),this.setDataPromise(c)):this.setData(a)},_setLoading:function(a){a=!!a;this.isLoading!=a&&(this.isLoading=a,this.fireEvent("loadingChanged",
[a]))},setData:function(a,c){a instanceof b||(a=new b(a));this.data=a;c||this.fireEvent("dataChanged",[this])},setDataPromise:function(a){var b=this;this.dataPromise=a;a.isResolved()||b._setLoading(!0);a.getValue(function(a,c){c?alert(c):b.setData(a);delete b.dataPromise;b._setLoading(!1)})},whenReady:function(a,b){return this.dataPromise?(!this.dataPromise.isResolved()&&b&&b(),this.dataPromise.getValue(a,b)):(a&&a(),!0)},deleted:function(){this.fireEvent("deleted",[this]);this.removeEvents()},isReady:function(){var a=
this.dataPromise;return!a||a.isResolved()},setContext:function(a){this.context=a},getContext:function(){return this.context},getElement:function(){return this.container},_getMenuOptions:function(){return{deleted:!0,copy:!0}},getLargestImageSize:function(a){for(a=a?c.sizes.indexOf(a):c.sizes.length-1;0<=a;a--){var b=c.sizes[a],d=this.data;if(d[b]&&d[b]())return b}},collectMenuOptions:function(){var a=c.prototype._getMenuOptions.call(this);return Object.append(a,this._getMenuOptions()),this.context&&
Object.append(a,this.context.getMenuItems(this)),a},store:function(a,b){this.storage.set(a,b)},retrieve:function(a,b){var c=this.storage.get(a);return!c&&b&&(c=b,this.storage.set(a,c)),c},createRepresentationFor:function(a,b){},getID:function(){},getType:function(){},getGlobalID:function(){},copyToMediaLibrary:function(){c.copyToMediaLibrary(this.getID(),this.getType())}});c.extend({copyToMediaLibrary:function(a,b,c,e){var d=new LoadingStatus(e||$(document.body));d.loading(_js("Copying to library..."));
(new Request.AjaxIO("copyToLibrary",{onSuccess:function(e){d.doneLoading.delay("GuideVideoObject"===b||"GuideEmbedObject"===b?1E3:0,d);c&&c(e,a)},onFailure:function(){d.doneLoading();d.loading(_js("Internal Error: Failed copying to library."));d.doneLoading.delay(3E3,d)},onError:function(a){d.doneLoading();var b=new StatusNotice;$$("#guideSteps .statuses").adopt(b.element);b.error(a.error);b.addCloseButton()}})).send(a,b)},createMenuControl:function(a){if(a&&a.context&&a.context.options&&"all"===
a.context.options.menuHide)return null;var b=new Element("div.menuControl"),d=new Element("i.fa.fa-cog"),e=new Element("div.edit-text");return e.setProperties({text:_js("edit").toUpperCase()}),e.grab(d),b.grab(e),b.addEvent("click",function(d){d.stop();c.fireEvent("toggleMenu",[a,b])}),b.store("mediaItem",a),b},createFromData:function(a,c,d){return a=new b(a),new (0,this.types[a.type()])(a,c,d)},types:{},registerType:function(a,b){this.types[a]=b},sizes:"mini thumbnail standard medium large huge original".split(" "),
isSizeAsBigAs:function(a,b){var c=this.sizes.indexOf(b),e=this.sizes.indexOf(a);if(-1===c||-1===e)throw a=[b,a].join(),Error("One of ["+a+"] is not a valid image size.");return e>=c}});Object.append(c,Utils.EventsFunctions);var b=f.MediaItemData=window.MediaItemData=StrictObject.define("filename title type provider date srcid imageid encoding documentid objectid videoid document_extension document_type document_group guid ratio active mini thumbnail standard medium original view_url edit_url video_urls width height markup markup_string scaled_width scaled_height filter_state html".split(" "))},
254:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});var c=f.MediaTarget=window.MediaTarget=new Class({Implements:[Options,Events],options:{getErrorMessage:function(){return _js("Can't place this item here.")}},element:null,mediaid:null,_isDirty:!1,initialize:function(b,a){this.element=$(b);var c=this,d=this.options;d.accepts=b.get("data-accepts");d.displaySize=b.get("data-displaySize");d.formField=$(b.get("data-formField"));d.menuHide=b.get("data-menuHide");Object.append(d,a);b.contains(d.formField)&&
(this._formFieldIsInside=!0);b.store("mediaTarget",this);this._content=b.getElement(".contents");a=this._updateFormField.bind(this);this._mediaItemEventHandlers={dataChanged:a,deleted:function(){c.attachItem(null)}};this.addEvent("itemChanged",a);b.addClass("mediaTarget");(b=b.get("data-itemData"))?(b=MediaItem.createFromData(JSON.decode(b)),this._immediatelyAttach(b),this._isDirty=!1):this._displayItem();this._onclick=function(){this.hasClass("js-no-browse")||c.fireEvent("browse")};this._enableUI()},
_enableUI:function(){this.element.removeEvents("click");this.element.addEvent("click",this._onclick);this.element.removeClass("disabled");this._disabledOverlay&&this._disabledOverlay.dispose();var b=this.element.getElement(".alterTarget");b&&b.removeClass("disabled")},enable:function(){this._enableUI()},_disableUI:function(){this.element.removeEvents("click");this.element.addClass("disabled");this._disabledOverlay=this._disabledOverlay||new Element("div.disabledOverlay");this.element.grab(this._disabledOverlay);
when(this.element.getElement(".alterTarget"),function(b){b.addClass("disabled")})},disable:function(){this._disableUI()},getErrorMessage:function(b){return this.options.getErrorMessage(b)},clear:function(){this._displayItem(null)},_displayItem:function(b){var a=this;if(!b){a._empty();b=new Element("div.contents");var g=this.options.displaySize,d=a.options.iconClass||"addImage";return b.addClass(g),b.grab(c.createModifyableIndicator(d,g)),void a.element.grab(b)}a._displayLoading(!0);b.createRepresentationFor(a,
function(b){a._itemDisplay=b;b=b.getElement();b.addClass("contents");a._content=b;a._empty();b.grab(c.createModifyableIndicator("replaceImage",a.options.displaySize));a.element.grab(b);a._displayLoading(!1)})},_empty:function(){this.element.empty();this._formFieldIsInside&&this.element.grab(this.options.formField)},_displayLoading:function(b){var a=this.element,c=this;if(b){a.pinDimensions();this.element.toggleClass("mediaItemProcessing",b);var d=this._overlay();this.element.grab(d)}else{d=function(){c._overlay().dispose();
a.unpinDimensions();c.element.toggleClass("mediaItemProcessing",b)};var e=this._itemDisplay;e&&e.whenReady?e.whenReady(d):d()}},_overlay:function(){return this._overlayEl=this._overlayEl||new Element("div.loadingOverlay"),this._overlayEl},_updateFormField:function(){if(this.options.formField){var b=this.mediaItem?this.mediaItem.getID():"";this.options.formField.set("value",b);this.options.formField.fireEvent("input");this.fireEvent("fieldUpdated")}},attachItem:function(b,a){a=a||function(){};var c=
this.options.customAttach;if(c)c.apply(this,[b,a]);else{if(b&&!1===b.data.filter_state())return a(b,!1,this.getErrorMessage(b));b=this._immediatelyAttach(b);a&&a(b,!0)}},_immediatelyAttach:function(b){var a=this._setItem(b);return this._isDirty=!0,this._displayItem(b),a},getFormField:function(){return this.options.formField},isDirty:function(){return this._isDirty},getMenuItems:function(b){var a={detach:Auth.isLoggedIn()};return this.options.menuHide.split(" ").each(function(b){a[b]=!1}),a},getMediaFilterName:function(){return this.options.accepts},
_setItem:function(b){var a=null;return this.mediaItem&&(this.mediaItem.removeEvents(this._mediaItemEventHandlers),this.mediaItem.setContext(),a=this.mediaItem),b&&(b.addEvents(this._mediaItemEventHandlers),b.setContext(this)),this.mediaItem=b,this.fireEvent("itemChanged",[b,a]),a},destroy:function(){this.element.destroy()},getMediaItem:function(){return this.mediaItem}});Object.append(c,{registerAllTargets:function(){return $$(".mediaTarget").filter(function(b){return!b.hasClass("customSetup")}).map(function(b){return c.createFromElement(b)})},
createFromElement:function(b,a){b=new c(b,a);return b.addEvent("browse",c._initiateBrowsing),b},createModifyableIndicator:function(b,a){b=new Element("div",{class:"alterTarget "+a+" "+b});a=new Element("div.icon");return b.grab(a),b},_initiateBrowsing:function(){MediaManager.browse(this)}})},255:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});f.TextMediaTarget=window.TextMediaTarget=new Class({name:"TextMediaTarget",Extends:MediaTarget,initialize:function(c,b){this.parent(c,b);this._initializeUI(c)},
_initializeUI:function(c){this.addEvent("browse",MediaTarget._initiateBrowsing)},_displayItem:function(c){var b=Utils.createElements,a=this,g=b({tag:"div",c:"row attachment-container"});if(!c){a._empty();var d=b({tag:"a",c:"viewLink add-document hidden",text:_js("Add New")}).addEvent("browse",function(){a.fireEvent("browse")});return g.grab(d),void a.element.grab(g)}d=c.data.document_group();var e=(c.data.document_extension(),c.data.document_type(),b({c:c.getIconClassname()}));a._empty();var k=b({tag:"div",
c:"column"}),m=b({tag:"a",href:c.data.view_url(),target:"_blank"}),f=b({tag:"p",text:c.data.title()||c.data.filename()}),h=b({tag:"a",c:"feature-doc-button button button-small button-transparent",text:_js("Feature")});c=b({tag:"a",c:"edit-doc-button button button-small button-transparent",text:_js("Edit"),href:c.data.edit_url(),target:"_blank"});var l=b({tag:"a",html:App.iconTimes,c:"removeLink delete"}).addEvent("click",function(){a.attachItem(null)});b=b({c:"remove-doc-container"});a.element.grab(g);
b.grab(l);m.grab(f);k.grab(m);g.grab(e);g.grab(k);g.grab(c);"pdf"===d&&g.grab(h);g.grab(b)}})},256:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});f.MinimalMediaTarget=window.MinimalMediaTarget=new Class({name:"MinimalMediaTarget",Implements:[Events],options:{},initialize:function(c){if(Object.append(this.options,c),!this.options.accepts)throw Error("Must provide an 'accepts' option");},attachItem:function(c,b){function a(a,d,m){d&&g.fireEvent("itemChanged",[c]);b&&b.apply(g,Array.convert(arguments))}
var g=this;if(c.isReady())if(!1!==c.data.filter_state()){var d=this.options.customAttach;d?d(c,a):a(null,!0)}else a(null,!1,"Can't place media of this type.");else a(null,!1,"Can't be placed until processing is finished")},getMediaFilterName:function(){return this.options.accepts}})},257:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});Browser.ie&&(Element.Constructors.canvas=function(a){return new c(a)});var c=f.Canvas=window.Canvas=new Class({initialize:function(){var a=Array.link(arguments,
{properties:Type.isObject,element:function(a){return null!=a}});a=Object.append({width:300,height:150},a.properties);var c=document.newElement("canvas");return c.set(a),c.getContext?c:(c.attachEvent("onpropertychange",this.changeproperty),c.attachEvent("onresize",this.resize),c.getContext=function(){return this.context=this.context||new b(c)},c.setStyles({width:a.width,height:a.height}))},changeproperty:function(a){var b=a.propertyName;"width"!=b&&"height"!=b||((a=a.srcElement).style[b]=a[b],a.getContext().clearRect())},
resize:function(a){var b=(a=a.srcElement).firstChild;b&&(b.style.width=a.width,b.style.height=a.height)}}),b=f.CanvasRenderingContext2D=window.CanvasRenderingContext2D=new Class({initialize:function(a){this.element=(new Element("div")).setStyles({width:a.clientWidth,height:a.clientHeight}).inject(a);this.m=[[1,0,0],[0,1,0],[0,0,1]];this.rot=this.l=0;this.state=[];this.path=[];this.Z=10;this.Z2=this.Z/2;this.arcScaleY=this.arcScaleX=1;this.currentY=this.currentX=0;this.miterLimit=1*this.Z},lineWidth:1,
strokeStyle:"#000",fillStyle:"#fff",globalAlpha:1,globalCompositeOperation:"source-over",lineCap:"butt",lineJoin:"miter",shadowBlur:0,shadowColor:"#000",shadowOffsetX:0,shadowOffsetY:0,getCoords:function(a,b){var c=this.m,d=this.Z,e=this.Z2;return[d*(a*c[0][0]+b*c[1][0]+c[2][0])-e,d*(a*c[0][1]+b*c[1][1]+c[2][1])-e]}});b.implement({beginPath:function(){this.l=0;this.path.length=0},moveTo:function(a,b){this.path[this.l++]="m";this.path[this.l++]=this.coord(a,b);this.currentX=a;this.currentY=b},closePath:function(){this.path[this.l++]=
"x"},lineTo:function(a,b){this.path[this.l++]="l";this.path[this.l++]=this.coord(a,b);this.currentX=a;this.currentY=b},quadraticCurveTo:function(a,b,c,g){a*=2;b*=2;this.bezierCurveTo((a+this.currentX)/3,(b+this.currentY)/3,(a+c)/3,(b+g)/3,c,g)},bezierCurveTo:function(a,b,c,g,f,h){this.path[this.l++]=" c "+[this.coord(a,b),this.coord(c,g),this.coord(f,h)].join();this.currentX=f;this.currentY=h},arcTo:Function.empty,arc:function(a,b,c,g,f,h){0===this.rot&&(c*=this.Z);var d=g.cos()*c,e=g.sin()*c,k=f.cos()*
c,m=f.sin()*c;if(0===this.rot){d!=k||h||(d+=.125);g=this.Z2;f=this.getCoords(a,b);var l=this.arcScaleX*c;c*=this.arcScaleY;this.path[this.l++]=[h?"at ":"wa ",(f[0]-l).round()+","+(f[1]-c).round()+" ",(f[0]+l).round()+","+(f[1]+c).round()+" ",this.coord(d+a-g,e+b-g)+" ",this.coord(k+a-g,m+b-g)].join("")}else{l=Math.PI;var p=l/24,q=h?-1:1;q*f<g&&(h?g+=2*l:f+=2*l);for(this.lineTo(d+a,e+b);q*g+p<f;)this.lineTo(a+(g+=q*p).cos()*c,b+g.sin()*c);this.lineTo(k+a,m+b)}},rect:function(a,b,c,g){this.moveTo(a,
b);this.lineTo(a+c,b);this.lineTo(a+c,b+g);this.lineTo(a,b+g);this.closePath()},fill:function(){this.stroke(!0)},stroke:function(a){if(this.path.length){var b=10*this.Z,c=this.fillStyle,d=Type.isString(c),g=this.processColor(a&&d?c:this.strokeStyle);d=a?["stroked\x3d",["\x3cv:fill ",d?"color\x3d"+g.color+' opacity\x3d"'+g.opacity:this.processColorObject(c),'"\x3e\x3c/v:fill\x3e']]:["strokeweight\x3d"+.8*this.lineWidth*this.m[0][0]+" filled\x3d",["\x3cv:stroke","endcap\x3d","butt"==this.lineCap?"flat":
this.lineCap,"joinstyle\x3d",this.lineJoin,"color\x3d",g.color,'opacity\x3d"',g.opacity,'" /\x3e']];this.element.insertAdjacentHTML("beforeEnd",['\x3cv:shape path\x3d"',this.path.join(""),'e" coordsize\x3d"'+b+","+b+'" ',d[0],'false"\x3e',d[1].join(" "),"\x3c/v:shape\x3e"].join(""));a&&c.img&&(this.element.getLast().fill.alignshape=!1);this.beginPath()}},clip:Function.empty,isPointInPath:Function.empty,processColor:function(a){var b=this.globalAlpha;return"rgb"==a.substr(0,3)&&("a"==a.charAt(3)&&
(b*=a.match(/([\d.]*)\)$/)[1]),a=a.rgbToHex()),{color:a,opacity:b}},processColorObject:function(a){var b="";if(a.addColorStop){var c=a.col0,d=a.col1,g="";if(a.stops)for(var f=0,h=a.stops.length;f<h;f++)g+=(100*a.stops[f][0]).round()+"% "+a.stops[f][1];b+=(a.r0?'type\x3dgradientradial focusposition\x3d"0.2,0.2" focussize\x3d"0.2,0.2"':"type\x3dgradient method\x3dlinear focus\x3d0 angle\x3d"+180*(1+a.angle/Math.PI)+" ")+['color\x3d"'+c.color,'opacity\x3d"'+100*c.opacity+"%",'color2\x3d"'+d.color,'o:opacity2\x3d"'+
100*d.opacity+"%",'colors\x3d"'+g].join('" ')}return a.img?'type\x3d"tile" src\x3d"'+a.img.src:b},coord:function(a,b){var c=this.m,d=this.Z,e=this.Z2;return(d*(a*c[0][0]+b*c[1][0]+c[2][0])-e).round()+","+(d*(a*c[0][1]+b*c[1][1]+c[2][1])-e).round()}});b.implement({clearRect:function(a,b,c,g){this.element.innerHTML="";this.m=[[1,0,0],[0,1,0],[0,0,1]]},fillRect:function(a,b,c,g){this.rect(a,b,c,g);this.fill()},strokeRect:function(a,b,c,g){this.rect(a,b,c,g);this.stroke()}});b.implement({scale:function(a,
b){this.arcScaleX*=a;this.arcScaleY*=b;this.matMult([[a,0,0],[0,b,0],[0,0,1]])},rotate:function(a){this.rot+=a;var b=a.cos();a=a.sin();this.matMult([[b,a,0],[-a,b,0],[0,0,1]])},translate:function(a,b){this.matMult([[1,0,0],[0,1,0],[a,b,1]])},transform:function(a,b,c,g,f,h){this.matMult([[a,c,f],[b,g,h],[0,0,1]])},setTransform:function(){this.m=[[1,0,0],[0,1,0],[0,0,1]];this.transform.apply(this,arguments)},matMult:function(a){for(var b=this.m,c=[[0,0,0],[0,0,0],[0,0,0]],d=3;d--;){var g=a[0][d],f=
a[1][d],h=a[2][d];g&&this.sum(c[0],this.dotmult(g,b[d]));f&&this.sum(c[1],this.dotmult(f,b[d]));h&&this.sum(c[2],this.dotmult(h,b[d]))}this.m=c},dotmult:function(a,b){return b.map(function(b){return a*b})},sum:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2]}});b.implement({drawImage:function(a){var b=arguments,c=b.length,d=9==c?4:0,g=a.runtimeStyle,f=g.width,h=g.height;g.width="auto";g.height="auto";var l=a.width,t=a.height;g.width=f;g.height=h;var n=0,C=0;g=l;f=t;var r=b[++d],w=b[++d];h=b[++d]||l;
d=b[++d]||t;9==c&&(n=b[1],C=b[2],g=b[3],f=b[4]);b=C/t;c=n/l;n=this.m;var v=this.Z;r=this.getCoords(r,w).map(function(a){return(a/v).round()});r=n[0][1]||1!=n[0][0]?["filter:progid:DXImageTransform.Microsoft.Matrix( M11\x3d",n[0][0],"M12\x3d",n[1][0],"M21\x3d",n[0][1],"M22\x3d",n[1][1],"Dx\x3d",r[0],"Dy\x3d",r[1],")"].join(" "):"top:"+r[1]+";left:"+r[0];this.element.insertAdjacentHTML("beforeEnd",['\x3cv:group style\x3d"',r,'" coordsize\x3d"',10*v,",",10*v,'"\x3e',["\x3cv:image src\x3d",a.src,"style\x3dwidth:"+
v*h+";height:"+v*d,"croptop\x3d",b,"cropright\x3d",1-c-g/l,"cropbottom\x3d",1-b-f/t,"cropleft\x3d",c,"/\x3e"].join(" "),"\x3c/v:group\x3e"].join(" "))},drawImageFromRect:Function.empty,getImageData:Function.empty,putImageData:Function.empty});b.implement({states:"strokeStyle fillStyle globalAlpha lineWidth lineCap lineJoin miterLimit shadowOffsetX shadowOffsetY shadowBlur shadowColor globalCompositeOperation".split(" "),save:function(){var a={};this.states.each(function(b){a[b]=this[b]},this);this.dStack.push(a);
this.mStack.push(this.m)},restore:function(){var a=this.dStack.pop();this.states.each(function(b){this[b]=a[b]},this);this.m=this.mStack.pop()},mStack:[],dStack:[]});b.implement({createLinearGradient:function(b,c,g,f){return new a(b,c,g,f,this)},createRadialGradient:function(b,c,g,f,h,l){return Object.append(new a(b,c,f,h,this),{r0:g,r1:l})}});var a=f.CanvasGradient=window.CanvasGradient=new Class({initialize:function(a,b,c,g,f){this.angle=((g-b)/((c-a).pow(2)+(g-b).pow(2)).sqrt()).acos();this.ctx=
f},addColorStop:function(a,b){b=this.processColor(b);1==a||0==a?this["col"+a]=b:(this.stops||(this.stops=[]),this.stops.push([a,b.color]))},processColor:function(a){var b=this.ctx.globalAlpha||1;return"rgb"==a.substr(0,3)&&("a"==a.charAt(3)&&(b*=a.match(/([\d.]*)\)$/)[1]),a=a.rgbToHex()),{color:a,opacity:b}}});b.implement({createPattern:function(a,b){return new g(a,b)}});var g=f.CanvasPattern=window.CanvasPattern=new Class({initialize:function(a,b){this.img=a;this.rep=b}})},258:function(l,f,h){Object.defineProperty(f,
"__esModule",{value:!0});onDomReady(function(){c.initialize()});var c=f.MediaManager=window.MediaManager=function(){function b(a,b,c,d,f){if("select"!==a)return!0;var e=this;return f.attachItem(d,function(a,b,c){if(!b)return c&&MediaLibrary.appendAlertMessage(c),e.transition.cancel();a&&delete g[a.getGlobalID()];d.whenReady(function(){g[d.getGlobalID()]=!0});e.transition()}),StateMachine.ASYNC}var a,g={};MediaItem.addEvent("toggleMenu",function(b,c){a.toggleForMediaItem(b,c)});var d={mediaTarget:null,
initialize:function(){MediaTarget.registerAllTargets();var b=(a=new MediaItemMenu).menuItems;Modal.addEvents({onImageMarkersLoad:function(a,b,c){ImageMarkers.initialize(a,b,c)},onImageMarkersUnload:function(){ImageMarkers.unload()}});b.addEvents({markers:function(a){Auth.required({onAuthorize:function(){Modal.open({type:"module",name:"ImageMarkers",boxClass:"mediaLibraryModalBox editPhoto",clientOptions:{mediaImage:a},serverOptions:{imageid:a.getID()}})}})},crop:function(a){Auth.required({onAuthorize:function(){var b=
a.getContext(),c=null;b==MediaLibrary?c=MediaLibrary.mediaTarget:instanceOf(b,MediaTarget)&&(c=b);ImageCrop.showForMediaItem(a,c)}})},deleted:function(a){d.detach(a)},fullsize:function(a){a=a.data.original();window.open(a)},copy:function(a){Auth.required({onAuthorize:a.copyToMediaLibrary.bind(a)})}})},detach:function(a){Auth.required({onAuthorize:function(){delete g[a.getGlobalID()];a.deleted()}})},onenterchoosing:function(a,b,d,f){"hidden"==b&&MediaLibrary.showForTarget(f,function(a){if(!a)return c.cancel();
var b=a.data.filter_state();switch(b){case "crop":c.crop(a,f);break;case !0:case !1:c.select(a,f);break;default:b&&MediaLibrary.appendAlertMessage(b.message)}},g)},oncrop:function(a,b,d,g,f){ImageCrop.showForMediaItem(g,f,function(a){a?(c.select(a,f),Modal.pop()):c.cancelCrop()})},onleavechoosing:b,onleavecropping:b,onenterhidden:function(){Modal.pop()}};return d}();StateMachine.create({target:c,initial:"hidden",events:[{name:"cancel",from:"*",to:"hidden"},{name:"cancelCrop",from:"cropping",to:"choosing"},
{name:"browse",from:"hidden",to:"choosing"},{name:"crop",from:"choosing",to:"cropping"},{name:"select",from:["choosing","cropping"],to:"hidden"}]})},259:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});f.MediaItemMenu=window.MediaItemMenu=new Class({Implements:[Options,Events],options:{tooltip:{autohide:!0,hideDelay:700,side:"top",arrowAlign:"right",arrowInset:10,nudge:-19,zIndex:1000100}},initialize:function(){this.sides={};this.items={};this.isOpen=!1;this.menuItems=new Events;this.menu=
(new Element("div.mediaItemMenu",{events:{mousedown:function(c){c.stop()}}})).adopt(this.sides.left=new Element("ul.left"),this.sides.right=new Element("ul.right"),this.sides.bottom=new Element("div.bottom.clearer"));this.tooltip=new Tooltip(null,this.options.tooltip);this.addMenuItems()},addMenuItems:function(){var c={fullsize:{side:"left",text:_js("Full Size"),icon:"iconFullsize"},deleted:{side:"right",text:_js("Delete"),icon:"iconDelete"},copy:{side:"right",text:_js("Copy"),icon:"iconCopy",hoverText:_js("Copy to Media Manager")}};
mobileDetected()||tabletDetected()||(c.markers={side:"left",text:_js("Markers..."),icon:"iconMarkers"},c.crop={side:"left",text:_js("Crop..."),icon:"iconCrop"});Object.each(c,function(b,a){this.addItem(a,b)},this)},addItem:function(c,b){var a,g=this,d=(new Element("li",{events:{mouseenter:this.hoverItem.bind(this,c),mouseleave:this.blurItem.bind(this,c),click:function(a){a.stop();this.hasClass("inactive")||(g.menuItems.fireEvent(c,[g.mediaItem]),b.onSelect&&b.onSelect(),g._close())}}})).adopt(new Element("div.icon."+
b.icon),a=new Element("a",{text:b.text,events:{click:function(a){a.preventDefault()}}}));return b.hoverText&&(d.tooltip=new Tooltip(d,{autoshow:!0,text:b.hoverText,hideDelay:0,zIndex:this.options.tooltip.zIndex+1}),d.addEvent("click",d.tooltip.hide.bind(d.tooltip))),d.inject(this.sides[b.side]),d.store("link",a),this.items[c]=d,this},disableItem:function(c){return this.items[c].addClass("inactive"),this},enableItem:function(c){return this.items[c].removeClass("inactive"),this},toggleForMediaItem:function(c,
b){if(this.tooltip.visible()&&c==this.mediaItem)this._close();else{this.tooltip.visible()&&this.tooltip.hide();this.mediaItem=c;var a=c.collectMenuOptions();Object.each(this.items,function(b,c){c=a[c];var d="string"==typeOf(c),g=b.retrieve("link");b.toggle(c);b.toggleClass("inactive",d);g.set("title",d?c:"")});this._openAtAnchor(b)}},_close:function(){return this.tooltip.hide(),this},_openAtAnchor:function(c){return c&&this.tooltip.setAnchor(c),this.tooltip.set(this.menu).show(),this},_hideItem:function(c){return this.items[c].hide(),
this},_showItem:function(c){return this.items[c].show(),this},hoverItem:function(c){c=this.items[c];c.hasClass("inactive")||c.addClass("active")},blurItem:function(c){this.items[c].removeClass("active")},selectItem:function(c,b){this.items[c].hasClass("inactive")||!1!==b()&&this.close()}})},260:function(l,f,h){function c(b,a){a=a||{};b.data;var c=a.classOverride||"mediaImage";this.size=a.size||"standard";this.displayType=a.useBackground?"background":"img";this.mediaItem=b;c=this.container=new Element("div.mediaItem."+
c+'[data-imageid\x3d"'+b.getID()+'"]');if(!1!==a.menu&&c.adopt(MediaItem.createMenuControl(b)),a.showFilename){a=new Element("span.file-container");var d=new Element("div.filetypeContainer");this.filename=new Element("p.filename");this.filetype=new Element("div.filetype");var e=new Element("i.fileicon.fa.fa-picture-o");this._updateFilename();a.grab(this.filename);c.grab(d);c.grab(a);c.grab(this.filetype);c.grab(e)}c.addEvent("click",this.fireEvent.pass(["select",b],this));this.container.store("mediaItem",
b);b.addEvents({dataChanged:this._updateDisplay.bind(this),loadingChanged:this._updateLoading.bind(this),deleted:this.dispose.bind(this)});b.isReady()?this._updateDisplay():this._updateLoading(!0)}Object.defineProperty(f,"__esModule",{value:!0});l=f.MediaItemImage=window.MediaItemImage=new Class({Extends:MediaItem,hasMarkers:function(){var b=this.data.markup();return b&&b.draw},hasCrop:function(){var b=this.data.markup();return b&&b.crop},cropMarkupString:function(){return this.hasCrop()?this.data.markup_string().split(";")[1]:
""},markersString:function(){var b=this.data.markup_string();return this.hasCrop()?b.split(";").slice(2).join(";"):b},_getMenuOptions:function(){var b=this.data.filter_state(),a=!0;return this.getContext()===MediaLibrary&&"object"==typeOf(b)&&(a=b&&b.message),{markers:!0,crop:a,fullsize:!0}},createRepresentationFor:function(b,a){var g=b.options.displaySize,d=this;d.whenReady(function(){var b=new c(d,{size:g,useBackground:!1});b.whenReady(function(){a(b)})})},createDisplay:function(b,a){return new c(this,
{size:this.getLargestImageSize(b),useBackground:!1,showFilename:a})},getSrc:function(b){return this.data[b]()},getUncroppedPreview:function(b){return this.data.markup_string()?window.shared_constants.GuideURI("PREVIEW_IMAGE")+"/"+this.data.srcid()+"/"+this.markersString()+"/"+b:this.getSrc(b)},getID:function(){return this.data.imageid()},getEncoding:function(){return this.data.encoding()},getType:function(){return this.data.type()},getFilter:function(){return"onlyImages"},toWikiText:function(){return void 0!==
App.wikiTitle?"[image|"+this.getID()+"|align\x3dleft]":"[image|"+this.getID()+"]"},getGlobalID:function(){return"image:"+this.getID()}});MediaItem.registerType("GuideImage",l);MediaItem.registerType("CartImage",l);f.MediaItemImageDisplay=c;window.MediaItemImageDisplay=c;Object.append(c.prototype,{getElement:function(){return this.container},whenReady:function(b){return this._elementPromise?this._elementPromise.getValue(b):(b&&b(),!0)},_updateDisplay:function(){var b=this,a=this.mediaItem.getSrc(b.size),
c=this._elementPromise=new Future;new Asset.image(a,{onLoad:function(){if("background"==b.displayType){var d=b._displayElement=new Element("div.contents."+b.size);d.setStyle("backgroundImage","url("+a+")");b.container.grab(d)}else(d=b._displayElement)||(d=b._displayElement=new Element("img."+b.size),b.container.grab(d)),d.set("src",a);b._updateFilename();(function(){c.resolve(a)}).delay(10)}})},_updateFilename:function(){if(this.filename){var b=this.mediaItem,a=b.data.filename();a&&(this.filename.setProperties({text:a.substr(0,
a.lastIndexOf(".")),title:b.data.filename()}),this.filetype.setProperties({text:a.substr(a.lastIndexOf(".")+1).toUpperCase()}),this.filename.toggle(b.data.filename()))}},_updateLoading:function(b){var a=this._overlay();b?this.container.grab(a):this.whenReady(function(){a.dispose()});this._updateFilename()},dispose:function(){this.container.dispose();this.filename&&this.filename.dispose();this.removeEvents()},_overlay:function(){return this._overlayEl=this._overlayEl||new Element("div.loadingOverlay"),
this._overlayEl},inject:function(b,a){return this.container.inject(b,a||"after")},hide:function(){return this.container.hide()},show:function(){return this.container.show()}});Object.append(c.prototype,Utils.EventsFunctions)},261:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});l=f.MediaItemDocument=window.MediaItemDocument=new Class({Extends:MediaItem,_getMenuOptions:function(){return{}},createRepresentationFor:function(c,b){var a=c.options.displaySize,g=this;g.whenReady(function(){var c=
g.createDisplay(a,!1);c.whenReady(function(){b(c)})})},createDisplay:function(c,b){return c=this.getLargestImageSize(c),new MediaItemImageDisplay(this,{size:c,useBackground:!0,showFilename:b,classOverride:"mediaDocument"})},getID:function(){return this.data.documentid()},getFilename:function(){return this.data.filename()},getTitle:function(){return this.data.title()},getType:function(){return this.data.type()},getFilter:function(){return"onlyDocuments"},getSrc:function(c){return this.data[c]()},getViewUrl:function(){return this.data.view_url()},
getIconClassname:function(){var c=this.data.document_type(),b="fa-file-o";return["pdf","word","excel","powerpoint"].includes(c)&&(b="fa-file-"+c+"-o"),"pdf-document attachment-icon fa "+b+" fa-2x officeDocumentIcon document-icon-"+c},toWikiText:function(){return"[document|"+this.getID()+"]"},getGlobalID:function(){return"document:"+this.getID()}});MediaItem.registerType("Document",l)},262:function(l,f,h){function c(a,b){b=b||{};a.data;this.size=b.size;this.mediaItem=a;this._elementPromise=new Future;
this._small=!MediaItem.isSizeAsBigAs(b.size,"medium");var c=this.container=new Element("div.mediaItem.mediaObject");if(c.adopt(MediaItem.createMenuControl(a)),this._small&&c.addEvent("click",this.fireEvent.pass(["select",a],this)),b.showFilename){b=new Element("span.file-container");var e=new Element("div.filetypeContainer");this.filename=new Element("p.filename");this.filetype=new Element("div.filetype");var g=new Element("i.fileicon.fa.fa-video-camera");this._updateFilename();b.grab(this.filename);
c.grab(e);c.grab(b);c.grab(this.filetype);c.grab(g)}this.container.store("mediaItem",a);a.addEvents({dataChanged:this._updateDisplay.bind(this),loadingChanged:this._updateLoading.bind(this),deleted:this.dispose.bind(this)});a.isReady()?this._updateDisplay():this._updateLoading(!0)}Object.defineProperty(f,"__esModule",{value:!0});var b=f.VideoEncodings=window.VideoEncodings=App.videoEncodings;l=f.MediaItemVideo=window.MediaItemVideo=new Class({Extends:MediaItemImage,_getMenuOptions:function(){return{}},
createRepresentationFor:function(a,b){var c=a.options.displaySize,e=this;e.whenReady(function(){var a=e.createDisplay(c,!1);a.whenReady(function(){b(a)})})},createDisplay:function(a,b){return"thumbnail"==(a=this.getLargestImageSize(a)||"standard")?new MediaItemImageDisplay(this,{size:a,useBackground:!0,showFilename:b,classOverride:"mediaVideo"}):new c(this,{size:a,showFilename:b})},getID:function(){return this.data.objectid()},getType:function(){return this.data.type()},getFilter:function(){return"onlyObjects"},
toWikiText:function(){return"[video|"+this.data.videoid()+"]"},getGlobalID:function(){return"video:"+this.getID()}});MediaItem.registerType("GuideVideoObject",l);f.MediaItemVideoDisplay=c;window.MediaItemVideoDisplay=c;Object.append(c.prototype,MediaItemImageDisplay.prototype);Object.append(c.prototype,{_updateDisplay:function(){if(this._small)this._updateImageDisplay();else{this.mediaItem;var a=this,b=Utils.createElements({tag:"video",c:"video-js vjs-default-skin",children:this._createSourceElements()});
a._elementPromise&&!a._video||(a._elementPromise=new Future);a.container.grab(b);videojs(b,{controls:!0,autoplay:!1,preload:"auto"},function(){a._elementPromise.resolve(b)});a._video=b}},_createSourceElements:function(){var a=this.mediaItem.data.video_urls(),c=Utils.createElements,d=[];return Object.each(a,function(a,g){g=b[g.toUpperCase()];d.push(c({tag:"source",src:a,codecs:g.codecs,type:g.mime}))}),d},_updateImageDisplay:function(){var a=this,b=this.mediaItem.getSrc(a.size);a._elementPromise&&
!a._displayElement||(a._elementPromise=new Future);var c=a._displayElement;c||(c=a._displayElement=new Element("img."+a.size),a.container.grab(c));c.set("src",b);(function(){a._elementPromise.resolve(b)}).delay(10)},_updateLoading:function(a){}})},263:function(l,f,h){function c(b,a){a=a||{};b.data;this.size=a.size;this.mediaItem=b;this._elementPromise=new Future;this._small=!MediaItem.isSizeAsBigAs(a.size,"medium");var c=this.container=new Element("div.mediaItem.mediaObject");if(c.adopt(MediaItem.createMenuControl(b)),
this._small&&c.addEvent("click",this.fireEvent.pass(["select",b],this)),c.store("mediaItem",b),a.showFilename){a=new Element("span.file-container");var d=new Element("div.filetypeContainer");this.filename=new Element("p.filename");this.filetype=new Element("div.filetype");var e=new Element("i.fileicon.fa.fa-youtube-play");this._updateFilename();a.grab(this.filename);c.grab(d);c.grab(a);c.grab(this.filetype);c.grab(e)}b.addEvents({dataChanged:this._updateDisplay.bind(this),loadingChanged:this._updateLoading.bind(this),
deleted:this.dispose.bind(this)});b.isReady()?this._updateDisplay():this._updateLoading(!0)}Object.defineProperty(f,"__esModule",{value:!0});l=f.MediaItemEmbed=window.MediaItemEmbed=new Class({Extends:MediaItem,_getMenuOptions:function(){return{}},createRepresentationFor:function(b,a){var c=b.options.displaySize,d=this;d.whenReady(function(){var b=d.createDisplay(c,!1);a(b)})},createDisplay:function(b,a){return new c(this,{size:this.getLargestImageSize(b)||"standard",showFilename:a})},getID:function(){return this.data.objectid()},
getSrc:function(b){return this.data[b]()},getType:function(){return this.data.type()},getFilter:function(){return"onlyObjects"},toWikiText:function(){return"[embed|"+this.data.view_url()+"]"},getGlobalID:function(){return"embed:"+this.getID()}});MediaItem.registerType("GuideEmbedObject",l);f.MediaItemEmbedDisplay=c;window.MediaItemEmbedDisplay=c;Object.append(c.prototype,{getElement:function(){return this.container},whenReady:function(b){return this._elementPromise?this._elementPromise.getValue(b):
(b&&b(),!0)},_updateDisplay:function(){this.size=this.mediaItem.getLargestImageSize(this.size);this._small?this._updateImageDisplay():this.container.appendHTML(this.mediaItem.data.html())},_updateImageDisplay:function(){var b=this,a=this.mediaItem.getSrc(b.size);b._elementPromise&&!b._displayElement||(b._elementPromise=new Future);var c=b._displayElement;c||(c=b._displayElement=new Element("img."+b.size),b.container.grab(c));c.set("src",a);(function(){b._elementPromise.resolve(a)}).delay(10)},_updateFilename:function(){if(this.filename){var b=
this.mediaItem.data.filename();this.filename.setProperties({text:b,title:b});this.filetype.setProperties({text:this.mediaItem.data.provider().toUpperCase()});this.filename.toggle(b)}},_updateLoading:function(b){var a=this._overlay();b?this.container.grab(a):this.whenReady(function(){a.dispose()})},dispose:function(){this.container.dispose();this.removeEvents()},_overlay:function(){return this._overlayEl=this._overlayEl||new Element("div.loadingOverlay"),this._overlayEl},inject:function(b,a){return this.container.inject(b,
a||"after")},hide:function(){return this.container.hide()},show:function(){return this.container.show()}});Object.append(c.prototype,Utils.EventsFunctions)},487:function(l,f,h){Object.defineProperty(f,"__esModule",{value:!0});f.UserFinder=window.UserFinder=new Class({Extends:Autocompleter.Request.API_2_0,el:null,initialize:function(c,b){App.noAvatarUrl||console.error("App.noAvatarUrl is not set.");b=Object.merge({className:"blurb-finder",fxOptions:null,maxChoices:5,delay:100,truncateText:!1,overflow:!1,
showReputation:!0,injectChoice:this.injectChoice.bind(this)},b);this.el=c;this.parent(this.el,"users/search",b);this.url=this.request.request.options.url;this.choices.addEvent("mousedown",function(a){a.stop()})},query:function(){this.toggleIndicator(!0);var c=Object.clone(this.options.getData)||{};this.request.request.options.url=this.url+"/"+this.queryValue;this.fireEvent("onRequest",[this.element,this.request,c,this.queryValue]);this.request.send({data:c})},injectChoice:function(c){if(this.el.isDisplayed()){var b=
{user:c,userImage:c.image&&c.image.mini?c.image.mini:App.noAvatarUrl,showImage:!0,reputationTitle:_js("Reputation"),blurbId:"user-"+c.type+"-"+c.id,showReputation:this.showReputation};b=window.hbsTemplates("USER_HBS")(b);b.store("user",c);b.inputValue="";this.addChoiceEvents(b).inject(this.choices)}}})}},[[1757,0,1]]]);
